<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DBPhone Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary-bg: #eef2f6; --card-bg: #ffffff; --accent-color: #4e73df; --accent-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%); }
        body { background-color: var(--primary-bg); font-family: 'Noto Sans KR', sans-serif; color: #2e384d; }
        .glass-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: none; overflow: hidden; margin-bottom: 20px; }
        #login-view { height: 100vh; background: var(--accent-gradient); display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .custom-navbar { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); padding: 10px 15px; }
        .nav-link { color: #555; font-weight: 600; cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: var(--accent-color); }
        .dropdown-item { padding: 10px 20px; font-weight: 500; }
        .dropdown-item:active { background-color: var(--accent-color); }
        .scan-wrapper { background: #2d3436; border-radius: 16px; padding: 24px; text-align: center; color: white; box-shadow: 0 10px 30px rgba(45, 52, 54, 0.3); }
        .scan-input { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: #00ff9d; text-align: center; font-size: 1.3rem; font-weight: 700; }
        .scan-input:focus { background: rgba(255, 255, 255, 0.15); border-color: #00ff9d; box-shadow: 0 0 15px rgba(0, 255, 157, 0.2); color: #00ff9d; }
        .section-view { display: none; }
        .active-section { display: block; animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stock-table th { background-color: #f8f9fa; color: #6c757d; font-weight: 600; font-size: 0.85rem; text-align: center; white-space: nowrap; }
        .stock-table td { font-size: 0.9rem; vertical-align: middle; text-align: center; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="glass-card p-5 text-center" style="width: 90%; max-width: 400px;">
            <h3 class="fw-bold mb-4 text-primary"><i class="bi bi-phone-vibrate"></i> DBPhone ERP</h3>
            <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large"></div>
            <div id="login-msg" class="text-danger mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <nav class="navbar navbar-expand-lg bg-white custom-navbar sticky-top shadow-sm">
            <div class="container-fluid px-0">
                <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-grid-fill me-2"></i>ëŒ€ë°•í†µì‹ </a>
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown me-2">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">ğŸ“¦ ì¬ê³  ê´€ë¦¬</a>
                            <ul class="dropdown-menu border-0 shadow-lg">
                                <li><a class="dropdown-item" onclick="showSection('section-in')">ì…ê³  ë“±ë¡</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-move')">ì¬ê³  ì´ë™</a></li>
                                <li><a class="dropdown-item text-danger" onclick="showSection('section-out')">ë°˜í’ˆ ì²˜ë¦¬</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="showSection('section-stock')">ğŸ” ì¬ê³  ì¡°íšŒ (ë³´ìœ ë¶„)</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-history')">ğŸ“œ ì´ë ¥ ì¡°íšŒ (ë¡œê·¸)</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary fw-bold" href="#" role="button" data-bs-toggle="dropdown">âœ… ê°œí†µ ì²˜ë¦¬</a>
                            <ul class="dropdown-menu border-0 shadow-lg">
                                <li><a class="dropdown-item" onclick="showOpenSection('ë¬´ì„ ê°œí†µ')">ğŸ“± ë¬´ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showOpenSection('ìœ ì„ ê°œí†µ')">ğŸ“º ìœ ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showOpenSection('ì¤‘ê³ ê°œí†µ')">â™»ï¸ ì¤‘ê³  ê°œí†µ</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item me-3"><a class="nav-link" onclick="showSection('section-vendor')"><i class="bi bi-buildings"></i> ê±°ë˜ì²˜ ê´€ë¦¬</a></li>
                        <li class="nav-item d-flex align-items-center bg-light rounded-pill px-3 py-1 mt-2 mt-lg-0">
                            <span class="small text-muted me-2"><i class="bi bi-person-circle text-primary"></i> <strong id="user-name">...</strong>ë‹˜</span>
                            <button onclick="logout()" class="btn btn-sm text-danger p-0 border-0"><i class="bi bi-box-arrow-right"></i></button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-4">
            
            <div id="section-in" class="section-view active-section fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3 text-primary">ì…ê³  ë“±ë¡</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><label class="small text-muted fw-bold">ê±°ë˜ì²˜</label><select class="form-select fw-bold" id="in_supplier"></select></div>
                        <div class="col-6"><label class="small text-muted fw-bold">ì§€ì </label><select class="form-select fw-bold" id="in_branch"><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="small text-muted">ìŠ¤ìº” ëª¨ë“œ</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="in_mode_toggle" onchange="toggleInMode()">
                            <label class="form-check-label small fw-bold text-muted" for="in_mode_toggle" id="in_mode_label">ì¼ë°˜</label>
                        </div>
                    </div>
                    <div class="scan-wrapper mb-3"><input type="text" class="form-control scan-input" id="in_scan" placeholder="ë°”ì½”ë“œ ìŠ¤ìº”" onkeydown="handleInScan(event)" autocomplete="off"></div>
                    <div id="in-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                    <div id="in_batch_area" style="display:none;">
                        <div class="bg-light rounded-3 p-3 border">
                            <div class="d-flex justify-content-between mb-2"><h6 class="fw-bold">ëŒ€ê¸° ëª©ë¡ <span class="badge bg-primary rounded-pill" id="in_count">0</span></h6><button class="btn btn-sm text-danger fw-bold" onclick="clearInList()">ë¹„ìš°ê¸°</button></div>
                            <div style="max-height: 200px; overflow-y: auto;"><table class="table table-sm table-borderless small align-middle"><tbody id="in_tbody"></tbody></table></div>
                            <button class="btn btn-primary w-100 rounded-3 mt-2 fw-bold" id="btn_in_submit" onclick="submitInBatch()" disabled>ì…ê³  í™•ì •</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-open" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-primary">
                    <h5 class="fw-bold mb-4 text-primary" id="open_title">ê°œí†µ ì²˜ë¦¬</h5>
                    <div id="open_step_1">
                        <div class="scan-wrapper bg-primary bg-opacity-75 mb-3" style="background-color: #0984e3;"><input type="text" class="form-control scan-input border-primary" id="open_scan" placeholder="ê°œí†µí•  ê¸°ê¸° ìŠ¤ìº”" onkeydown="handleOpenScan(event)" autocomplete="off"></div>
                    </div>
                    <div id="open_step_2" style="display:none;" class="fade-in">
                        <div class="alert alert-info py-2 small fw-bold mb-3"><i class="bi bi-check-circle"></i> <span id="open_target_info"></span></div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="small text-muted">ê³ ê°ëª…</label><input type="text" class="form-control" id="open_cust_name" placeholder="í™ê¸¸ë™"></div>
                            <div class="col-6"><label class="small text-muted">ìƒë…„ì›”ì¼</label><input type="text" class="form-control" id="open_cust_birth" placeholder="900101"></div>
                            <div class="col-12"><label class="small text-muted">ì—°ë½ì²˜</label><input type="text" class="form-control" id="open_cust_phone" placeholder="010-1234-5678"></div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6"><label class="small text-muted">ìš”ê¸ˆì œ</label><input type="text" class="form-control" id="open_plan" placeholder="5GX í”„ë¼ì„"></div>
                            <div class="col-6"><label class="small text-muted">ì•½ì •ìœ í˜•</label><select class="form-select" id="open_contract_type"><option value="ê³µì‹œì§€ì›">ê³µì‹œì§€ì›</option><option value="ì„ íƒì•½ì •">ì„ íƒì•½ì •</option></select></div>
                        </div>
                        <div class="mb-3"><label class="small text-muted">ë¶€ê°€ì„œë¹„ìŠ¤</label><input type="text" class="form-control" id="open_addon" placeholder="ìš°ì£¼íŒ¨ìŠ¤, ë³´í—˜ ë“±"></div>
                        <div class="row g-2 mb-4">
                            <div class="col-6"><label class="small text-muted">ìœ ì‹¬ë¹„</label><select class="form-select" id="open_usim"><option value="í›„ë‚©">í›„ë‚©</option><option value="ì„ ë‚©">ì„ ë‚©</option><option value="ë©´ì œ">ë©´ì œ</option></select></div>
                            <div class="col-6"><label class="small text-muted">ë¹„ê³ </label><input type="text" class="form-control" id="open_note" placeholder="íŠ¹ì´ì‚¬í•­"></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-secondary w-25" onclick="resetOpenForm()">ì·¨ì†Œ</button>
                            <button class="btn btn-primary w-75 fw-bold" onclick="submitOpenContract()">ê°œí†µ í™•ì •</button>
                        </div>
                    </div>
                    <div id="open-msg" class="alert py-2 text-center small fw-bold rounded-3 mt-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-stock" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-search"></i> ì¬ê³  ì¡°íšŒ (ë³´ìœ ë¶„)</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4">
                            <select class="form-select fw-bold" id="search_criteria" onchange="updateSearchUI()">
                                <option value="supplier">ê±°ë˜ì²˜ë³„</option>
                                <option value="branch">ì§€ì ë³„</option>
                                <option value="model">ëª¨ë¸ë³„</option>
                                <option value="serial">ì¼ë ¨ë²ˆí˜¸/ë°”ì½”ë“œ</option>
                            </select>
                        </div>
                        <div class="col-8" id="search_input_area"><select class="form-select" id="search_value_supplier"></select></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-3 mb-3" onclick="searchStock()">ì¡°íšŒí•˜ê¸°</button>
                    <div id="stock_result"></div>
                </div>
            </div>

            <div id="section-history" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> ì´ë ¥ ì¡°íšŒ (ë¡œê·¸)</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="hist_keyword" placeholder="ì¼ë ¨ë²ˆí˜¸ ë˜ëŠ” ë°”ì½”ë“œ (ì •í™•íˆ ì…ë ¥)" onkeydown="if(event.key==='Enter') searchHistory()">
                        <button class="btn btn-outline-secondary" onclick="searchHistory()">ê²€ìƒ‰</button>
                    </div>
                    <div id="hist_result"></div>
                </div>
            </div>

            <div id="section-move" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">ì¬ê³  ì´ë™</h5>
                    <select class="form-select bg-light fw-bold py-3 mb-3" id="move_to_branch"><option value="ëª…ì¼ ì§ì˜ì ">ğŸ‘‰ ëª…ì¼ ì§ì˜ì ìœ¼ë¡œ ë³´ëƒ„</option><option value="ì¥ì§€ ë³¸ì ">ğŸ‘‰ ì¥ì§€ ë³¸ì ìœ¼ë¡œ ë³´ëƒ„</option></select>
                    <div class="scan-wrapper my-4"><input type="text" class="form-control scan-input" id="move_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleMoveScan(event)" autocomplete="off"></div>
                    <div id="move-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-out" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-danger">
                    <h5 class="fw-bold mb-4 text-danger">ë°˜í’ˆ ì²˜ë¦¬</h5>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="out_note" placeholder="ì‚¬ìœ "><label>ë°˜í’ˆ ì‚¬ìœ  / ë©”ëª¨ (í•„ìˆ˜)</label></div>
                    <div class="scan-wrapper bg-danger bg-opacity-75 my-4" style="background-color: #d63031;"><input type="text" class="form-control scan-input border-danger" id="out_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleOutScan(event)" autocomplete="off"></div>
                    <div id="out-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-vendor" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3">ê±°ë˜ì²˜ ë“±ë¡</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_name" placeholder="ê±°ë˜ì²˜ëª… (í•„ìˆ˜)"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_sales" placeholder="ì˜ì—…ì‚¬ì›"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_phone" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_office" placeholder="ê°œí†µì‹¤ ì „í™”ë²ˆí˜¸"></div>
                    </div>
                    <button class="btn btn-secondary w-100 fw-bold rounded-3" onclick="addVendor()">ë“±ë¡í•˜ê¸°</button>
                </div>
                <div class="glass-card p-0">
                    <div class="p-3 border-bottom bg-light"><h6 class="mb-0 fw-bold">ë“±ë¡ëœ ê±°ë˜ì²˜</h6></div>
                    <div id="vendor_list_ui" class="list-group list-group-flush"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="vendorEditModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ê±°ë˜ì²˜ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit_v_old_name">
                    <div class="mb-2"><label class="small text-muted">ê±°ë˜ì²˜ëª…</label><input type="text" class="form-control" id="edit_v_name"></div>
                    <div class="row g-2 mb-2"><div class="col-6"><label class="small text-muted">ì˜ì—…ì‚¬ì›</label><input type="text" class="form-control" id="edit_v_sales"></div><div class="col-6"><label class="small text-muted">ì—°ë½ì²˜</label><input type="text" class="form-control" id="edit_v_phone"></div></div>
                    <div class="mb-2"><label class="small text-muted">ê°œí†µì‹¤</label><input type="text" class="form-control" id="edit_v_office"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="submitEditVendor()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];
        let globalVendorList = [];
        let globalModelList = [];
        let currentOpenType = "";
        let logoutTimer;
        let tempOpenStockData = null;

        window.onload = function() {
            const saved = sessionStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
                document.getElementById('user-name').innerText = currentUser;
                loadInitData();
                setupAutoLogout();
            }
            document.querySelectorAll('.enter-trigger').forEach(input => {
                input.addEventListener('keydown', function(e) { if(e.key === 'Enter') addVendor(); });
            });
        };

        function setupAutoLogout() {
            resetLogoutTimer();
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, resetLogoutTimer);
            });
        }

        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if(currentUser) {
                logoutTimer = setTimeout(() => {
                    alert("10ë¶„ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìë™ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    logout();
                }, 600000); 
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section', 'fade-in'));
            document.getElementById(id).classList.add('active-section', 'fade-in');
            if(id === 'section-in') loadInitData();
            if(id === 'section-vendor') loadVendorsToList();
            if(id === 'section-stock') updateSearchUI();
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        function showOpenSection(type) {
            currentOpenType = type;
            document.getElementById('open_title').innerText = type + " ì²˜ë¦¬";
            resetOpenForm();
            showSection('section-open');
        }

        function loadInitData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => {
                globalVendorList = d.list.map(v => v.name);
                const sel = document.getElementById('in_supplier'); sel.innerHTML = "";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                if(document.getElementById('search_criteria').value === 'supplier') updateSearchUI();
            });
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_models" }) }).then(r => r.json()).then(d => globalModelList = d.list);
        }

        function updateSearchUI() {
            const criteria = document.getElementById('search_criteria').value;
            const area = document.getElementById('search_input_area');
            area.innerHTML = "";
            if(criteria === 'supplier') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'branch') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                ["ì¥ì§€ ë³¸ì ", "ëª…ì¼ ì§ì˜ì "].forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'model') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalModelList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else {
                const inp = document.createElement('input'); inp.className = "form-control"; inp.id = "search_value"; inp.placeholder = "ì…ë ¥í•˜ì„¸ìš”";
                inp.onkeydown = function(e){ if(e.key==='Enter') searchStock(); };
                area.appendChild(inp); inp.focus();
            }
        }

        function searchStock() {
            const crit = document.getElementById('search_criteria').value;
            const val = document.getElementById('search_value').value;
            const div = document.getElementById('stock_result');
            div.innerHTML = `<div class="text-center py-4"><span class="spinner-border text-primary"></span></div>`;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_stock", criteria: crit, keyword: val }) })
            .then(r => r.json()).then(d => {
                if(!d.list || d.list.length === 0) { div.innerHTML = `<div class="text-center text-muted py-5">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                let html = `<div class="table-responsive"><table class="table table-hover stock-table"><thead><tr><th>ì…ê³ ì¼</th><th>ëª¨ë¸</th><th>ìƒ‰ìƒ</th><th>ì¼ë ¨ë²ˆí˜¸</th><th>ìƒíƒœ</th><th>ìœ„ì¹˜</th></tr></thead><tbody>`;
                d.list.forEach(item => {
                    let st = item.status === 'ë³´ìœ ' ? 'text-success' : 'text-danger';
                    html += `<tr><td>${item.date}</td><td class="fw-bold">${item.model}</td><td>${item.color}</td><td class="font-monospace">${item.serial}</td><td class="${st} fw-bold">${item.status}</td><td>${item.branch}</td></tr>`;
                });
                html += `</tbody></table></div><div class="text-end small text-muted">ì´ ${d.list.length}ê±´</div>`;
                div.innerHTML = html;
            });
        }

        function searchHistory() {
            const key = document.getElementById('hist_keyword').value;
            const resArea = document.getElementById('hist_result');
            resArea.innerHTML = `<div class="text-center py-3"><span class="spinner-border text-primary"></span></div>`;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_history", keyword: key }) })
            .then(r => r.json()).then(d => {
                if(!d.list.length) { resArea.innerHTML = `<div class="text-center text-muted py-3">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                let html = ""; 
                d.list.forEach(item => { 
                    let badgeColor = 'bg-secondary';
                    if(item.type === 'ì…ê³ ') badgeColor = 'bg-primary';
                    if(item.type === 'ì¬ê³ ì´ë™') badgeColor = 'bg-info';
                    if(item.type === 'ë°˜í’ˆì²˜ë¦¬') badgeColor = 'bg-danger';
                    if(item.type.includes('ê°œí†µ')) badgeColor = 'bg-success';
                    html += `<div class="glass-card p-3 mb-2"><div class="d-flex justify-content-between mb-1"><span class="badge ${badgeColor}">${item.type}</span><small class="text-muted">${item.time}</small></div><h6 class="fw-bold mb-1">${item.model}</h6><p class="mb-1 small text-secondary">${item.desc}</p><div class="small text-muted bg-light rounded p-1 d-inline-block"><i class="bi bi-upc"></i> ${item.serial} | <i class="bi bi-person"></i> ${item.user}</div></div>`; 
                });
                resArea.innerHTML = html;
            });
        }

        // --- ì…ê³  ---
        function toggleInMode() { const isBatch = document.getElementById('in_mode_toggle').checked; document.getElementById('in_mode_label').innerText = isBatch ? "ì—°ì† (ëŒ€ê¸°ì—´)" : "ì¼ë°˜ (ì¦‰ì‹œ)"; document.getElementById('in_mode_label').classList.toggle("text-primary", isBatch); document.getElementById('in_batch_area').style.display = isBatch ? 'block' : 'none'; document.getElementById('in_scan').focus(); }
        function handleInScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim(); if(!barcode) return;
            if(inPendingList.some(item => item.barcode === barcode)) { showMsg('in-msg', 'error', 'ğŸš« ì´ë¯¸ ëŒ€ê¸°ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.'); e.target.value = ""; return; }
            const isBatch = document.getElementById('in_mode_toggle').checked;
            e.target.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: isBatch?"scan_preview":"register_single", barcode: barcode, supplier: document.getElementById('in_supplier').value, branch: document.getElementById('in_branch').value, user: currentUser })})
            .then(r => r.json()).then(d => {
                if(d.status==='success') { 
                    if(isBatch) { inPendingList.push({...d.data, supplier:document.getElementById('in_supplier').value}); renderInList(); showMsg('in-msg','success',`ì¶”ê°€: ${d.data.model} (${d.data.color})`); } 
                    else showMsg('in-msg','success',`âœ… ì…ê³ ì™„ë£Œ: ${d.data.model} (${d.data.color})`); 
                } else showMsg('in-msg','error',d.message);
            }).finally(() => { e.target.disabled=false; e.target.value=""; e.target.focus(); });
        }
        function renderInList() { const t=document.getElementById('in_tbody'); t.innerHTML=""; inPendingList.forEach((i,x)=>t.innerHTML+=`<tr><td class="fw-bold">${i.model} (${i.color})</td><td class="font-monospace text-muted">${i.serial}</td><td><button class="btn btn-sm text-danger" onclick="removeInItem(${x})">X</button></td></tr>`); document.getElementById('in_count').innerText=inPendingList.length; document.getElementById('btn_in_submit').disabled=inPendingList.length===0; }
        function removeInItem(x) { inPendingList.splice(x,1); renderInList(); }
        function clearInList() { inPendingList=[]; renderInList(); }
        function submitInBatch() { if(!confirm(`${inPendingList.length}ëŒ€ ì…ê³ ?`)) return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"batch_register",items:inPendingList,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{ if(d.status==='success') {showMsg('in-msg','success',`${d.count}ëŒ€ ì™„ë£Œ`); clearInList();} else showMsg('in-msg','error',d.message); }); }

        function handleMoveScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); e.target.disabled=true; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"transfer_stock",input:v,toBranch:document.getElementById('move_to_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('move-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.disabled=false;e.target.value="";e.target.focus();}); }
        function handleOutScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(!document.getElementById('out_note').value){alert("ì‚¬ìœ í•„ìˆ˜");return;} e.target.disabled=true; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"return_stock",input:v,note:document.getElementById('out_note').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('out-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.disabled=false;e.target.value="";e.target.focus();}); }
        
        // --- â˜… ê°œí†µ ì²˜ë¦¬ ë¡œì§ ---
        function handleOpenScan(e) { 
            if(e.key!=='Enter')return; 
            const v=e.target.value.trim(); 
            e.target.disabled=true; 
            
            // ë¯¸ë¦¬ë³´ê¸° (ì¬ê³  ìƒíƒœ í™•ì¸ìš©)
            fetch(GAS_URL,{method:"POST",body:JSON.stringify({
                action:"scan_preview", barcode:v 
            })}).then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    tempOpenStockData = d.data; // ì •ë³´ ì €ì¥
                    tempOpenStockData.inputCode = v; // ì…ë ¥í•œ ì½”ë“œ(ë°”ì½”ë“œ/ì¼ë ¨ë²ˆí˜¸) ì €ì¥
                    
                    document.getElementById('open_target_info').innerText = `${d.data.model} (${d.data.color})`;
                    document.getElementById('open_step_1').style.display = 'none';
                    document.getElementById('open_step_2').style.display = 'block';
                    document.getElementById('open_cust_name').focus();
                } else {
                    showMsg('open-msg', 'error', d.message);
                    e.target.disabled=false; e.target.value=""; e.target.focus();
                }
            });
        }

        function resetOpenForm() {
            document.getElementById('open_step_1').style.display = 'block';
            document.getElementById('open_step_2').style.display = 'none';
            document.getElementById('open_scan').value = "";
            document.getElementById('open_scan').disabled = false;
            document.getElementById('open_scan').focus();
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('open_cust_name').value = "";
            document.getElementById('open_cust_birth').value = "";
            document.getElementById('open_cust_phone').value = "";
            document.getElementById('open_plan').value = "";
            document.getElementById('open_addon').value = "";
            document.getElementById('open_note').value = "";
            tempOpenStockData = null;
        }

        function submitOpenContract() {
            if(!tempOpenStockData) return;
            const data = {
                action: "open_stock_detail",
                stockInput: tempOpenStockData.inputCode, // ìŠ¤ìº”í–ˆë˜ ì½”ë“œ
                openType: currentOpenType,
                custName: document.getElementById('open_cust_name').value,
                custBirth: document.getElementById('open_cust_birth').value,
                custPhone: document.getElementById('open_cust_phone').value,
                plan: document.getElementById('open_plan').value,
                addon: document.getElementById('open_addon').value,
                contractType: document.getElementById('open_contract_type').value,
                usim: document.getElementById('open_usim').value,
                note: document.getElementById('open_note').value,
                user: currentUser
            };

            if(!data.custName) return alert("ê³ ê°ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
            .then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    showMsg('open-msg', 'success', d.message);
                    resetOpenForm();
                } else {
                    alert(d.message); 
                }
            });
        }

        function loadVendorsToList() { fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => { const div = document.getElementById('vendor_list_ui'); div.innerHTML = ""; d.list.forEach(v => { const safeV = JSON.stringify(v).replace(/"/g, '&quot;'); div.innerHTML += `<div class="list-group-item p-3"><div class="d-flex justify-content-between align-items-center"><div><h6 class="fw-bold mb-0 text-primary">${v.name}</h6><div class="small text-muted mt-1"><i class="bi bi-person me-1"></i>${v.salesName||'-'} | ${v.salesPhone||'-'}</div><div class="small text-muted"><i class="bi bi-building me-1"></i>ê°œí†µì‹¤: ${v.officePhone||'-'}</div></div><div><button class="btn btn-sm btn-outline-secondary me-1" onclick="openEditVendor(${safeV})"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteVendor('${v.name}')"><i class="bi bi-trash"></i></button></div></div></div>`; }); }); }
        function addVendor() { const data = { action: "add_vendor", name: document.getElementById('v_name').value, salesName: document.getElementById('v_sales').value, salesPhone: document.getElementById('v_phone').value, officePhone: document.getElementById('v_office').value }; if(!data.name) return alert("ê±°ë˜ì²˜ëª… í•„ìˆ˜"); fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) }).then(r=>r.json()).then(d=>{ alert(d.message); document.querySelectorAll('.enter-trigger').forEach(i=>i.value=""); loadVendorsToList(); }); }
        function deleteVendor(name) { if(confirm("ì‚­ì œ?")) fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "delete_vendor", name: name }) }).then(r=>r.json()).then(d=>{ alert(d.message); loadVendorsToList(); }); }
        function openEditVendor(v) { document.getElementById('edit_v_old_name').value=v.name; document.getElementById('edit_v_name').value=v.name; document.getElementById('edit_v_sales').value=v.salesName; document.getElementById('edit_v_phone').value=v.salesPhone; document.getElementById('edit_v_office').value=v.officePhone; new bootstrap.Modal(document.getElementById('vendorEditModal')).show(); }
        function submitEditVendor() { const data={ action:"update_vendor", oldName:document.getElementById('edit_v_old_name').value, name:document.getElementById('edit_v_name').value, salesName:document.getElementById('edit_v_sales').value, salesPhone:document.getElementById('edit_v_phone').value, officePhone:document.getElementById('edit_v_office').value }; fetch(GAS_URL,{method:"POST",body:JSON.stringify(data)}).then(r=>r.json()).then(d=>{ alert(d.message); bootstrap.Modal.getInstance(document.getElementById('vendorEditModal')).hide(); loadVendorsToList(); }); }

        function showMsg(id, type, text) { const el=document.getElementById(id); el.style.display='block'; el.className=`alert py-2 text-center small fw-bold rounded-3 alert-${type==='success'?'success':'danger'}`; el.innerHTML=type==='success'?`<i class="bi bi-check-circle-fill me-1"></i> ${text}`:`<i class="bi bi-exclamation-triangle-fill me-1"></i> ${text}`; setTimeout(()=>el.style.display='none',2000); }
        function handleCredentialResponse(r) { fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"login",token:r.credential})}).then(res=>res.json()).then(d=>{ if(d.status==='success') { sessionStorage.setItem('dbphone_user',JSON.stringify({name:d.name,email:d.user})); currentUser=d.name; document.getElementById('login-view').style.display='none'; document.getElementById('main-view').style.display='block'; document.getElementById('user-name').innerText=currentUser; loadInitData(); setupAutoLogout(); } else document.getElementById('login-msg').innerText=d.message; }); }
        function logout() { sessionStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
