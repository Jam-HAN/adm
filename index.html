<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DBPhone Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary-bg: #eef2f6; --card-bg: #ffffff; --accent-color: #4e73df; }
        body { background-color: var(--primary-bg); font-family: 'Noto Sans KR', sans-serif; color: #2e384d; }
        .glass-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: none; overflow: hidden; margin-bottom: 20px; }
        .section-view { display: none; }
        .active-section { display: block; animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-label-sm { font-size: 0.8rem; color: #6c757d; font-weight: 700; margin-bottom: 3px; }
        .form-control-sm, .form-select-sm { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
        .divider { border-top: 1px solid #dee2e6; margin: 25px 0 15px 0; }
        .section-header { font-size: 1rem; font-weight: 800; color: #4e73df; margin-bottom: 12px; display: flex; align-items: center; }
        .section-header i { margin-right: 6px; }
        
        .required-star { color: #dc3545; margin-left: 2px; font-weight: bold; }
        .text-danger-custom { color: #dc3545 !important; font-weight: bold; }
        .border-danger-custom { border-color: #dc3545 !important; color: #dc3545 !important; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-view" style="height: 100vh; background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
        <div class="glass-card p-5 text-center" style="width: 90%; max-width: 400px;">
            <h3 class="fw-bold mb-4 text-primary"><i class="bi bi-phone-vibrate"></i> DBPhone ERP</h3>
            <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large"></div>
            <div id="login-msg" class="text-danger mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <nav class="navbar navbar-expand-lg bg-white custom-navbar sticky-top shadow-sm p-2">
            <div class="container-fluid px-0">
                <span class="navbar-brand fw-bold text-primary"><i class="bi bi-grid-fill"></i> 대박통신</span>
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">📦 재고 관리</a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" onclick="showSection('section-in')">입고 등록</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-move')">재고 이동</a></li>
                                <li><a class="dropdown-item text-danger" onclick="showSection('section-out')">반품 처리</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="showSection('section-stock')">🔍 재고 조회</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-history')">📜 이력 조회</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary fw-bold" href="#" data-bs-toggle="dropdown">✅ 개통 처리</a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" onclick="showOpenSection('무선개통')">📱 무선 개통</a></li>
                                <li><a class="dropdown-item" onclick="showWiredSection()">📺 유선 개통</a></li>
                                <li><a class="dropdown-item" onclick="showUsedSection()">♻️ 중고 개통</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center mt-2 mt-lg-0">
                        <span class="small me-3 fw-bold text-muted" id="user-name"></span>
                        <button onclick="logout()" class="btn btn-sm btn-outline-danger"><i class="bi bi-power"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container py-3">
            
            <div id="section-in" class="section-view active-section">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3 text-primary">입고 등록</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small fw-bold">거래처</label><select class="form-select" id="in_supplier"></select></div>
                        <div class="col-6"><label class="small fw-bold">지점</label><select class="form-select" id="in_branch"><option value="장지 본점">장지 본점</option><option value="명일 직영점">명일 직영점</option></select></div>
                    </div>
                    <div class="mb-3"><input type="checkbox" id="in_mode_toggle"> <label for="in_mode_toggle" class="small">연속 스캔 모드</label></div>
                    <input type="text" class="form-control text-center fw-bold mb-3" id="in_scan" placeholder="바코드 스캔" onkeydown="handleInScan(event)">
                    <div id="in-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>
                    <div id="in_batch_area" style="display:none;" class="bg-light p-3 rounded">
                        <div class="d-flex justify-content-between mb-2"><span class="small fw-bold">대기 목록 <span id="in_count" class="badge bg-primary">0</span></span><button class="btn btn-sm btn-danger py-0" onclick="clearInList()">비우기</button></div>
                        <div style="max-height:150px; overflow-y:auto;"><table class="table table-sm small"><tbody id="in_tbody"></tbody></table></div>
                        <button class="btn btn-primary w-100 mt-2 btn-sm" onclick="submitInBatch()">일괄 등록</button>
                    </div>
                </div>
            </div>

            <div id="section-open" class="section-view">
                <div class="glass-card border-top border-4 border-primary">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary" id="open_title">개통 처리</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetOpenForm()">초기화</button>
                    </div>
                    <div class="p-3">
                        <div id="open_step_1">
                            <div class="text-center p-4 bg-light rounded border mb-3">
                                <label class="text-muted small mb-2">개통할 단말기의 일련번호를 스캔하세요</label>
                                <input type="text" class="form-control text-center fs-5 fw-bold" id="open_scan" onkeydown="handleOpenScan(event)" autocomplete="off">
                                <div id="open_spinner" class="mt-2" style="display:none;"><div class="spinner-border spinner-border-sm text-primary"></div> 조회중...</div>
                            </div>
                        </div>
                        <div id="open_step_2" style="display:none;">
                            <div class="alert alert-primary py-2 small mb-4 d-flex align-items-center justify-content-between">
                                <div><i class="bi bi-phone me-1"></i> <span id="target_model" class="fw-bold fs-6"></span> (<span id="target_serial"></span>)</div>
                                <div class="badge bg-primary text-white border fs-6 shadow-sm" id="target_branch"></div>
                            </div>
                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> 기본 정보</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm">개통유형</label><select class="form-select form-select-sm" id="f_act_type"><option value="" selected>선택</option></select></div>
                                <div class="col-4"><label class="form-label-sm">약정유형</label><select class="form-select form-select-sm" id="f_cont_type"><option value="" selected>선택</option></select></div>
                                <div class="col-4"><label class="form-label-sm">방문경로<span class="required-star">*</span></label><select class="form-select form-select-sm" id="f_visit" onchange="checkVisitPath()"><option value="" selected>선택</option></select></div>
                                <div class="col-12" id="div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="f_visit_etc" placeholder="상세 경로"></div>
                                <div class="col-4"><label class="form-label-sm">고객명<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="f_name"></div>
                                <div class="col-4"><label class="form-label-sm">생년월일</label><input type="text" class="form-control form-control-sm" id="f_birth" placeholder="6자리"></div>
                                <div class="col-4"><label class="form-label-sm">연락처</label><input type="text" class="form-control form-control-sm" id="f_phone" placeholder="숫자만 입력"></div>
                                <div class="col-6"><label class="form-label-sm">요금제</label><input type="text" class="form-control form-control-sm" id="f_plan"></div>
                                <div class="col-6"><label class="form-label-sm">변경요금제</label><input type="text" class="form-control form-control-sm" id="f_plan_chg"></div>
                                <div class="col-12">
                                    <label class="form-label-sm">부가서비스</label>
                                    <div id="div_addon_container" class="border rounded p-2 bg-light" style="min-height: 40px;"><span class="text-muted small">개통처를 확인중입니다...</span></div>
                                </div>
                                <div class="col-4"><label class="form-label-sm">제휴카드</label><input type="text" class="form-control form-control-sm" id="f_card"></div>
                                <div class="col-4"><label class="form-label-sm">리뷰작성여부<span class="required-star">*</span></label><select class="form-select form-select-sm" id="f_review"><option value="" selected>선택</option></select></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> 정책 및 정산</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">개통처</label><input type="text" class="form-control form-control-sm" id="f_avalue" oninput="refreshAddons()"></div>
                                <div class="col-6"><label class="form-label-sm">정책차수</label><input type="text" class="form-control form-control-sm" id="f_policy"></div>
                                <div class="col-6"><label class="form-label-sm">액면/히든</label><input type="number" class="form-control form-control-sm" id="f_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="f_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">추가정책</label><input type="number" class="form-control form-control-sm" id="f_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="f_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">부가정책</label><input type="number" class="form-control form-control-sm" id="f_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="f_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">차감정책</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="f_cost1_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">프리할인</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cost2"></div>
                                <div class="col-6"><label class="form-label-sm">유심</label><select class="form-select form-select-sm" id="f_usim"><option value="" selected>선택</option></select></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> 대납 및 지원</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="f_pay1_m"><option value="" selected>선택</option></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="f_pay1_d"></div>
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="f_pay2_m"><option value="" selected>선택</option></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="f_pay2_d"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">현금지급</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">페이백</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_back"></div>
                                <div class="col-4"><label class="form-label-sm">은행명</label><input type="text" class="form-control form-control-sm" id="f_bank"></div>
                                <div class="col-4"><label class="form-label-sm">계좌번호</label><input type="text" class="form-control form-control-sm" id="f_acc"></div>
                                <div class="col-4"><label class="form-label-sm">예금주</label><input type="text" class="form-control form-control-sm" id="f_holder"></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> 수납 상세</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">단말기수납1</label><input type="number" class="form-control form-control-sm" id="f_inc4"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="f_inc4_m"><option value="" selected>선택</option></select></div>
                                <div class="col-6"><label class="form-label-sm">단말기수납2</label><input type="number" class="form-control form-control-sm" id="f_inc4_2"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="f_inc4_2_m"><option value="" selected>선택</option></select></div>
                                <div class="col-6"><label class="form-label-sm">요금수납</label><input type="number" class="form-control form-control-sm" id="f_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="f_inc5_m"><option value="" selected>선택</option></select></div>
                                <div class="col-6"><label class="form-label-sm">중고폰</label><input type="number" class="form-control form-control-sm" id="f_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="f_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">기타 특이사항</label><input type="text" class="form-control form-control-sm" id="f_comment"></div>
                            </div>
                            <div class="mt-4 pb-4">
                                <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="submitFullContract()">
                                    <i class="bi bi-save-fill"></i> 개통 및 저장 완료
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-wired" class="section-view">
                <div class="glass-card border-top border-4 border-success">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-success">유선 개통</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetWiredForm()">초기화</button>
                    </div>
                    <div class="p-3">
                        <div id="wired_step_1">
                            <div class="p-4 bg-light rounded border mb-3">
                                <label class="small fw-bold mb-2">1. 지점 선택</label>
                                <select class="form-select mb-3" id="wired_branch"><option value="" selected>선택하세요</option><option value="장지 본점">장지 본점</option><option value="명일 직영점">명일 직영점</option></select>
                                <label class="small fw-bold mb-2">2. 개통처 선택</label>
                                <select class="form-select mb-3" id="w_pre_avalue"><option value="" selected>선택하세요</option></select>
                                <label class="small fw-bold mb-2">3. 개통유형 선택</label>
                                <select class="form-select mb-3" id="w_pre_act_type"><option value="" selected>선택하세요</option></select>
                                <label class="small fw-bold mb-2">4. 약정유형 선택</label>
                                <select class="form-select mb-3" id="w_pre_cont_type"><option value="" selected>선택하세요</option></select>
                                <button class="btn btn-success w-100 fw-bold" onclick="startWiredActivation()">다음 단계 <i class="bi bi-arrow-right"></i></button>
                            </div>
                        </div>
                        <div id="wired_step_2" style="display:none;">
                            <div class="alert alert-primary py-2 small mb-4 d-flex align-items-center justify-content-between">
                                <div><i class="bi bi-router me-1"></i> <span id="w_target_info" class="fw-bold fs-6"></span></div>
                                <div class="badge bg-primary text-white border fs-6 shadow-sm" id="w_target_branch"></div>
                            </div>
                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> 기본 정보</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">개통유형</label><input type="text" class="form-control form-control-sm" id="w_act_type" readonly></div>
                                <div class="col-6"><label class="form-label-sm">약정유형</label><input type="text" class="form-control form-control-sm" id="w_cont_type" readonly></div>
                                <div class="col-4"><label class="form-label-sm">방문경로<span class="required-star">*</span></label><select class="form-select form-select-sm" id="w_visit" onchange="checkWiredVisitPath()"></select></div>
                                <div class="col-12" id="w_div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="w_visit_etc" placeholder="상세 경로"></div>
                                <div class="col-4"><label class="form-label-sm">고객명<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="w_name"></div>
                                <div class="col-4"><label class="form-label-sm">생년월일</label><input type="text" class="form-control form-control-sm" id="w_birth"></div>
                                <div class="col-4"><label class="form-label-sm">연락처</label><input type="text" class="form-control form-control-sm" id="w_phone"></div>
                                <div class="col-12" id="w_plan_input_area"></div>
                                <div class="col-4"><label class="form-label-sm">제휴카드</label><input type="text" class="form-control form-control-sm" id="w_card"></div>
                                <div class="col-4"><label class="form-label-sm">리뷰작성<span class="required-star">*</span></label><select class="form-select form-select-sm" id="w_review"></select></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> 정책 및 정산</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">개통처</label><input type="text" class="form-control form-control-sm" id="w_avalue"></div>
                                <div class="col-6"><label class="form-label-sm">정책차수</label><input type="text" class="form-control form-control-sm" id="w_policy"></div>
                                <div class="col-6"><label class="form-label-sm">액면/히든</label><input type="number" class="form-control form-control-sm" id="w_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="w_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">추가정책</label><input type="number" class="form-control form-control-sm" id="w_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="w_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">부가정책</label><input type="number" class="form-control form-control-sm" id="w_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="w_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">차감정책</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="w_cost1_m"></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> 대납 및 지원</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="w_pay1_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="w_pay1_d"></div>
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="w_pay2_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="w_pay2_d"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">현금지급</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">페이백</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_back"></div>
                                <div class="col-4"><label class="form-label-sm">은행명</label><input type="text" class="form-control form-control-sm" id="w_bank"></div>
                                <div class="col-4"><label class="form-label-sm">계좌번호</label><input type="text" class="form-control form-control-sm" id="w_acc"></div>
                                <div class="col-4"><label class="form-label-sm">예금주</label><input type="text" class="form-control form-control-sm" id="w_holder"></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> 수납 상세</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">요금수납</label><input type="number" class="form-control form-control-sm" id="w_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="w_inc5_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">상품권/기타</label><input type="number" class="form-control form-control-sm" id="w_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="w_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">기타 특이사항</label><input type="text" class="form-control form-control-sm" id="w_comment"></div>
                            </div>
                            <div class="mt-4 pb-4">
                                <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" onclick="submitWiredContract(event)">
                                    <i class="bi bi-save-fill"></i> 유선 개통 저장
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-used" class="section-view">
                <div class="glass-card border-top border-4 border-warning">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-warning">중고폰 개통</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetUsedForm()">초기화</button>
                    </div>
                    <div class="p-3">
                        <div id="used_step_1">
                            <div class="p-4 bg-light rounded border mb-3">
                                <label class="small fw-bold mb-2">1. 지점 선택</label>
                                <select class="form-select mb-3" id="u_branch"><option value="" selected>선택하세요</option><option value="장지 본점">장지 본점</option><option value="명일 직영점">명일 직영점</option></select>
                                <label class="small fw-bold mb-2">2. 개통처 선택</label>
                                <select class="form-select mb-3" id="u_pre_avalue"><option value="" selected>선택하세요</option></select>
                                <label class="small fw-bold mb-2">3. 개통유형 선택</label>
                                <select class="form-select mb-3" id="u_pre_act_type"><option value="" selected>선택하세요</option></select>
                                <label class="small fw-bold mb-2">4. 약정유형 선택</label>
                                <select class="form-select mb-3" id="u_pre_cont_type"><option value="" selected>선택하세요</option></select>
                                <button class="btn btn-warning w-100 fw-bold text-white" onclick="startUsedActivation()">다음 단계 <i class="bi bi-arrow-right"></i></button>
                            </div>
                        </div>
                        <div id="used_step_2" style="display:none;">
                            <div class="alert alert-warning py-2 small mb-4 d-flex align-items-center justify-content-between">
                                <div><i class="bi bi-recycle me-1"></i> <span id="u_target_info" class="fw-bold fs-6"></span></div>
                                <div class="badge bg-warning text-dark border fs-6 shadow-sm" id="u_target_branch"></div>
                            </div>
                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> 기본 정보</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">개통유형</label><input type="text" class="form-control form-control-sm" id="u_act_type" readonly></div>
                                <div class="col-6"><label class="form-label-sm">약정유형</label><input type="text" class="form-control form-control-sm" id="u_cont_type" readonly></div>
                                <div class="col-4"><label class="form-label-sm">방문경로<span class="required-star">*</span></label><select class="form-select form-select-sm" id="u_visit" onchange="checkUsedVisitPath()"></select></div>
                                <div class="col-12" id="u_div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="u_visit_etc" placeholder="상세 경로"></div>
                                <div class="col-4"><label class="form-label-sm">고객명<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="u_name"></div>
                                <div class="col-4"><label class="form-label-sm">생년월일</label><input type="text" class="form-control form-control-sm" id="u_birth"></div>
                                <div class="col-4"><label class="form-label-sm">연락처</label><input type="text" class="form-control form-control-sm" id="u_phone"></div>
                                <div class="col-6"><label class="form-label-sm">기기모델명</label><input type="text" class="form-control form-control-sm" id="u_model"></div>
                                <div class="col-6"><label class="form-label-sm">일련번호</label><input type="text" class="form-control form-control-sm" id="u_serial"></div>
                                <div class="col-6"><label class="form-label-sm">요금제</label><input type="text" class="form-control form-control-sm" id="u_plan"></div>
                                <div class="col-6"><label class="form-label-sm">변경요금제</label><input type="text" class="form-control form-control-sm" id="u_plan_chg"></div>
                                <div class="col-12">
                                    <label class="form-label-sm">부가서비스</label>
                                    <div id="u_div_addon_container" class="border rounded p-2 bg-light" style="min-height: 40px;"></div>
                                </div>
                                <div class="col-4"><label class="form-label-sm">제휴카드</label><input type="text" class="form-control form-control-sm" id="u_card"></div>
                                <div class="col-4"><label class="form-label-sm">리뷰작성<span class="required-star">*</span></label><select class="form-select form-select-sm" id="u_review"></select></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> 정책 및 정산</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">개통처</label><input type="text" class="form-control form-control-sm" id="u_avalue" oninput="refreshUsedAddons()"></div>
                                <div class="col-6"><label class="form-label-sm">정책차수</label><input type="text" class="form-control form-control-sm" id="u_policy"></div>
                                <div class="col-6"><label class="form-label-sm">액면/히든</label><input type="number" class="form-control form-control-sm" id="u_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="u_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">추가정책</label><input type="number" class="form-control form-control-sm" id="u_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="u_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">부가정책</label><input type="number" class="form-control form-control-sm" id="u_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="u_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">차감정책</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="u_cost1_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">프리할인</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_cost2"></div>
                                <div class="col-6"><label class="form-label-sm">유심</label><select class="form-select form-select-sm" id="u_usim"><option value="" selected>선택</option></select></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> 대납 및 지원</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="u_pay1_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="u_pay1_d"></div>
                                <div class="col-4"><label class="form-label-sm text-danger-custom">대납2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="u_pay2_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">처리일</label><input type="date" class="form-control form-control-sm" id="u_pay2_d"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">현금지급</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">페이백</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_back"></div>
                                <div class="col-4"><label class="form-label-sm">은행명</label><input type="text" class="form-control form-control-sm" id="u_bank"></div>
                                <div class="col-4"><label class="form-label-sm">계좌번호</label><input type="text" class="form-control form-control-sm" id="u_acc"></div>
                                <div class="col-4"><label class="form-label-sm">예금주</label><input type="text" class="form-control form-control-sm" id="u_holder"></div>
                            </div>
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> 수납 상세</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">단말기수납1</label><input type="number" class="form-control form-control-sm" id="u_inc4"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="u_inc4_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">단말기수납2</label><input type="number" class="form-control form-control-sm" id="u_inc4_2"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="u_inc4_2_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">요금수납</label><input type="number" class="form-control form-control-sm" id="u_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">방법</label><select class="form-select form-select-sm" id="u_inc5_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">중고폰</label><input type="number" class="form-control form-control-sm" id="u_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">메모</label><input type="text" class="form-control form-control-sm" id="u_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">기타 특이사항</label><input type="text" class="form-control form-control-sm" id="u_comment"></div>
                            </div>
                            <div class="mt-4 pb-4">
                                <button class="btn btn-warning w-100 py-3 fw-bold text-white shadow-sm" onclick="submitUsedContract(event)">
                                    <i class="bi bi-save-fill"></i> 중고폰 개통 저장
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-stock" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-search"></i> 재고 조회 (보유분)</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4">
                            <select class="form-select fw-bold" id="search_criteria" onchange="updateSearchUI()">
                                <option value="supplier">거래처별</option>
                                <option value="branch">지점별</option>
                                <option value="model">모델별</option>
                                <option value="serial">일련번호/바코드</option>
                            </select>
                        </div>
                        <div class="col-8" id="search_input_area"><select class="form-select" id="search_value_supplier"></select></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-3 mb-3" onclick="searchStock()">조회하기</button>
                    <div id="stock_result"></div>
                </div>
            </div>

            <div id="section-history" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> 이력 조회 (로그)</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="hist_keyword" placeholder="일련번호 또는 바코드 (정확히 입력)" onkeydown="if(event.key==='Enter') searchHistory()">
                        <button class="btn btn-outline-secondary" onclick="searchHistory()">검색</button>
                    </div>
                    <div id="hist_result"></div>
                </div>
            </div>

            <div id="section-move" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">재고 이동</h5>
                    <select class="form-select bg-light fw-bold py-3 mb-3" id="move_to_branch"><option value="명일 직영점">👉 명일 직영점으로 보냄</option><option value="장지 본점">👉 장지 본점으로 보냄</option></select>
                    <div class="scan-wrapper my-4"><input type="text" class="form-control scan-input" id="move_scan" placeholder="바코드 또는 일련번호" onkeydown="handleMoveScan(event)" autocomplete="off"></div>
                    <div id="move-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-out" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-danger">
                    <h5 class="fw-bold mb-4 text-danger">반품 처리</h5>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="out_note" placeholder="사유"><label>반품 사유 / 메모 (필수)</label></div>
                    <div class="scan-wrapper bg-danger bg-opacity-75 my-4" style="background-color: #d63031;"><input type="text" class="form-control scan-input border-danger" id="out_scan" placeholder="바코드 또는 일련번호" onkeydown="handleOutScan(event)" autocomplete="off"></div>
                    <div id="out-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>
            
            <div id="section-vendor" class="section-view fade-in">
                 <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3">거래처 등록</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_name" placeholder="거래처명 (필수)"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_sales" placeholder="영업사원"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_phone" placeholder="연락처"></div>
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_office" placeholder="개통실 전화번호"></div>
                    </div>
                    <button class="btn btn-secondary w-100 fw-bold rounded-3" onclick="addVendor()">등록하기</button>
                </div>
                <div class="glass-card p-0">
                    <div class="p-3 border-bottom bg-light"><h6 class="mb-0 fw-bold">등록된 거래처</h6></div>
                    <div id="vendor_list_ui" class="list-group list-group-flush"></div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];
        let globalVendorList = [];
        let globalModelList = [];
        let globalAddonList = []; 
        let currentOpenType = "";
        let logoutTimer;
        let tempOpenStockData = null;

        // 유선/중고용 전역 변수
        let wiredActList = [];
        let wiredContList = [];

        window.onload = function() {
            const saved = sessionStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
                document.getElementById('user-name').innerText = currentUser;
                loadInitData();
                setupAutoLogout();
            }
            document.querySelectorAll('.enter-trigger').forEach(input => {
                input.addEventListener('keydown', function(e) { if(e.key === 'Enter') addVendor(); });
            });
        };

        function setupAutoLogout() {
            resetLogoutTimer();
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, resetLogoutTimer));
        }
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if(currentUser) {
                logoutTimer = setTimeout(() => { alert("10분 동안 활동이 없어 자동 로그아웃 되었습니다."); logout(); }, 600000);
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section', 'fade-in'));
            document.getElementById(id).classList.add('active-section', 'fade-in');
            if(id === 'section-in') loadInitData();
            if(id === 'section-vendor') loadVendorsToList();
            if(id === 'section-stock') updateSearchUI();
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        function showOpenSection(type) {
            currentOpenType = type;
            document.getElementById('open_title').innerText = type + " 처리";
            resetOpenForm();
            loadDropdownData(); 
            showSection('section-open');
        }

        function showWiredSection() {
            resetWiredForm();
            loadDropdownData(); 
            showSection('section-wired');
        }

        function showUsedSection() {
            resetUsedForm();
            loadDropdownData(); 
            showSection('section-used');
        }

        function loadInitData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => {
                globalVendorList = d.list.map(v => v.name);
                const sel = document.getElementById('in_supplier'); sel.innerHTML = "";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                if(document.getElementById('search_criteria').value === 'supplier') updateSearchUI();
            });
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_models" }) }).then(r => r.json()).then(d => globalModelList = d.list);
        }

        function loadDropdownData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_dropdown_data" }) })
            .then(r => r.json())
            .then(d => {
                if(d.status !== 'success') return;
                
                const fill = (id, list) => {
                    const sel = document.getElementById(id);
                    if(sel) {
                        sel.innerHTML = '<option value="" selected>선택</option>';
                        list.forEach(item => { sel.innerHTML += `<option value="${item}">${item}</option>`; });
                    }
                };
                
                // 무선
                fill('f_act_type', d.actListMobile);
                fill('f_cont_type', d.contListMobile);
                fill('f_review', d.reviewList);
                fill('f_usim', d.usimList);
                
                // 유선
                fill('w_pre_act_type', d.actListWired); 
                fill('w_pre_cont_type', d.contListWired); 
                fill('w_review', d.reviewList);

                // 중고
                fill('u_pre_act_type', d.actListUsed); 
                fill('u_pre_cont_type', d.contListUsed); 
                fill('u_review', d.reviewList);
                fill('u_usim', d.usimList);

                // 유선 개통처 (Step 1)
                if(d.wiredVendorList) {
                    fill('w_pre_avalue', d.wiredVendorList);
                    fill('u_pre_avalue', d.wiredVendorList); // 중고도 같은 거래처 리스트 사용
                }

                // 공통
                const vList = d.visitList || [];
                const vOpts = '<option value="" selected>선택</option>' + vList.map(i=>`<option value="${i}">${i}</option>`).join('') + '<option value="기타">기타 (직접입력)</option>';
                if(document.getElementById('f_visit')) document.getElementById('f_visit').innerHTML = vOpts;
                if(document.getElementById('w_visit')) document.getElementById('w_visit').innerHTML = vOpts;
                if(document.getElementById('u_visit')) document.getElementById('u_visit').innerHTML = vOpts;

                // 결제방법
                const pList = d.payMethodList || []; 
                const cList = d.colMethodList || [];
                
                ['f_pay1_m','f_pay2_m', 'w_pay1_m','w_pay2_m', 'u_pay1_m','u_pay2_m'].forEach(id => fill(id, pList));
                ['f_inc4_m','f_inc4_2_m','f_inc5_m', 'w_inc5_m', 'u_inc4_m','u_inc4_2_m','u_inc5_m'].forEach(id => fill(id, cList));

                globalAddonList = d.addonList || [];
            });
        }

        function checkVisitPath() {
            const val = document.getElementById('f_visit').value;
            if(val === '기타') document.getElementById('div_visit_etc').style.display = 'block';
            else document.getElementById('div_visit_etc').style.display = 'none';
        }
        function checkWiredVisitPath() {
            const val = document.getElementById('w_visit').value;
            if(val === '기타') document.getElementById('w_div_visit_etc').style.display = 'block';
            else document.getElementById('w_div_visit_etc').style.display = 'none';
        }
        function checkUsedVisitPath() {
            const val = document.getElementById('u_visit').value;
            if(val === '기타') document.getElementById('u_div_visit_etc').style.display = 'block';
            else document.getElementById('u_div_visit_etc').style.display = 'none';
        }

        function renderAddonCheckboxes(agencyName, containerId = 'div_addon_container') {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = "";
            const filtered = globalAddonList.filter(item => item.vendor === agencyName);
            if(filtered.length === 0) {
                container.innerHTML = `<span class='text-muted small'>[${agencyName}] 부가서비스 없음</span>`;
                return;
            }
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "form-check form-check-inline";
                div.innerHTML = `<input class="form-check-input addon-check" type="checkbox" id="${containerId}_${item.name}" value="${item.name}"><label class="form-check-label small" for="${containerId}_${item.name}">${item.name}</label>`;
                container.appendChild(div);
            });
        }

        function refreshAddons() { renderAddonCheckboxes(document.getElementById('f_avalue').value, 'div_addon_container'); }
        function refreshWiredAddons() { renderAddonCheckboxes(document.getElementById('w_avalue').value, 'w_div_addon_container'); }
        function refreshUsedAddons() { renderAddonCheckboxes(document.getElementById('u_avalue').value, 'u_div_addon_container'); }

        // --- 유선 기능 ---
        function startWiredActivation() {
            const branch = document.getElementById('wired_branch').value;
            const vendor = document.getElementById('w_pre_avalue').value;
            const type = document.getElementById('w_pre_act_type').value;
            const contract = document.getElementById('w_pre_cont_type').value;

            if(!branch || !vendor || !type || !contract) return alert("모든 항목을 선택해주세요.");

            document.getElementById('wired_step_1').style.display = 'none';
            document.getElementById('wired_step_2').style.display = 'block';

            document.getElementById('w_avalue').value = vendor;
            document.getElementById('w_act_type').value = type;
            document.getElementById('w_cont_type').value = contract;

            document.getElementById('w_target_info').innerText = `${type} : ${contract}`;
            document.getElementById('w_target_branch').innerText = branch;

            renderWiredPlanInputs(contract);
        }

        function renderWiredPlanInputs(contractType) {
            const area = document.getElementById('w_plan_input_area');
            area.innerHTML = "";
            
            if(contractType === "인터넷+TV+기타서비스") {
                area.innerHTML = `<div class="row g-2"><div class="col-4"><label class="form-label-sm">인터넷요금제</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div><div class="col-4"><label class="form-label-sm">TV요금제</label><input type="text" class="form-control form-control-sm" id="w_plan_tv"></div><div class="col-4"><label class="form-label-sm">기타서비스</label><input type="text" class="form-control form-control-sm" id="w_plan_other"></div></div>`;
            } else if(contractType === "인터넷+TV") {
                area.innerHTML = `<div class="row g-2"><div class="col-6"><label class="form-label-sm">인터넷요금제</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div><div class="col-6"><label class="form-label-sm">TV요금제</label><input type="text" class="form-control form-control-sm" id="w_plan_tv"></div></div>`;
            } else {
                area.innerHTML = `<div class="row g-2"><div class="col-12"><label class="form-label-sm">인터넷요금제</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div></div>`;
            }
        }

        function resetWiredForm() {
            document.getElementById('wired_branch').selectedIndex = 0;
            document.getElementById('w_pre_avalue').selectedIndex = 0;
            document.getElementById('w_pre_act_type').selectedIndex = 0;
            document.getElementById('w_pre_cont_type').selectedIndex = 0;
            
            document.getElementById('wired_step_1').style.display = 'block';
            document.getElementById('wired_step_2').style.display = 'none';
            
            document.querySelectorAll('#wired_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#wired_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('w_div_visit_etc').style.display = 'none';
        }

        function submitWiredContract(event) {
            if (!validateField('w_visit', '방문경로')) return;
            if (!validateField('w_name', '고객명')) return;
            if (!validateField('w_review', '리뷰작성여부')) return;

            let visitVal = document.getElementById('w_visit').value;
            if(visitVal === '기타') {
                if(!validateField('w_visit_etc', '상세 방문경로')) return;
                visitVal = "기타: " + document.getElementById('w_visit_etc').value;
            }

            const net = document.getElementById('w_plan_net');
            const tv = document.getElementById('w_plan_tv');
            const other = document.getElementById('w_plan_other');
            const parts = [];
            if(net && net.value) parts.push(net.value);
            if(tv && tv.value) parts.push(tv.value);
            if(other && other.value) parts.push(other.value);
            const pricePlan = parts.join(" / ");

            const formData = {
                action: "open_wired_full",
                user: currentUser,
                branch: document.getElementById('wired_branch').value, 
                activationType: document.getElementById('w_act_type').value,
                contractType: document.getElementById('w_cont_type').value,
                name: document.getElementById('w_name').value,
                birth: document.getElementById('w_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('w_phone').value,
                pricePlan: pricePlan, 
                card: document.getElementById('w_card').value,
                review: document.getElementById('w_review').value,
                aValue: document.getElementById('w_avalue').value,
                policy: document.getElementById('w_policy').value,
                income1: document.getElementById('w_inc1').value,
                income1Memo: document.getElementById('w_inc1_m').value,
                income2: document.getElementById('w_inc2').value,
                income2Memo: document.getElementById('w_inc2_m').value,
                income3: document.getElementById('w_inc3').value,
                income3Memo: document.getElementById('w_inc3_m').value,
                cost1: document.getElementById('w_cost1').value,
                cost1Memo: document.getElementById('w_cost1_m').value,
                payment1: document.getElementById('w_pay1').value,
                payment1Method: document.getElementById('w_pay1_m').value,
                payment1Date: document.getElementById('w_pay1_d').value,
                payment2: document.getElementById('w_pay2').value,
                payment2Method: document.getElementById('w_pay2_m').value,
                payment2Date: document.getElementById('w_pay2_d').value,
                cash: document.getElementById('w_cash').value,
                payback1: document.getElementById('w_back').value,
                bankName: document.getElementById('w_bank').value,
                accountNumber: document.getElementById('w_acc').value,
                depositor: document.getElementById('w_holder').value,
                income5: document.getElementById('w_inc5').value,
                income5Method: document.getElementById('w_inc5_m').value,
                income6: document.getElementById('w_inc6').value,
                income6Memo: document.getElementById('w_inc6_m').value,
                comment: document.getElementById('w_comment').value
            };

            const btn = event.currentTarget; 
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 저장 중...`;
            btn.disabled = true;

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetWiredForm(); } else { alert("오류: " + d.message); }
            })
            .catch(e => alert("통신 오류"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        // --- 중고 기능 ---
        function startUsedActivation() {
            const branch = document.getElementById('u_branch').value;
            const vendor = document.getElementById('u_pre_avalue').value;
            const type = document.getElementById('u_pre_act_type').value;
            const contract = document.getElementById('u_pre_cont_type').value;

            if(!branch || !vendor || !type || !contract) return alert("모든 항목을 선택해주세요.");

            document.getElementById('used_step_1').style.display = 'none';
            document.getElementById('used_step_2').style.display = 'block';

            document.getElementById('u_avalue').value = vendor;
            document.getElementById('u_act_type').value = type;
            document.getElementById('u_cont_type').value = contract;

            document.getElementById('u_target_info').innerText = `${type} : ${contract}`;
            document.getElementById('u_target_branch').innerText = branch;

            refreshUsedAddons();
        }

        function resetUsedForm() {
            document.getElementById('u_branch').selectedIndex = 0;
            document.getElementById('u_pre_avalue').selectedIndex = 0;
            document.getElementById('u_pre_act_type').selectedIndex = 0;
            document.getElementById('u_pre_cont_type').selectedIndex = 0;
            
            document.getElementById('used_step_1').style.display = 'block';
            document.getElementById('used_step_2').style.display = 'none';
            
            document.querySelectorAll('#used_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#used_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('u_div_visit_etc').style.display = 'none';
            document.getElementById('u_div_addon_container').innerHTML = "";
        }

        function submitUsedContract(event) {
            if (!validateField('u_visit', '방문경로')) return;
            if (!validateField('u_name', '고객명')) return;
            if (!validateField('u_review', '리뷰작성여부')) return;

            let visitVal = document.getElementById('u_visit').value;
            if(visitVal === '기타') {
                if(!validateField('u_visit_etc', '상세 방문경로')) return;
                visitVal = "기타: " + document.getElementById('u_visit_etc').value;
            }

            const selectedAddons = [];
            document.querySelectorAll('#u_div_addon_container .addon-check:checked').forEach(cb => selectedAddons.push(cb.value));

            const formData = {
                action: "open_used_full",
                user: currentUser,
                branch: document.getElementById('u_branch').value, 
                
                activationType: document.getElementById('u_act_type').value,
                contractType: document.getElementById('u_cont_type').value,
                name: document.getElementById('u_name').value,
                birth: document.getElementById('u_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('u_phone').value,
                pricePlan: document.getElementById('u_plan').value,
                changePlan: document.getElementById('u_plan_chg').value,
                
                selectedAddons: selectedAddons,
                
                usim: document.getElementById('u_usim').value,
                card: document.getElementById('u_card').value,
                review: document.getElementById('u_review').value,
                
                aValue: document.getElementById('u_avalue').value,
                policy: document.getElementById('u_policy').value,
                
                // ★ 기기 정보
                model: document.getElementById('u_model').value,
                serial: document.getElementById('u_serial').value,

                income1: document.getElementById('u_inc1').value,
                income1Memo: document.getElementById('u_inc1_m').value,
                income2: document.getElementById('u_inc2').value,
                income2Memo: document.getElementById('u_inc2_m').value,
                income3: document.getElementById('u_inc3').value,
                income3Memo: document.getElementById('u_inc3_m').value,
                cost1: document.getElementById('u_cost1').value,
                cost1Memo: document.getElementById('u_cost1_m').value,
                cost2: document.getElementById('u_cost2').value,
                
                payment1: document.getElementById('u_pay1').value,
                payment1Method: document.getElementById('u_pay1_m').value,
                payment1Date: document.getElementById('u_pay1_d').value,
                payment2: document.getElementById('u_pay2').value,
                payment2Method: document.getElementById('u_pay2_m').value,
                payment2Date: document.getElementById('u_pay2_d').value,
                
                cash: document.getElementById('u_cash').value,
                payback1: document.getElementById('u_back').value,
                bankName: document.getElementById('u_bank').value,
                accountNumber: document.getElementById('u_acc').value,
                depositor: document.getElementById('u_holder').value,
                
                income4_1: document.getElementById('u_inc4').value,
                income4_1Method: document.getElementById('u_inc4_m').value,
                income4_2: document.getElementById('u_inc4_2').value,
                income4_2Method: document.getElementById('u_inc4_2_m').value,
                income5: document.getElementById('u_inc5').value,
                income5Method: document.getElementById('u_inc5_m').value,
                income6: document.getElementById('u_inc6').value,
                income6Memo: document.getElementById('u_inc6_m').value,
                
                comment: document.getElementById('u_comment').value
            };

            const btn = event.currentTarget; 
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 저장 중...`;
            btn.disabled = true;

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetUsedForm(); } else { alert("오류: " + d.message); }
            })
            .catch(e => alert("통신 오류"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        // --- 공통 기능 ---
        function handleOpenScan(e) { 
            if(e.key!=='Enter') return; 
            const v=e.target.value.trim(); 
            e.target.disabled = true;
            document.getElementById('open_spinner').style.display = 'block';

            fetch(GAS_URL,{method:"POST",body:JSON.stringify({ action:"get_stock_info_for_open", input:v })})
            .then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    tempOpenStockData = d.data; 
                    tempOpenStockData.inputCode = v; 
                    document.getElementById('target_model').innerText = `${d.data.model} (${d.data.color})`; 
                    document.getElementById('target_serial').innerText = d.data.serial;
                    document.getElementById('target_branch').innerText = d.data.branch || "지점미상"; 
                    document.getElementById('f_avalue').value = d.data.supplier || ""; 
                    refreshAddons(); 
                    document.getElementById('open_step_1').style.display = 'none';
                    document.getElementById('open_step_2').style.display = 'block';
                    document.getElementById('f_name').focus();
                } else {
                    alert(d.message);
                    e.target.disabled=false; e.target.value=""; e.target.focus();
                }
            })
            .catch(err => { alert("통신 오류 발생"); e.target.disabled=false; })
            .finally(() => { document.getElementById('open_spinner').style.display = 'none'; });
        }

        function validateField(id, name) {
            const el = document.getElementById(id);
            if (!el.value) { alert(name + "을(를) 입력/선택해주세요."); el.focus(); return false; }
            return true;
        }

        function submitFullContract() {
            if(!tempOpenStockData) return;
            if (!validateField('f_visit', '방문경로')) return;
            if (!validateField('f_name', '고객명')) return;
            if (!validateField('f_review', '리뷰작성여부')) return;

            let visitVal = document.getElementById('f_visit').value;
            if(visitVal === '기타') {
                if(!validateField('f_visit_etc', '상세 방문경로')) return;
                visitVal = "기타: " + document.getElementById('f_visit_etc').value;
            }

            const selectedAddons = [];
            document.querySelectorAll('#div_addon_container .addon-check:checked').forEach(cb => selectedAddons.push(cb.value));

            const formData = {
                action: "open_stock_full",
                stockInput: tempOpenStockData.inputCode,
                user: currentUser,
                activationType: document.getElementById('f_act_type').value,
                contractType: document.getElementById('f_cont_type').value,
                name: document.getElementById('f_name').value,
                birth: document.getElementById('f_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('f_phone').value,
                pricePlan: document.getElementById('f_plan').value,
                changePlan: document.getElementById('f_plan_chg').value,
                selectedAddons: selectedAddons, 
                usim: document.getElementById('f_usim').value,
                card: document.getElementById('f_card').value,
                review: document.getElementById('f_review').value,
                aValue: document.getElementById('f_avalue').value,
                policy: document.getElementById('f_policy').value,
                income1: document.getElementById('f_inc1').value,
                income1Memo: document.getElementById('f_inc1_m').value,
                income2: document.getElementById('f_inc2').value,
                income2Memo: document.getElementById('f_inc2_m').value,
                income3: document.getElementById('f_inc3').value,
                income3Memo: document.getElementById('f_inc3_m').value,
                cost1: document.getElementById('f_cost1').value,
                cost1Memo: document.getElementById('f_cost1_m').value,
                cost2: document.getElementById('f_cost2').value,
                payment1: document.getElementById('f_pay1').value,
                payment1Method: document.getElementById('f_pay1_m').value,
                payment1Date: document.getElementById('f_pay1_d').value,
                payment2: document.getElementById('f_pay2').value,
                payment2Method: document.getElementById('f_pay2_m').value,
                payment2Date: document.getElementById('f_pay2_d').value,
                cash: document.getElementById('f_cash').value,
                payback1: document.getElementById('f_back').value,
                bankName: document.getElementById('f_bank').value,
                accountNumber: document.getElementById('f_acc').value,
                depositor: document.getElementById('f_holder').value,
                income4_1: document.getElementById('f_inc4').value,
                income4_1Method: document.getElementById('f_inc4_m').value,
                income4_2: document.getElementById('f_inc4_2').value,
                income4_2Method: document.getElementById('f_inc4_2_m').value,
                income5: document.getElementById('f_inc5').value,
                income5Method: document.getElementById('f_inc5_m').value,
                income6: document.getElementById('f_inc6').value,
                income6Memo: document.getElementById('f_inc6_m').value,
                comment: document.getElementById('f_comment').value
            };

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> 저장 중...`;
            btn.disabled = true;

            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetOpenForm(); } else { alert("오류: " + d.message); }
            })
            .catch(e => alert("통신 오류"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function resetOpenForm() {
            document.getElementById('open_step_1').style.display = 'block';
            document.getElementById('open_step_2').style.display = 'none';
            document.getElementById('open_scan').value = "";
            document.getElementById('open_scan').disabled = false;
            document.getElementById('open_spinner').style.display = 'none';
            document.getElementById('open_scan').focus();
            document.querySelectorAll('#open_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#open_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('div_visit_etc').style.display='none';
            document.getElementById('div_addon_container').innerHTML = "<span class='text-muted small'>...</span>";
            tempOpenStockData = null;
        }

        // --- 기타 기능 (기존 유지) ---
        function updateSearchUI() {
            const criteria = document.getElementById('search_criteria').value;
            const area = document.getElementById('search_input_area');
            area.innerHTML = "";
            if(criteria === 'supplier') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'branch') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                ["장지 본점", "명일 직영점"].forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'model') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalModelList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else {
                const inp = document.createElement('input'); inp.className = "form-control"; inp.id = "search_value"; inp.placeholder = "입력하세요";
                inp.onkeydown = function(e){ if(e.key==='Enter') searchStock(); };
                area.appendChild(inp); inp.focus();
            }
        }
        function searchStock() {
            const crit = document.getElementById('search_criteria').value;
            const val = document.getElementById('search_value').value;
            const div = document.getElementById('stock_result');
            div.innerHTML = `<div class="text-center py-4"><span class="spinner-border text-primary"></span></div>`;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_stock", criteria: crit, keyword: val }) })
            .then(r => r.json()).then(d => {
                if(!d.list || d.list.length === 0) { div.innerHTML = `<div class="text-center text-muted py-5">결과 없음</div>`; return; }
                let html = `<div class="table-responsive"><table class="table table-hover stock-table"><thead><tr><th>입고일</th><th>모델</th><th>색상</th><th>일련번호</th><th>상태</th><th>위치</th></tr></thead><tbody>`;
                d.list.forEach(item => {
                    let st = item.status === '보유' ? 'text-success' : 'text-danger';
                    html += `<tr><td>${item.date}</td><td class="fw-bold">${item.model}</td><td>${item.color}</td><td class="font-monospace">${item.serial}</td><td class="${st} fw-bold">${item.status}</td><td>${item.branch}</td></tr>`;
                });
                html += `</tbody></table></div><div class="text-end small text-muted">총 ${d.list.length}건</div>`;
                div.innerHTML = html;
            });
        }
        function searchHistory() { const k=document.getElementById('hist_keyword').value; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"search_history",keyword:k})}).then(r=>r.json()).then(d=>{ let h=""; d.list.forEach(i=>h+=`<div class='glass-card p-2 mb-2'><span class='badge bg-secondary'>${i.type}</span> ${i.model} (${i.time})</div>`); document.getElementById('hist_result').innerHTML=h; }); }
        function handleInScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(inPendingList.some(i=>i.barcode===v)){showMsg('in-msg','error','이미 목록에 있음');e.target.value="";return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:document.getElementById('in_mode_toggle').checked?"scan_preview":"register_single",barcode:v,supplier:document.getElementById('in_supplier').value,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){if(document.getElementById('in_mode_toggle').checked){inPendingList.push({...d.data,supplier:document.getElementById('in_supplier').value});renderInList();showMsg('in-msg','success',`추가: ${d.data.model}`);}else showMsg('in-msg','success',`입고: ${d.data.model}`);}else showMsg('in-msg','error',d.message);}).finally(()=>{e.target.value="";e.target.focus();}); }
        function renderInList() { const t=document.getElementById('in_tbody'); t.innerHTML=""; inPendingList.forEach((i,x)=>t.innerHTML+=`<tr><td>${i.model}</td><td>${i.serial}</td><td><button onclick="inPendingList.splice(${x},1);renderInList()">X</button></td></tr>`); document.getElementById('in_count').innerText=inPendingList.length; }
        function clearInList() { inPendingList=[]; renderInList(); }
        function submitInBatch() { if(!inPendingList.length)return; if(!confirm("입고?"))return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"batch_register",items:inPendingList,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert(d.count+"대 입고완료");clearInList();}else alert(d.message);}); }
        function handleMoveScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"transfer_stock",input:v,toBranch:document.getElementById('move_to_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('move-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function handleOutScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(!document.getElementById('out_note').value){alert("사유필수");return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"return_stock",input:v,note:document.getElementById('out_note').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('out-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function loadVendorsToList() { fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => { const div = document.getElementById('vendor_list_ui'); div.innerHTML = ""; d.list.forEach(v => { div.innerHTML += `<div class="list-group-item p-2">${v.name} <button class="btn btn-sm btn-outline-danger float-end" onclick="deleteVendor('${v.name}')">삭제</button></div>`; }); }); }
        function addVendor() { const n=document.getElementById('v_name').value; if(!n)return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"add_vendor",name:n,salesName:document.getElementById('v_sales').value,salesPhone:document.getElementById('v_phone').value,officePhone:document.getElementById('v_office').value})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        function deleteVendor(n) { if(confirm("삭제?")) fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"delete_vendor",name:n})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        
        function showMsg(id, type, text) { const el=document.getElementById(id); el.style.display='block'; el.className=`alert py-2 text-center small fw-bold rounded-3 alert-${type==='success'?'success':'danger'}`; el.innerText=text; setTimeout(()=>el.style.display='none',2000); }
        function handleCredentialResponse(r) { fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"login",token:r.credential})}).then(res=>res.json()).then(d=>{ if(d.status==='success') { sessionStorage.setItem('dbphone_user',JSON.stringify({name:d.name,email:d.user})); currentUser=d.name; document.getElementById('login-view').style.display='none'; document.getElementById('main-view').style.display='block'; document.getElementById('user-name').innerText=currentUser; loadInitData(); setupAutoLogout(); } else document.getElementById('login-msg').innerText=d.message; }); }
        function logout() { sessionStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
