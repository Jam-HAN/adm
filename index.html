<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ë°•í†µì‹  í†µí•©ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Noto Sans KR', sans-serif; }
        .nav-link { cursor: pointer; font-weight: bold; color: #495057; }
        .nav-link.active { color: #0d6efd !important; border-bottom: 3px solid #0d6efd; }
        .scan-area { background-color: #212529; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 15px;}
        .scan-input { background-color: #495057; color: #00ff00; border: 2px solid #6c757d; font-weight: bold; text-align: center; font-size: 1.2rem; }
        .scan-input:focus { background-color: #000; color: #00ff00; border-color: #00ff00; box-shadow: none;}
        .section-view { display: none; padding: 20px 0; }
        .active-section { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #login-view { height: 100vh; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-view" class="bg-white">
        <div class="text-center">
            <h1 class="mb-4 fw-bold text-primary"><i class="bi bi-phone"></i> ëŒ€ë°•í†µì‹  ERP</h1>
            <div class="card p-5 shadow-sm border-0" style="max-width: 400px; width: 100%;">
                <p class="mb-3 text-muted">ì§ì› ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”</p>
                <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
                <div class="g_id_signin" data-type="standard"></div>
                <div id="login-msg" class="text-danger mt-3 small"></div>
            </div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <nav class="navbar navbar-light bg-white shadow-sm sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#"><i class="bi bi-grid-3x3-gap-fill text-primary"></i> ëŒ€ë°•í†µì‹ </a>
                <span class="navbar-text small">
                    <i class="bi bi-person-circle"></i> <span id="user-name">ì§ì›</span>ë‹˜
                    <a href="#" onclick="logout()" class="text-decoration-none ms-2 text-danger">ë¡œê·¸ì•„ì›ƒ</a>
                </span>
            </div>
            <div class="container-fluid mt-2">
                <ul class="nav nav-tabs border-0 w-100" id="mainTab">
                    <li class="nav-item"><a class="nav-link active" onclick="showSection('section-in')">ğŸ“¦ ì…ê³ </a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-move')">ğŸšš ì´ë™</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-out')">â†©ï¸ ë°˜í’ˆ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-history')">ğŸ“œ ì¡°íšŒ</a></li>
                    <li class="nav-item ms-auto"><a class="nav-link text-secondary" onclick="showSection('section-vendor')">ğŸ¢ ê±°ë˜ì²˜</a></li>
                </ul>
            </div>
        </nav>

        <div class="container pb-5">
            
            <div id="section-in" class="section-view active-section">
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="small text-muted">ê±°ë˜ì²˜</label>
                        <select class="form-select" id="in_supplier"></select> </div>
                    <div class="col-md-6">
                        <label class="small text-muted">ì…ê³ ì§€ì </label>
                        <select class="form-select" id="in_branch">
                            <option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option>
                            <option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option>
                        </select>
                    </div>
                </div>
                
                <div class="form-check form-switch mb-2 text-end">
                    <input class="form-check-input" type="checkbox" id="in_mode_toggle" onchange="toggleInMode()">
                    <label class="form-check-label small fw-bold" for="in_mode_toggle" id="in_mode_label">ì¼ë°˜ ì…ê³ </label>
                </div>

                <div class="scan-area">
                    <input type="text" class="form-control scan-input" id="in_scan" placeholder="ì…ê³  ë°”ì½”ë“œ ìŠ¤ìº”" onkeydown="handleInScan(event)" autocomplete="off">
                </div>
                <div id="in-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>

                <div id="in_batch_area" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <span class="fw-bold small">ëŒ€ê¸° ëª©ë¡ (<span id="in_count">0</span>)</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearInList()">ë¹„ìš°ê¸°</button>
                        </div>
                        <div class="card-body p-0" style="max-height: 200px; overflow-y:auto;">
                            <table class="table table-sm table-striped mb-0 small text-center">
                                <thead><tr><th>ëª¨ë¸</th><th>ì¼ë ¨ë²ˆí˜¸</th><th>ì‚­ì œ</th></tr></thead>
                                <tbody id="in_tbody"></tbody>
                            </table>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-success w-100 fw-bold" id="btn_in_submit" onclick="submitInBatch()" disabled>ì¼ê´„ ì…ê³  í™•ì •</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-move" class="section-view">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title fw-bold">ì¬ê³  ì´ë™</h5>
                        <p class="card-text small text-muted">ìŠ¤ìº”í•œ ê¸°ê¸°ë¥¼ ì•„ë˜ ì„ íƒí•œ ì§€ì ìœ¼ë¡œ ì¦‰ì‹œ ì´ë™ì‹œí‚µë‹ˆë‹¤.</p>
                        <select class="form-select mb-3 bg-light fw-bold" id="move_to_branch">
                            <option value="ëª…ì¼ ì§ì˜ì ">ğŸ‘‰ ëª…ì¼ ì§ì˜ì ìœ¼ë¡œ ë³´ëƒ„</option>
                            <option value="ì¥ì§€ ë³¸ì ">ğŸ‘‰ ì¥ì§€ ë³¸ì ìœ¼ë¡œ ë³´ëƒ„</option>
                        </select>
                        <div class="scan-area py-3">
                            <input type="text" class="form-control scan-input" id="move_scan" placeholder="ì´ë™í•  ê¸°ê¸° ìŠ¤ìº”" onkeydown="handleMoveScan(event)" autocomplete="off">
                        </div>
                        <div id="move-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>
                    </div>
                </div>
            </div>

            <div id="section-out" class="section-view">
                <div class="card border-danger mb-3">
                    <div class="card-body">
                        <h5 class="card-title fw-bold text-danger">ë°˜í’ˆ ì²˜ë¦¬</h5>
                        <div class="mb-3">
                            <label class="small text-muted">ë°˜í’ˆ ì‚¬ìœ  / ë©”ëª¨</label>
                            <input type="text" class="form-control" id="out_note" placeholder="ì˜ˆ: ì˜ì—…ì‚¬ì› ìš”ì²­, ë¶ˆëŸ‰ ë°˜í’ˆ ë“±">
                        </div>
                        <div class="scan-area py-3 bg-danger bg-opacity-10">
                            <input type="text" class="form-control scan-input border-danger text-danger" id="out_scan" placeholder="ë°˜í’ˆí•  ê¸°ê¸° ìŠ¤ìº”" onkeydown="handleOutScan(event)" autocomplete="off">
                        </div>
                        <div id="out-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>
                    </div>
                </div>
            </div>

            <div id="section-history" class="section-view">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="hist_keyword" placeholder="ì¼ë ¨ë²ˆí˜¸ ë˜ëŠ” ëª¨ë¸ëª… ê²€ìƒ‰" onkeydown="if(event.key==='Enter') searchHistory()">
                    <button class="btn btn-primary" onclick="searchHistory()"><i class="bi bi-search"></i> ì¡°íšŒ</button>
                </div>
                <div id="hist_result">
                    </div>
            </div>

            <div id="section-vendor" class="section-view">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="new_vendor_name" placeholder="ìƒˆ ê±°ë˜ì²˜ ì´ë¦„">
                    <button class="btn btn-secondary" onclick="addVendor()"><i class="bi bi-plus-lg"></i> ì¶”ê°€</button>
                </div>
                <ul class="list-group" id="vendor_list_ui">
                    </ul>
            </div>

        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];

        // --- ì´ˆê¸°í™” ---
        window.onload = function() {
            const saved = localStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                showMain();
            }
        };

        // --- íƒ­ ì „í™˜ ---
        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            event.target.classList.add('active');
            
            // íƒ­ë³„ ì´ˆê¸°í™” ë™ì‘
            if(id === 'section-in') loadVendors(); // ì…ê³  íƒ­ ê°€ë©´ ê±°ë˜ì²˜ ìƒˆë¡œê³ ì¹¨
            if(id === 'section-vendor') loadVendorsToList(); // ê±°ë˜ì²˜ ê´€ë¦¬ íƒ­
            
            // ì¸í’‹ í¬ì»¤ìŠ¤
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        // --- ê¸°ëŠ¥ 1: ê±°ë˜ì²˜ ê´€ë¦¬ ---
        function loadVendors() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) })
            .then(r => r.json()).then(d => {
                const sel = document.getElementById('in_supplier');
                sel.innerHTML = "";
                d.list.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; opt.innerText = v;
                    sel.appendChild(opt);
                });
            });
        }
        function loadVendorsToList() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) })
            .then(r => r.json()).then(d => {
                const ul = document.getElementById('vendor_list_ui');
                ul.innerHTML = "";
                d.list.forEach(v => {
                    ul.innerHTML += `<li class="list-group-item">${v}</li>`;
                });
            });
        }
        function addVendor() {
            const name = document.getElementById('new_vendor_name').value;
            if(!name) return;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "add_vendor", name: name }) })
            .then(r => r.json()).then(d => {
                alert(d.message);
                document.getElementById('new_vendor_name').value = "";
                loadVendorsToList();
            });
        }

        // --- ê¸°ëŠ¥ 2: ì…ê³  (ë‹¨ê±´/ì¼ê´„) ---
        function toggleInMode() {
            const isBatch = document.getElementById('in_mode_toggle').checked;
            document.getElementById('in_mode_label').innerText = isBatch ? "ì—°ì† ì…ê³  (ëŒ€ê¸°ì—´)" : "ì¼ë°˜ ì…ê³  (ì¦‰ì‹œ)";
            document.getElementById('in_batch_area').style.display = isBatch ? 'block' : 'none';
            document.getElementById('in_scan').focus();
        }
        function handleInScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            if(!barcode) return;
            
            const isBatch = document.getElementById('in_mode_toggle').checked;
            const supplier = document.getElementById('in_supplier').value;
            const branch = document.getElementById('in_branch').value;
            
            e.target.disabled = true;
            
            const action = isBatch ? "scan_preview" : "register_single";
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: action, barcode: barcode, supplier: supplier, branch: branch, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    if(isBatch) {
                        inPendingList.push({ ...d.data, supplier: supplier }); // ë¦¬ìŠ¤íŠ¸ ì¶”ê°€
                        renderInList();
                        showMsg('in-msg', 'success', `ë¦¬ìŠ¤íŠ¸ ì¶”ê°€: ${d.data.model}`);
                    } else {
                        showMsg('in-msg', 'success', `âœ… ì…ê³  ì™„ë£Œ: ${d.data.model}`);
                    }
                } else {
                    showMsg('in-msg', 'error', d.message);
                }
            })
            .finally(() => {
                e.target.disabled = false; e.target.value = ""; e.target.focus();
            });
        }
        function renderInList() {
            const tbody = document.getElementById('in_tbody');
            tbody.innerHTML = "";
            inPendingList.forEach((item, idx) => {
                tbody.innerHTML += `<tr><td>${item.model}</td><td>${item.serial}</td><td><span class="text-danger" style="cursor:pointer" onclick="removeInItem(${idx})">X</span></td></tr>`;
            });
            document.getElementById('in_count').innerText = inPendingList.length;
            document.getElementById('btn_in_submit').disabled = inPendingList.length === 0;
        }
        function removeInItem(idx) { inPendingList.splice(idx, 1); renderInList(); }
        function clearInList() { inPendingList = []; renderInList(); }
        function submitInBatch() {
            if(!confirm(`${inPendingList.length}ëŒ€ë¥¼ ì…ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const branch = document.getElementById('in_branch').value;
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: "batch_register", items: inPendingList, branch: branch, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    alert(`${d.count}ëŒ€ ì…ê³  ì™„ë£Œ`);
                    clearInList();
                } else alert(d.message);
            });
        }

        // --- ê¸°ëŠ¥ 3: ì¬ê³  ì´ë™ ---
        function handleMoveScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            const toBranch = document.getElementById('move_to_branch').value;
            
            e.target.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: "transfer_stock", barcode: barcode, toBranch: toBranch, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                showMsg('move-msg', d.status === 'success' ? 'success' : 'error', d.message);
            })
            .finally(() => { e.target.disabled = false; e.target.value = ""; e.target.focus(); });
        }

        // --- ê¸°ëŠ¥ 4: ë°˜í’ˆ ì²˜ë¦¬ ---
        function handleOutScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            const note = document.getElementById('out_note').value;
            
            if(!note) { alert("ë°˜í’ˆ ì‚¬ìœ ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            
            e.target.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: "return_stock", barcode: barcode, note: note, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                showMsg('out-msg', d.status === 'success' ? 'success' : 'error', d.message);
            })
            .finally(() => { e.target.disabled = false; e.target.value = ""; e.target.focus(); });
        }

        // --- ê¸°ëŠ¥ 5: ì´ë ¥ ì¡°íšŒ ---
        function searchHistory() {
            const key = document.getElementById('hist_keyword').value;
            if(!key) return;
            const resDiv = document.getElementById('hist_result');
            resDiv.innerHTML = "<div class='text-center py-3'>ê²€ìƒ‰ì¤‘...</div>";
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_history", keyword: key }) })
            .then(r => r.json()).then(d => {
                if(d.list.length === 0) {
                    resDiv.innerHTML = "<div class='text-center py-3 text-muted'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
                    return;
                }
                let html = `<div class="list-group">`;
                d.list.forEach(h => {
                    let badge = 'bg-secondary';
                    if(h.type === 'ì…ê³ ') badge = 'bg-primary';
                    if(h.type === 'ì¬ê³ ì´ë™') badge = 'bg-info';
                    if(h.type === 'ë°˜í’ˆì²˜ë¦¬') badge = 'bg-danger';
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1"><span class="badge ${badge}">${h.type}</span> ${h.model}</h6>
                                <small class="text-muted">${h.time}</small>
                            </div>
                            <p class="mb-1 small">${h.desc}</p>
                            <small class="text-muted">S/N: ${h.serial} | ì‘ì—…ì: ${h.user}</small>
                        </div>
                    `;
                });
                html += `</div>`;
                resDiv.innerHTML = html;
            });
        }

        // --- ìœ í‹¸ ---
        function showMsg(id, type, text) {
            const el = document.getElementById(id);
            el.style.display = 'block';
            el.className = `alert py-2 text-center small fw-bold alert-${type === 'success' ? 'success' : 'danger'}`;
            el.innerText = text;
            setTimeout(() => { el.style.display = 'none'; }, 2000);
        }

        // --- ë¡œê·¸ì¸ ---
        function handleCredentialResponse(response) {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", token: response.credential }) })
            .then(r => r.json()).then(d => {
                if (d.status === 'success') {
                    localStorage.setItem('dbphone_user', JSON.stringify({ name: d.name, email: d.user }));
                    currentUser = d.name;
                    showMain();
                } else document.getElementById('login-msg').innerText = d.message;
            });
        }
        function showMain() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('main-view').style.display = 'block';
            document.getElementById('user-name').innerText = currentUser;
            loadVendors(); // ì´ˆê¸° ë¡œë”©
        }
        function logout() { localStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
