<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DBPhone Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { --primary-bg: #eef2f6; --card-bg: #ffffff; --accent-color: #4e73df; }
        body { background-color: var(--primary-bg); font-family: 'Noto Sans KR', sans-serif; color: #2e384d; }
        .glass-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: none; overflow: hidden; margin-bottom: 20px; }
        .section-view { display: none; }
        .active-section { display: block; animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-label-sm { font-size: 0.8rem; color: #6c757d; font-weight: 700; margin-bottom: 3px; }
        .form-control-sm, .form-select-sm { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
        .divider { border-top: 1px solid #dee2e6; margin: 25px 0 15px 0; }
        .section-header { font-size: 1rem; font-weight: 800; color: #4e73df; margin-bottom: 12px; display: flex; align-items: center; }
        .section-header i { margin-right: 6px; }
        
        /* â˜… ë¹¨ê°„ìƒ‰ ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .text-danger-input { color: #dc3545 !important; font-weight: bold; border-color: #dc3545; }
        .text-danger-input:focus { box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25); border-color: #dc3545; }

        /* â˜… [ìˆ˜ì •1] ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .stock-list-item { 
            padding: 12px; 
            border-bottom: 1px solid #eee; 
            font-size: 0.95rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stock-list-item:last-child { border-bottom: none; }
        /* [ìˆ˜ì •2] ì°¨ê°ì •ì±… ë“± íŠ¹ì´ì‚¬í•­(hasNote)ì´ ìˆìœ¼ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ */
        .stock-alert { color: #dc3545; font-weight: bold; background-color: #fff5f5; }
    </style>
</head>
<body>

    <div id="login-view" style="height: 100vh; background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
        <div class="glass-card p-5 text-center" style="width: 90%; max-width: 400px;">
            <h3 class="fw-bold mb-4 text-primary"><i class="bi bi-phone-vibrate"></i> DBPhone ERP</h3>
            <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large"></div>
            <div id="login-msg" class="text-danger mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <nav class="navbar navbar-expand-lg bg-white custom-navbar sticky-top shadow-sm p-2">
            <div class="container-fluid px-0">
                <span class="navbar-brand fw-bold text-primary"><i class="bi bi-grid-fill"></i> ëŒ€ë°•í†µì‹ </span>
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ“¦ ì¬ê³  ê´€ë¦¬</a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" onclick="showSection('section-in')">ì…ê³  ë“±ë¡</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-move')">ì¬ê³  ì´ë™</a></li>
                                <li><a class="dropdown-item text-danger" onclick="showSection('section-out')">ë°˜í’ˆ ì²˜ë¦¬</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="showSection('section-stock')">ğŸ” ì¬ê³  ì¡°íšŒ</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-history')">ğŸ“œ ì´ë ¥ ì¡°íšŒ</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary fw-bold" href="#" data-bs-toggle="dropdown">âœ… ê°œí†µ ì²˜ë¦¬</a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" onclick="showOpenSection('ë¬´ì„ ê°œí†µ')">ğŸ“± ë¬´ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showOpenSection('ìœ ì„ ê°œí†µ')">ğŸ“º ìœ ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showOpenSection('ì¤‘ê³ ê°œí†µ')">â™»ï¸ ì¤‘ê³  ê°œí†µ</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="d-flex align-items-center mt-2 mt-lg-0">
                        <span class="small me-3 fw-bold text-muted" id="user-name"></span>
                        <button onclick="logout()" class="btn btn-sm btn-outline-danger"><i class="bi bi-power"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container py-3">
            
            <div id="section-in" class="section-view active-section">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3 text-primary">ì…ê³  ë“±ë¡</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><label class="small fw-bold">ê±°ë˜ì²˜</label><select class="form-select" id="in_supplier"></select></div>
                        <div class="col-6"><label class="small fw-bold">ì§€ì </label><select class="form-select" id="in_branch"><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select></div>
                    </div>
                    <div class="mb-3"><input type="checkbox" id="in_mode_toggle"> <label for="in_mode_toggle" class="small">ì—°ì† ìŠ¤ìº” ëª¨ë“œ</label></div>
                    <input type="text" class="form-control text-center fw-bold mb-3" id="in_scan" placeholder="ë°”ì½”ë“œ ìŠ¤ìº”" onkeydown="handleInScan(event)">
                    <div id="in-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>
                    <div id="in_batch_area" style="display:none;" class="bg-light p-3 rounded">
                        <div class="d-flex justify-content-between mb-2"><span class="small fw-bold">ëŒ€ê¸° ëª©ë¡ <span id="in_count" class="badge bg-primary">0</span></span><button class="btn btn-sm btn-danger py-0" onclick="clearInList()">ë¹„ìš°ê¸°</button></div>
                        <div style="max-height:150px; overflow-y:auto;"><table class="table table-sm small"><tbody id="in_tbody"></tbody></table></div>
                        <button class="btn btn-primary w-100 mt-2 btn-sm" onclick="submitInBatch()">ì¼ê´„ ë“±ë¡</button>
                    </div>
                </div>
            </div>

            <div id="section-open" class="section-view">
                <div class="glass-card border-top border-4 border-primary">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary" id="open_title">ê°œí†µ ì²˜ë¦¬</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetOpenForm()">ì´ˆê¸°í™”</button>
                    </div>
                    
                    <div class="p-3">
                        <div id="open_step_1">
                            <div class="text-center p-4 bg-light rounded border mb-3">
                                <label class="text-muted small mb-2">ê°œí†µí•  ë‹¨ë§ê¸°ì˜ ì¼ë ¨ë²ˆí˜¸ë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</label>
                                <input type="text" class="form-control text-center fs-5 fw-bold" id="open_scan" onkeydown="handleOpenScan(event)" autocomplete="off">
                            </div>
                        </div>

                        <div id="open_step_2" style="display:none;">
                            <div class="alert alert-danger text-center fw-bold fs-5 mb-3" id="target_branch"></div>
                            
                            <div class="alert alert-primary py-2 small mb-4 d-flex align-items-center">
                                <i class="bi bi-phone me-2"></i>
                                <div><span id="target_model" class="fw-bold"></span> <span class="mx-1">|</span> <span id="target_serial"></span></div>
                            </div>

                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> ê¸°ë³¸ ì •ë³´</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm">ê°œí†µìœ í˜•</label><select class="form-select form-select-sm" id="f_act_type"><option value="" selected>ì„ íƒ</option><option>ì‹ ê·œ</option><option>ë²ˆí˜¸ì´ë™</option><option>ê¸°ê¸°ë³€ê²½</option></select></div>
                                <div class="col-4"><label class="form-label-sm">ì•½ì •ìœ í˜•</label><select class="form-select form-select-sm" id="f_cont_type"><option value="" selected>ì„ íƒ</option><option>ê³µì‹œì§€ì›</option><option>ì„ íƒì•½ì •</option></select></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë¬¸ê²½ë¡œ <span class="text-danger">*</span></label><select class="form-select form-select-sm" id="f_visit" onchange="checkVisitPath()"></select></div>
                                <div class="col-12" id="div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="f_visit_etc" placeholder="ìƒì„¸ ê²½ë¡œ"></div>
                                
                                <div class="col-4"><label class="form-label-sm">ê³ ê°ëª… <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm" id="f_name"></div>
                                <div class="col-4"><label class="form-label-sm">ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-control-sm" id="f_birth" placeholder="900101"></div>
                                <div class="col-4"><label class="form-label-sm">ì—°ë½ì²˜</label><input type="text" class="form-control form-control-sm" id="f_phone" placeholder="01012345678"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="f_plan"></div>
                                <div class="col-6"><label class="form-label-sm">ë³€ê²½ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="f_plan_chg"></div>
                                <div class="col-12"><label class="form-label-sm">ë¶€ê°€ì„œë¹„ìŠ¤</label><input type="text" class="form-control form-control-sm" id="f_addon"></div>
                                
                                <div class="col-4"><label class="form-label-sm">ì œíœ´ì¹´ë“œ</label><input type="text" class="form-control form-control-sm" id="f_card"></div>
                                <div class="col-4"><label class="form-label-sm">ë¦¬ë·°ì‘ì„± <span class="text-danger">*</span></label><select class="form-select form-select-sm" id="f_review"><option value="" selected>ì„ íƒ</option><option>ì‘ì„±</option><option>ë¯¸ì‘ì„±</option></select></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> ì •ì±… ë° ì •ì‚°</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê°œí†µì²˜</label><input type="text" class="form-control form-control-sm" id="f_avalue"></div>
                                <div class="col-6"><label class="form-label-sm">ì •ì±…ì°¨ìˆ˜</label><input type="text" class="form-control form-control-sm" id="f_policy"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ì•¡ë©´/íˆë“ </label><input type="number" class="form-control form-control-sm" id="f_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc1_m"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ì¶”ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="f_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc2_m"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ë¶€ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="f_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc3_m"></div>

                                <div class="col-6"><label class="form-label-sm text-danger">ì°¨ê°ì •ì±…</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_cost1"></div>
                                <div class="col-6"><label class="form-label-sm text-danger">ë©”ëª¨</label><input type="text" class="form-control form-control-sm text-danger-input" id="f_cost1_m"></div>
                                
                                <div class="col-6"><label class="form-label-sm text-danger">í”„ë¦¬í• ì¸</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_cost2"></div>
                                <div class="col-6"><label class="form-label-sm">ìœ ì‹¬</label><select class="form-select form-select-sm" id="f_usim"></select></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> ëŒ€ë‚© ë° ì§€ì›</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger">ëŒ€ë‚©1</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_pay1_m"><option value="" selected>ì„ íƒ</option><option>ì±„ê¶Œ</option><option>ë²•ì¸ì¹´ë“œ</option></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="f_pay1_d"></div>

                                <div class="col-4"><label class="form-label-sm text-danger">ëŒ€ë‚©2</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_pay2_m"><option value="" selected>ì„ íƒ</option><option>ì±„ê¶Œ</option><option>ë²•ì¸ì¹´ë“œ</option></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="f_pay2_d"></div>

                                <div class="col-6"><label class="form-label-sm text-danger">í˜„ê¸ˆì§€ê¸‰</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger">í˜ì´ë°±</label><input type="number" class="form-control form-control-sm text-danger-input" id="f_back"></div>
                                
                                <div class="col-4"><label class="form-label-sm">ì€í–‰ëª…</label><input type="text" class="form-control form-control-sm" id="f_bank"></div>
                                <div class="col-4"><label class="form-label-sm">ê³„ì¢Œë²ˆí˜¸</label><input type="text" class="form-control form-control-sm" id="f_acc"></div>
                                <div class="col-4"><label class="form-label-sm">ì˜ˆê¸ˆì£¼</label><input type="text" class="form-control form-control-sm" id="f_holder"></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> ìˆ˜ë‚© ìƒì„¸</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ë‹¨ë§ê¸°ìˆ˜ë‚©1</label><input type="number" class="form-control form-control-sm" id="f_inc4"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc4_m"><option value="" selected>ì„ íƒ</option><option>í˜„ê¸ˆ</option><option>ê³„ì¢Œ</option><option>ì¹´ë“œ</option></select></div>
                                
                                <div class="col-6"><label class="form-label-sm">ë‹¨ë§ê¸°ìˆ˜ë‚©2</label><input type="number" class="form-control form-control-sm" id="f_inc4_2"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc4_2_m"><option value="" selected>ì„ íƒ</option><option>í˜„ê¸ˆ</option><option>ê³„ì¢Œ</option><option>ì¹´ë“œ</option></select></div>
                                
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆìˆ˜ë‚©</label><input type="number" class="form-control form-control-sm" id="f_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc5_m"><option value="" selected>ì„ íƒ</option><option>í˜„ê¸ˆ</option><option>ê³„ì¢Œ</option><option>ì¹´ë“œ</option></select></div>
                                
                                <div class="col-6"><label class="form-label-sm">ì¤‘ê³ í°</label><input type="number" class="form-control form-control-sm" id="f_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc6_m"></div>
                                
                                <div class="col-12"><label class="form-label-sm">ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</label><input type="text" class="form-control form-control-sm" id="f_comment"></div>
                            </div>

                            <div class="mt-4 pb-4">
                                <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="submitFullContract()">
                                    <i class="bi bi-save-fill"></i> ê°œí†µ ë° ì €ì¥ ì™„ë£Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-stock" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-search"></i> ì¬ê³  ì¡°íšŒ (ë³´ìœ ë¶„)</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4">
                            <select class="form-select fw-bold" id="search_criteria" onchange="updateSearchUI()">
                                <option value="supplier">ê±°ë˜ì²˜ë³„</option>
                                <option value="branch">ì§€ì ë³„</option>
                                <option value="model">ëª¨ë¸ë³„</option>
                                <option value="serial">ì¼ë ¨ë²ˆí˜¸/ë°”ì½”ë“œ</option>
                            </select>
                        </div>
                        <div class="col-8" id="search_input_area"><select class="form-select" id="search_value_supplier"></select></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-3 mb-3" onclick="searchStock()">ì¡°íšŒí•˜ê¸°</button>
                    <div id="stock_result"></div>
                </div>
            </div>

            <div id="section-history" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> ì´ë ¥ ì¡°íšŒ (ë¡œê·¸)</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="hist_keyword" placeholder="ì¼ë ¨ë²ˆí˜¸ ë˜ëŠ” ë°”ì½”ë“œ (ì •í™•íˆ ì…ë ¥)" onkeydown="if(event.key==='Enter') searchHistory()">
                        <button class="btn btn-outline-secondary" onclick="searchHistory()">ê²€ìƒ‰</button>
                    </div>
                    <div id="hist_result"></div>
                </div>
            </div>

            <div id="section-move" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">ì¬ê³  ì´ë™</h5>
                    <select class="form-select bg-light fw-bold py-3 mb-3" id="move_to_branch"><option value="ëª…ì¼ ì§ì˜ì ">ğŸ‘‰ ëª…ì¼ ì§ì˜ì ìœ¼ë¡œ ë³´ëƒ„</option><option value="ì¥ì§€ ë³¸ì ">ğŸ‘‰ ì¥ì§€ ë³¸ì ìœ¼ë¡œ ë³´ëƒ„</option></select>
                    <div class="scan-wrapper my-4"><input type="text" class="form-control scan-input" id="move_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleMoveScan(event)" autocomplete="off"></div>
                    <div id="move-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-out" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-danger">
                    <h5 class="fw-bold mb-4 text-danger">ë°˜í’ˆ ì²˜ë¦¬</h5>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="out_note" placeholder="ì‚¬ìœ "><label>ë°˜í’ˆ ì‚¬ìœ  / ë©”ëª¨ (í•„ìˆ˜)</label></div>
                    <div class="scan-wrapper bg-danger bg-opacity-75 my-4" style="background-color: #d63031;"><input type="text" class="form-control scan-input border-danger" id="out_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleOutScan(event)" autocomplete="off"></div>
                    <div id="out-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-vendor" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3">ê±°ë˜ì²˜ ë“±ë¡</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_name" placeholder="ê±°ë˜ì²˜ëª… (í•„ìˆ˜)"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_sales" placeholder="ì˜ì—…ì‚¬ì›"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_phone" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_office" placeholder="ê°œí†µì‹¤ ì „í™”ë²ˆí˜¸"></div>
                    </div>
                    <button class="btn btn-secondary w-100 fw-bold rounded-3" onclick="addVendor()">ë“±ë¡í•˜ê¸°</button>
                </div>
                <div class="glass-card p-0">
                    <div class="p-3 border-bottom bg-light"><h6 class="mb-0 fw-bold">ë“±ë¡ëœ ê±°ë˜ì²˜</h6></div>
                    <div id="vendor_list_ui" class="list-group list-group-flush"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="vendorEditModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">ê±°ë˜ì²˜ ìˆ˜ì •</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit_v_old_name">
                    <div class="mb-2"><label class="small text-muted">ê±°ë˜ì²˜ëª…</label><input type="text" class="form-control" id="edit_v_name"></div>
                    <div class="row g-2 mb-2"><div class="col-6"><label class="small text-muted">ì˜ì—…ì‚¬ì›</label><input type="text" class="form-control" id="edit_v_sales"></div><div class="col-6"><label class="small text-muted">ì—°ë½ì²˜</label><input type="text" class="form-control" id="edit_v_phone"></div></div>
                    <div class="mb-2"><label class="small text-muted">ê°œí†µì‹¤</label><input type="text" class="form-control" id="edit_v_office"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button><button class="btn btn-primary" onclick="submitEditVendor()">ì €ì¥</button></div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];
        let globalVendorList = [];
        let globalModelList = [];
        let currentOpenType = "";
        let logoutTimer;
        let tempOpenStockData = null;

        window.onload = function() {
            const saved = sessionStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
                document.getElementById('user-name').innerText = currentUser;
                loadInitData();
                setupAutoLogout();
            }
            document.querySelectorAll('.enter-trigger').forEach(input => {
                input.addEventListener('keydown', function(e) { if(e.key === 'Enter') addVendor(); });
            });
        };

        function setupAutoLogout() {
            resetLogoutTimer();
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, resetLogoutTimer));
        }
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if(currentUser) {
                logoutTimer = setTimeout(() => { alert("10ë¶„ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìë™ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); logout(); }, 600000);
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section', 'fade-in'));
            document.getElementById(id).classList.add('active-section', 'fade-in');
            if(id === 'section-in') loadInitData();
            if(id === 'section-vendor') loadVendorsToList();
            if(id === 'section-stock') updateSearchUI();
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        function showOpenSection(type) {
            currentOpenType = type;
            document.getElementById('open_title').innerText = type + " ì²˜ë¦¬";
            resetOpenForm();
            loadDropdownData(); 
            showSection('section-open');
        }

        function loadInitData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => {
                globalVendorList = d.list.map(v => v.name);
                const sel = document.getElementById('in_supplier'); sel.innerHTML = "";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                if(document.getElementById('search_criteria').value === 'supplier') updateSearchUI();
            });
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_models" }) }).then(r => r.json()).then(d => globalModelList = d.list);
        }

        function loadDropdownData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_dropdown_data" }) })
            .then(r => r.json())
            .then(d => {
                const selVisit = document.getElementById('f_visit');
                selVisit.innerHTML = '<option value="" selected>ì„ íƒ</option>';
                d.visitList.forEach(item => { selVisit.innerHTML += `<option value="${item}">${item}</option>`; });
                selVisit.innerHTML += '<option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>';
                
                const selUsim = document.getElementById('f_usim');
                selUsim.innerHTML = '<option value="" selected>ì„ íƒ</option>';
                d.usimList.forEach(item => { selUsim.innerHTML += `<option value="${item}">${item}</option>`; });
            });
        }

        function checkVisitPath() {
            const val = document.getElementById('f_visit').value;
            if(val === 'ê¸°íƒ€') document.getElementById('div_visit_etc').style.display = 'block';
            else document.getElementById('div_visit_etc').style.display = 'none';
        }

        function handleOpenScan(e) { 
            if(e.key!=='Enter')return; 
            const v=e.target.value.trim(); 
            e.target.disabled=true; 
            fetch(GAS_URL,{method:"POST",body:JSON.stringify({ action:"get_stock_info_for_open", input:v })})
            .then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    tempOpenStockData = d.data; 
                    tempOpenStockData.inputCode = v; 
                    document.getElementById('target_model').innerText = d.data.model; 
                    document.getElementById('target_serial').innerText = d.data.serial;
                    document.getElementById('target_branch').innerText = d.data.branch || "ì§€ì ë¯¸ìƒ"; 
                    document.getElementById('f_avalue').value = d.data.supplier || ""; 
                    document.getElementById('open_step_1').style.display = 'none';
                    document.getElementById('open_step_2').style.display = 'block';
                    document.getElementById('f_name').focus();
                } else {
                    alert(d.message); 
                    e.target.disabled=false; e.target.value=""; e.target.focus();
                }
            });
        }

        function submitFullContract() {
            if(!tempOpenStockData) return;
            
            // [ìˆ˜ì •3] í•„ìˆ˜ê°’ ì²´í¬ í›„ focus() ì´ë™
            const custName = document.getElementById('f_name').value;
            if(!custName) { alert("ê³ ê°ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); document.getElementById('f_name').focus(); return; }
            
            const reviewVal = document.getElementById('f_review').value;
            if(!reviewVal) { alert("ë¦¬ë·°ì‘ì„±ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); document.getElementById('f_review').focus(); return; }
            
            const visitValSelect = document.getElementById('f_visit').value;
            if(!visitValSelect) { alert("ë°©ë¬¸ê²½ë¡œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); document.getElementById('f_visit').focus(); return; }

            let visitVal = visitValSelect;
            if(visitVal === 'ê¸°íƒ€') visitVal = "ê¸°íƒ€: " + document.getElementById('f_visit_etc').value;

            const formData = {
                action: "open_stock_full",
                stockInput: tempOpenStockData.inputCode,
                user: currentUser,
                
                activationType: document.getElementById('f_act_type').value,
                contractType: document.getElementById('f_cont_type').value,
                name: custName,
                birth: document.getElementById('f_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('f_phone').value,
                pricePlan: document.getElementById('f_plan').value,
                changePlan: document.getElementById('f_plan_chg').value,
                addon: document.getElementById('f_addon').value,
                usim: document.getElementById('f_usim').value,
                card: document.getElementById('f_card').value,
                review: reviewVal,
                
                aValue: document.getElementById('f_avalue').value,
                policy: document.getElementById('f_policy').value,
                income1: document.getElementById('f_inc1').value,
                income1Memo: document.getElementById('f_inc1_m').value,
                income2: document.getElementById('f_inc2').value,
                income2Memo: document.getElementById('f_inc2_m').value,
                income3: document.getElementById('f_inc3').value,
                income3Memo: document.getElementById('f_inc3_m').value,
                cost1: document.getElementById('f_cost1').value,
                cost1Memo: document.getElementById('f_cost1_m').value,
                cost2: document.getElementById('f_cost2').value,
                
                payment1: document.getElementById('f_pay1').value,
                payment1Method: document.getElementById('f_pay1_m').value,
                payment1Date: document.getElementById('f_pay1_d').value,
                payment2: document.getElementById('f_pay2').value,
                payment2Method: document.getElementById('f_pay2_m').value,
                payment2Date: document.getElementById('f_pay2_d').value,
                
                cash: document.getElementById('f_cash').value,
                payback1: document.getElementById('f_back').value,
                bankName: document.getElementById('f_bank').value,
                accountNumber: document.getElementById('f_acc').value,
                depositor: document.getElementById('f_holder').value,
                
                income4_1: document.getElementById('f_inc4').value,
                income4_1Method: document.getElementById('f_inc4_m').value,
                income4_2: document.getElementById('f_inc4_2').value,
                income4_2Method: document.getElementById('f_inc4_2_m').value,
                income5: document.getElementById('f_inc5').value,
                income5Method: document.getElementById('f_inc5_m').value,
                income6: document.getElementById('f_inc6').value,
                income6Memo: document.getElementById('f_inc6_m').value,
                
                comment: document.getElementById('f_comment').value
            };

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...`;
            btn.disabled = true;

            // [ìˆ˜ì •4] í†µì‹  ì˜¤ë¥˜ í•¸ë“¤ë§ ê°•í™”
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    alert(d.message);
                    resetOpenForm();
                } else {
                    alert("ì˜¤ë¥˜: " + d.message);
                }
            })
            .catch(e => {
                console.error(e);
                alert("ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜, ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ì§€ì†ë  ê²½ìš° ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜)");
            })
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function resetOpenForm() {
            document.getElementById('open_step_1').style.display = 'block';
            document.getElementById('open_step_2').style.display = 'none';
            document.getElementById('open_scan').value = "";
            document.getElementById('open_scan').disabled = false;
            document.getElementById('open_scan').focus();
            document.querySelectorAll('#open_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#open_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('div_visit_etc').style.display='none';
            tempOpenStockData = null;
        }

        function updateSearchUI() {
            const criteria = document.getElementById('search_criteria').value;
            const area = document.getElementById('search_input_area');
            area.innerHTML = "";
            if(criteria === 'supplier') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'branch') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                ["ì¥ì§€ ë³¸ì ", "ëª…ì¼ ì§ì˜ì "].forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'model') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalModelList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else {
                const inp = document.createElement('input'); inp.className = "form-control"; inp.id = "search_value"; inp.placeholder = "ì…ë ¥í•˜ì„¸ìš”";
                inp.onkeydown = function(e){ if(e.key==='Enter') searchStock(); };
                area.appendChild(inp); inp.focus();
            }
        }

        // [ìˆ˜ì •1] ì¡°íšŒ ê²°ê³¼ í…Œì´ë¸” -> ë¦¬ìŠ¤íŠ¸ë¡œ ë³€ê²½
        function searchStock() {
            const crit = document.getElementById('search_criteria').value;
            const val = document.getElementById('search_value').value;
            const div = document.getElementById('stock_result');
            div.innerHTML = `<div class="text-center py-4"><span class="spinner-border text-primary"></span></div>`;
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_stock", criteria: crit, keyword: val }) })
            .then(r => r.json()).then(d => {
                if(!d.list || d.list.length === 0) { div.innerHTML = `<div class="text-center text-muted py-5">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                
                let html = '<ul class="list-group list-group-flush">';
                d.list.forEach(item => {
                    // [ìˆ˜ì •2] hasNote(ì°¨ê° ë“±)ê°€ ìˆìœ¼ë©´ ë¹¨ê°„ ìŠ¤íƒ€ì¼, í•˜ì§€ë§Œ ë©”ëª¨ í…ìŠ¤íŠ¸ëŠ” ì¶œë ¥ ì•ˆ í•¨
                    let alertClass = item.hasNote ? 'stock-alert' : '';
                    
                    html += `
                    <li class="stock-list-item ${alertClass}">
                        <div>
                            <span class="fw-bold">${item.model}</span>
                            <span class="mx-2 text-muted">|</span>
                            <span class="font-monospace">${item.serial}</span>
                            <span class="mx-2 text-muted">|</span>
                            <span class="small text-secondary">${item.branch}</span>
                        </div>
                    </li>`;
                });
                html += '</ul>';
                html += `<div class="text-end small text-muted mt-2">ì´ ${d.list.length}ê±´</div>`;
                div.innerHTML = html;
            });
        }

        function searchHistory() { const k=document.getElementById('hist_keyword').value; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"search_history",keyword:k})}).then(r=>r.json()).then(d=>{ let h=""; d.list.forEach(i=>h+=`<div class='glass-card p-2 mb-2'><span class='badge bg-secondary'>${i.type}</span> ${i.model} (${i.time})</div>`); document.getElementById('hist_result').innerHTML=h; }); }
        
        function handleInScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(inPendingList.some(i=>i.barcode===v)){showMsg('in-msg','error','ì´ë¯¸ ëª©ë¡ì— ìˆìŒ');e.target.value="";return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:document.getElementById('in_mode_toggle').checked?"scan_preview":"register_single",barcode:v,supplier:document.getElementById('in_supplier').value,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){if(document.getElementById('in_mode_toggle').checked){inPendingList.push({...d.data,supplier:document.getElementById('in_supplier').value});renderInList();showMsg('in-msg','success',`ì¶”ê°€: ${d.data.model}`);}else showMsg('in-msg','success',`ì…ê³ : ${d.data.model}`);}else showMsg('in-msg','error',d.message);}).finally(()=>{e.target.value="";e.target.focus();}); }
        function renderInList() { const t=document.getElementById('in_tbody'); t.innerHTML=""; inPendingList.forEach((i,x)=>t.innerHTML+=`<tr><td>${i.model}</td><td>${i.serial}</td><td><button onclick="inPendingList.splice(${x},1);renderInList()">X</button></td></tr>`); document.getElementById('in_count').innerText=inPendingList.length; }
        function clearInList() { inPendingList=[]; renderInList(); }
        function submitInBatch() { if(!inPendingList.length)return; if(!confirm("ì…ê³ ?"))return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"batch_register",items:inPendingList,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert(d.count+"ëŒ€ ì…ê³ ì™„ë£Œ");clearInList();}else alert(d.message);}); }
        function handleMoveScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"transfer_stock",input:v,toBranch:document.getElementById('move_to_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('move-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function handleOutScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(!document.getElementById('out_note').value){alert("ì‚¬ìœ í•„ìˆ˜");return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"return_stock",input:v,note:document.getElementById('out_note').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('out-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function loadVendorsToList() { fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => { const div = document.getElementById('vendor_list_ui'); div.innerHTML = ""; d.list.forEach(v => { div.innerHTML += `<div class="list-group-item p-2">${v.name} <button class="btn btn-sm btn-outline-danger float-end" onclick="deleteVendor('${v.name}')">ì‚­ì œ</button></div>`; }); }); }
        function addVendor() { const n=document.getElementById('v_name').value; if(!n)return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"add_vendor",name:n,salesName:document.getElementById('v_sales').value,salesPhone:document.getElementById('v_phone').value,officePhone:document.getElementById('v_office').value})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        function deleteVendor(n) { if(confirm("ì‚­ì œ?")) fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"delete_vendor",name:n})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        
        function showMsg(id, type, text) { const el=document.getElementById(id); el.style.display='block'; el.className=`alert py-2 text-center small fw-bold rounded-3 alert-${type==='success'?'success':'danger'}`; el.innerText=text; setTimeout(()=>el.style.display='none',2000); }
        function handleCredentialResponse(r) { fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"login",token:r.credential})}).then(res=>res.json()).then(d=>{ if(d.status==='success') { sessionStorage.setItem('dbphone_user',JSON.stringify({name:d.name,email:d.user})); currentUser=d.name; document.getElementById('login-view').style.display='none'; document.getElementById('main-view').style.display='block'; document.getElementById('user-name').innerText=currentUser; loadInitData(); setupAutoLogout(); } else document.getElementById('login-msg').innerText=d.message; }); }
        function logout() { sessionStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
