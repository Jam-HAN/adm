<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ë°•í†µì‹  ê´€ë¦¬ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        #dashboard-view { display: none; }
        input, select { font-size: 16px !important; }
        .scan-area {
            background-color: #212529; color: white; padding: 15px; border-radius: 10px; text-align: center;
        }
        .scan-input {
            background-color: #495057; color: #00ff00; border: 2px solid #6c757d; 
            font-weight: bold; text-align: center; font-size: 1.2rem; letter-spacing: 1px;
        }
        .scan-input:focus { background-color: #000; color: #00ff00; border-color: #00ff00; }
        .mode-switch-container { display: flex; align-items: center; justify-content: flex-end; }
        .form-check-input:checked { background-color: #198754; border-color: #198754; }
        .pending-list-container {
            max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; background: white;
        }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div id="login-view" class="text-center">
            <h1 class="mb-4">DBPhone Manager</h1>
            <div class="card p-5 mx-auto" style="max-width: 400px;">
                <p class="mb-3">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
                <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
                <div class="g_id_signin" data-type="standard"></div>
                <div id="login-msg" class="text-danger mt-3"></div>
            </div>
        </div>

        <div id="dashboard-view">
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4 rounded">
                <div class="container-fluid">
                    <a class="navbar-brand fw-bold" href="#">ëŒ€ë°•í†µì‹  ê´€ë¦¬ì</a>
                    <span class="navbar-text">
                        <strong id="user-name">ì§ì›</strong>ë‹˜
                        <button onclick="logout()" class="btn btn-sm btn-outline-secondary ms-2">ë¡œê·¸ì•„ì›ƒ</button>
                    </span>
                </div>
            </nav>
            <div class="row">
                <div class="col-12">
                     <button class="btn btn-lg btn-primary w-100 p-4 shadow-sm fw-bold" onclick="openModal()">
                        ğŸ“¦ ì…ê³  ìŠ¤ìºë„ˆ ì—´ê¸°
                     </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invenModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-light">
              <h5 class="modal-title">ì…ê³  ì‹œìŠ¤í…œ</h5>
              <div class="mode-switch-container ms-auto">
                  <span class="small me-2 text-muted fw-bold" id="mode-label">ì¼ë°˜ ì…ê³ </span>
                  <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="mode_toggle" onchange="toggleMode()">
                  </div>
              </div>
              <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" onclick="clearList()"></button>
            </div>
            <div class="modal-body">
              <div class="row g-2 mb-3">
                  <div class="col-6">
                      <input type="text" class="form-control" id="in_supplier" placeholder="ê±°ë˜ì²˜ (ì˜ˆ: SK)" list="supplierOptions">
                      <datalist id="supplierOptions"><option value="SKë„¤íŠ¸ì›ìŠ¤"><option value="ì‚¼ì„±ì „ì"><option value="ì• í”Œì½”ë¦¬ì•„"><option value="ëŒ€ë¦¬ì "><option value="ì¤‘ê³ ë§¤ì…"></datalist>
                  </div>
                  <div class="col-6">
                      <select class="form-select" id="in_branch"><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select>
                  </div>
              </div>
              <div class="scan-area mb-3">
                  <label class="small text-white-50 mb-1" id="scan-guide">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤</label>
                  <input type="text" class="form-control scan-input" id="scan_input" placeholder="ìŠ¤ìº” ëŒ€ê¸°ì¤‘..." onkeydown="handleScan(event)" autocomplete="off">
                  <div id="loading-msg" class="text-warning small mt-2" style="display:none">ì²˜ë¦¬ ì¤‘...</div>
              </div>
              <div id="msg-area" class="alert py-2 small mb-2 text-center fw-bold" style="display:none"></div>
              <div id="batch-list-area" style="display:none;">
                  <h6 class="fw-bold mt-3 mb-2">ì…ê³  ëŒ€ê¸° ëª©ë¡ <span class="badge bg-primary" id="list-count">0</span></h6>
                  <div class="pending-list-container">
                      <table class="table table-striped table-hover mb-0 text-center small">
                          <thead class="table-light sticky-top"><tr><th>ê±°ë˜ì²˜</th><th>ëª¨ë¸ëª…</th><th>ìƒ‰ìƒ</th><th>ì¼ë ¨ë²ˆí˜¸</th><th>ì‚­ì œ</th></tr></thead>
                          <tbody id="pending-tbody"></tbody>
                      </table>
                  </div>
              </div>
            </div>
            <div class="modal-footer" id="modal-footer" style="display:none;">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearList()">ì·¨ì†Œ</button>
              <button type="button" class="btn btn-success fw-bold px-4" id="btn-submit" onclick="submitBatch()" disabled>ì´ <span id="submit-count">0</span>ëŒ€ ì¼ê´„ ì €ì¥</button>
            </div>
          </div>
        </div>
      </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // â˜… URL ìˆ˜ì • í•„ìˆ˜
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let pendingItems = [];

        window.onload = function() {
            const savedUser = localStorage.getItem('dbphone_user');
            if (savedUser) showDashboard(JSON.parse(savedUser).name);
        };
        function handleCredentialResponse(response) {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", token: response.credential }) })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    localStorage.setItem('dbphone_user', JSON.stringify({ name: data.name, email: data.user }));
                    showDashboard(data.name);
                } else alert(data.message);
            });
        }
        function showDashboard(name) {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('user-name').innerText = name;
        }
        function logout() { localStorage.removeItem('dbphone_user'); location.reload(); }
        function openModal() {
            const modal = new bootstrap.Modal(document.getElementById('invenModal'));
            modal.show();
            toggleMode();
        }

        function toggleMode() {
            const isBatch = document.getElementById('mode_toggle').checked;
            const label = document.getElementById('mode-label');
            const guide = document.getElementById('scan-guide');
            const listArea = document.getElementById('batch-list-area');
            const footer = document.getElementById('modal-footer');
            const scanInput = document.getElementById('scan_input');

            if (isBatch) {
                label.innerText = "ì—°ì† ì…ê³  (ëŒ€ê¸°ì—´)"; label.className = "small me-2 text-success fw-bold";
                guide.innerText = "ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì•„ë˜ ëª©ë¡ì— ìŒ“ì…ë‹ˆë‹¤ (ë§ˆì§€ë§‰ì— ì €ì¥)";
                listArea.style.display = 'block'; footer.style.display = 'flex'; scanInput.placeholder = "ì—°ì† ìŠ¤ìº” ëª¨ë“œ ON";
            } else {
                label.innerText = "ì¼ë°˜ ì…ê³  (ì¦‰ì‹œ ì €ì¥)"; label.className = "small me-2 text-secondary fw-bold";
                guide.innerText = "ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì¦‰ì‹œ ì €ì¥ë˜ê³  ì°½ì´ ë‹«í™ë‹ˆë‹¤";
                listArea.style.display = 'none'; footer.style.display = 'none'; scanInput.placeholder = "ìŠ¤ìº” ì¦‰ì‹œ ì €ì¥ë¨";
            }
            scanInput.focus();
        }

        function handleScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = event.target.value.trim();
                const supplier = document.getElementById('in_supplier').value;
                const branch = document.getElementById('in_branch').value;
                const isBatch = document.getElementById('mode_toggle').checked;

                if (!barcode) return;
                
                if (isBatch && pendingItems.some(item => item.barcode === barcode)) {
                    showMessage("error", "âš ï¸ ì´ë¯¸ ëª©ë¡ì— ìˆëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.");
                    event.target.value = ""; return;
                }

                document.getElementById('scan_input').disabled = true;
                document.getElementById('loading-msg').style.display = 'block';
                document.getElementById('msg-area').style.display = 'none';

                const actionType = isBatch ? "scan_preview" : "register_single";
                
                fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify({ action: actionType, barcode: barcode, supplier: supplier, branch: branch })
                })
                .then(res => res.text()) // 1. ì¼ë‹¨ í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ (ì—ëŸ¬ ë””ë²„ê¹…ìš©)
                .then(text => {
                    let data;
                    try {
                        data = JSON.parse(text); // 2. JSON íŒŒì‹± ì‹œë„
                    } catch (e) {
                        throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (HTML ë°˜í™˜ë¨): " + text.substring(0, 50));
                    }

                    if (data.status === 'success') {
                        if (isBatch) {
                            const newItem = { ...data.data, supplier: supplier }; 
                            addItemToList(newItem);
                            showMessage("success", "ë¦¬ìŠ¤íŠ¸ ì¶”ê°€: " + data.data.model);
                        } else {
                            // [ì¼ë°˜ ëª¨ë“œ] ì„±ê³µ ì‹œ ì•Œë¦¼ í›„ ë‹«ê¸°
                            alert("âœ… ì…ê³  ì™„ë£Œ! (" + data.data.model + ")");
                            bootstrap.Modal.getInstance(document.getElementById('invenModal')).hide();
                        }
                    } else {
                        showMessage("error", "â›” " + data.message);
                        // ì‹¤íŒ¨ ì†Œë¦¬ ì¬ìƒ (ì˜µì…˜)
                    }
                })
                .catch(err => {
                    showMessage("error", err.message);
                })
                .finally(() => {
                    const input = document.getElementById('scan_input');
                    input.disabled = false; input.value = ""; input.focus();
                    document.getElementById('loading-msg').style.display = 'none';
                });
            }
        }

        function showMessage(type, text) {
            const el = document.getElementById('msg-area');
            el.style.display = 'block';
            el.className = type === 'success' ? "alert alert-success py-2 small mb-2 text-center fw-bold" : "alert alert-danger py-2 small mb-2 text-center fw-bold";
            el.innerText = text;
        }

        function addItemToList(item) {
            pendingItems.push(item); renderList();
        }
        function removeItem(index) {
            pendingItems.splice(index, 1); renderList(); document.getElementById('scan_input').focus();
        }
        function renderList() {
            const tbody = document.getElementById('pending-tbody');
            tbody.innerHTML = "";
            pendingItems.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.supplier}</td><td class="fw-bold">${item.model}</td><td>${item.color}</td><td class="font-monospace">${item.serial}</td><td><span class="delete-btn" onclick="removeItem(${index})">X</span></td>`;
                tbody.prepend(tr);
            });
            const count = pendingItems.length;
            document.getElementById('list-count').innerText = count;
            document.getElementById('submit-count').innerText = count;
            document.getElementById('btn-submit').disabled = count === 0;
        }
        function clearList() {
            if(pendingItems.length > 0) pendingItems = [];
            renderList();
        }

        function submitBatch() {
            const branch = document.getElementById('in_branch').value;
            if (pendingItems.length === 0) return;
            if (!confirm(`ì´ ${pendingItems.length}ëŒ€ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            const btn = document.getElementById('btn-submit');
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({ action: "batch_register", items: pendingItems, branch: branch })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`âœ… ${data.count}ëŒ€ ì…ê³  ì™„ë£Œ!`);
                    clearList();
                    bootstrap.Modal.getInstance(document.getElementById('invenModal')).hide();
                } else {
                    alert("ì˜¤ë¥˜: " + data.message);
                }
            })
            .catch(() => alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"))
            .finally(() => {
                btn.innerHTML = `ì´ <span id="submit-count">0</span>ëŒ€ ì¼ê´„ ì €ì¥`; btn.disabled = true;
            });
        }
        document.getElementById('invenModal').addEventListener('shown.bs.modal', () => { document.getElementById('scan_input').focus(); });
    </script>
</body>
</html>
