<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DBPhone Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #eef2f6;
            --card-bg: #ffffff;
            --accent-color: #4e73df;
            --accent-gradient: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            --text-dark: #2e384d;
            --shadow-soft: 0 4px 20px rgba(0,0,0,0.05);
        }

        body {
            background-color: var(--primary-bg);
            font-family: 'Noto Sans KR', sans-serif;
            color: var(--text-dark);
            -webkit-font-smoothing: antialiased;
        }

        /* ê³µí†µ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .glass-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-soft);
            border: none;
            overflow: hidden;
            margin-bottom: 20px;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-view {
            height: 100vh;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .custom-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .nav-pills .nav-link {
            color: #8795a1;
            font-weight: 500;
            border-radius: 12px;
            padding: 10px 16px;
            transition: all 0.2s;
        }
        .nav-pills .nav-link.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 4px 10px rgba(78, 115, 223, 0.3);
        }

        /* ìŠ¤ìº” ì˜ì—­ */
        .scan-wrapper {
            background: #2d3436;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(45, 52, 54, 0.3);
        }
        .scan-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #00ff9d;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .scan-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #00ff9d;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
            color: #00ff9d;
        }

        /* í¼ ìš”ì†Œ */
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e0e6ed;
            padding: 12px;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-view { display: none; }
        .active-section { display: block; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="glass-card p-5 text-center" style="width: 90%; max-width: 400px;">
            <div class="mb-4">
                <i class="bi bi-phone-vibrate text-primary" style="font-size: 3rem;"></i>
            </div>
            <h3 class="fw-bold mb-1">DBPhone ERP</h3>
            <p class="text-muted small mb-4">ëŒ€ë°•í†µì‹  ê´€ë¦¬ì ì‹œìŠ¤í…œ</p>
            
            <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_blue" data-text="signin_with" data-size="large" data-logo_alignment="left"></div>
            <div id="login-msg" class="text-danger mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        
        <nav class="navbar custom-navbar sticky-top px-3 py-3">
            <div class="d-flex align-items-center w-100 justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                        <i class="bi bi-grid-fill"></i>
                    </div>
                    <span class="fw-bold fs-5">ëŒ€ë°•í†µì‹ </span>
                </div>
                <div>
                    <span class="small text-muted me-2"><strong id="user-name">ê´€ë¦¬ì</strong>ë‹˜</span>
                    <button onclick="logout()" class="btn btn-sm btn-light rounded-pill border"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
            <div class="w-100 mt-3 overflow-auto">
                <ul class="nav nav-pills flex-nowrap pb-1">
                    <li class="nav-item"><a class="nav-link active" onclick="showSection('section-in')"><i class="bi bi-box-seam me-1"></i>ì…ê³ </a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-move')"><i class="bi bi-truck me-1"></i>ì´ë™</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-out')"><i class="bi bi-arrow-return-left me-1"></i>ë°˜í’ˆ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-history')"><i class="bi bi-search me-1"></i>ì¡°íšŒ</a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('section-vendor')"><i class="bi bi-buildings me-1"></i>ê±°ë˜ì²˜</a></li>
                </ul>
            </div>
        </nav>

        <div class="container py-4">
            
            <div id="section-in" class="section-view active-section fade-in">
                <div class="glass-card p-4">
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <label class="small text-muted mb-1 fw-bold">ì…ê³  ê±°ë˜ì²˜</label>
                            <select class="form-select fw-bold" id="in_supplier"></select>
                        </div>
                        <div class="col-6">
                            <label class="small text-muted mb-1 fw-bold">ì…ê³  ì§€ì </label>
                            <select class="form-select fw-bold" id="in_branch">
                                <option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option>
                                <option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold small text-secondary"><i class="bi bi-upc-scan"></i> ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="in_mode_toggle" onchange="toggleInMode()">
                            <label class="form-check-label small fw-bold text-muted" for="in_mode_toggle" id="in_mode_label">ì¼ë°˜</label>
                        </div>
                    </div>

                    <div class="scan-wrapper mb-3">
                        <input type="text" class="form-control scan-input" id="in_scan" placeholder="Ready to Scan" onkeydown="handleInScan(event)" autocomplete="off">
                        <div class="small text-white-50 mt-2"><i class="bi bi-lightning-fill text-warning"></i> ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</div>
                    </div>

                    <div id="in-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>

                    <div id="in_batch_area" style="display:none;">
                        <div class="bg-light rounded-3 p-3 border">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 fw-bold">ëŒ€ê¸° ëª©ë¡ <span class="badge bg-primary rounded-pill" id="in_count">0</span></h6>
                                <button class="btn btn-xs btn-link text-danger text-decoration-none fw-bold" onclick="clearInList()">ë¹„ìš°ê¸°</button>
                            </div>
                            <div style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-sm table-borderless small align-middle">
                                    <tbody id="in_tbody"></tbody>
                                </table>
                            </div>
                            <button class="btn btn-primary w-100 rounded-3 mt-2 fw-bold shadow-sm" id="btn_in_submit" onclick="submitInBatch()" disabled>
                                ì…ê³  í™•ì •í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-move" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4"><i class="bi bi-arrow-left-right text-primary"></i> ì¬ê³  ì´ë™</h5>
                    <div class="mb-3">
                        <label class="small text-muted mb-1 fw-bold">ì–´ë””ë¡œ ë³´ë‚¼ê¹Œìš”?</label>
                        <select class="form-select bg-light fw-bold py-3" id="move_to_branch">
                            <option value="ëª…ì¼ ì§ì˜ì ">ğŸ‘‰ ëª…ì¼ ì§ì˜ì ìœ¼ë¡œ</option>
                            <option value="ì¥ì§€ ë³¸ì ">ğŸ‘‰ ì¥ì§€ ë³¸ì ìœ¼ë¡œ</option>
                        </select>
                    </div>
                    <div class="scan-wrapper my-4">
                        <input type="text" class="form-control scan-input" id="move_scan" placeholder="Scan Device" onkeydown="handleMoveScan(event)" autocomplete="off">
                    </div>
                    <div id="move-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-out" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-danger">
                    <h5 class="fw-bold mb-4 text-danger"><i class="bi bi-x-circle"></i> ë°˜í’ˆ ì²˜ë¦¬</h5>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="out_note" placeholder="ì‚¬ìœ ">
                        <label for="out_note">ë°˜í’ˆ ì‚¬ìœ  / ë©”ëª¨</label>
                    </div>
                    <div class="scan-wrapper bg-danger bg-opacity-75 my-4" style="background-color: #d63031;">
                        <input type="text" class="form-control scan-input border-danger" id="out_scan" placeholder="Scan Return Item" onkeydown="handleOutScan(event)" autocomplete="off">
                    </div>
                    <div id="out-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-history" class="section-view fade-in">
                <div class="glass-card p-3 mb-3 sticky-top" style="top: 80px; z-index: 10;">
                    <div class="input-group">
                        <input type="text" class="form-control border-end-0" id="hist_keyword" placeholder="ì¼ë ¨ë²ˆí˜¸/ëª¨ë¸ëª… ê²€ìƒ‰" onkeydown="if(event.key==='Enter') searchHistory()">
                        <button class="btn btn-outline-secondary border-start-0 bg-white" onclick="searchHistory()"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div id="hist_result"></div>
            </div>

            <div id="section-vendor" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3">ì‹ ê·œ ê±°ë˜ì²˜ ë“±ë¡</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control" id="v_name" placeholder="ê±°ë˜ì²˜ëª… (í•„ìˆ˜)"></div>
                        <div class="col-6"><input type="text" class="form-control" id="v_sales" placeholder="ì˜ì—…ì‚¬ì›"></div>
                        <div class="col-6"><input type="text" class="form-control" id="v_phone" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-12"><input type="text" class="form-control" id="v_office" placeholder="ê°œí†µì‹¤ ì „í™”ë²ˆí˜¸"></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-3" onclick="addVendor()">ë“±ë¡í•˜ê¸°</button>
                </div>

                <div class="glass-card p-0">
                    <div class="p-3 border-bottom bg-light">
                        <h6 class="mb-0 fw-bold">ê±°ë˜ì²˜ ëª©ë¡</h6>
                    </div>
                    <div id="vendor_list_ui" class="list-group list-group-flush">
                        </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];

        window.onload = function() {
            const saved = localStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                showMain();
            }
        };

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section', 'fade-in'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(id);
            target.classList.add('active-section', 'fade-in');
            
            // ë„¤ë¹„ ë²„íŠ¼ í™œì„±í™” ì°¾ê¸°
            const navBtn = document.querySelector(`a[onclick="showSection('${id}')"]`);
            if(navBtn) navBtn.classList.add('active');
            
            if(id === 'section-in') loadVendors();
            if(id === 'section-vendor') loadVendorsToList();
            
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        // --- ê±°ë˜ì²˜ ê´€ë¦¬ ---
        function loadVendors() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) })
            .then(r => r.json()).then(d => {
                const sel = document.getElementById('in_supplier');
                sel.innerHTML = "";
                d.list.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name; opt.innerText = v.name;
                    sel.appendChild(opt);
                });
            });
        }
        function loadVendorsToList() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) })
            .then(r => r.json()).then(d => {
                const div = document.getElementById('vendor_list_ui');
                div.innerHTML = "";
                d.list.forEach(v => {
                    div.innerHTML += `
                        <div class="list-group-item p-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="fw-bold mb-0 text-primary">${v.name}</h6>
                                <span class="badge bg-light text-dark border">${v.salesName || '-'}</span>
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-telephone me-1"></i>${v.salesPhone || '-'} 
                                <span class="mx-2">|</span> 
                                <i class="bi bi-headset me-1"></i>${v.officePhone || '-'}
                            </div>
                        </div>`;
                });
            });
        }
        function addVendor() {
            const data = {
                action: "add_vendor",
                name: document.getElementById('v_name').value,
                salesName: document.getElementById('v_sales').value,
                salesPhone: document.getElementById('v_phone').value,
                officePhone: document.getElementById('v_office').value
            };
            if(!data.name) return alert("ê±°ë˜ì²˜ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(data) })
            .then(r => r.json()).then(d => {
                alert(d.message);
                document.getElementById('v_name').value = "";
                document.getElementById('v_sales').value = "";
                document.getElementById('v_phone').value = "";
                document.getElementById('v_office').value = "";
                loadVendorsToList();
            });
        }

        // --- ì…ê³  ---
        function toggleInMode() {
            const isBatch = document.getElementById('in_mode_toggle').checked;
            const label = document.getElementById('in_mode_label');
            label.innerText = isBatch ? "ì—°ì† (ëŒ€ê¸°ì—´)" : "ì¼ë°˜ (ì¦‰ì‹œ)";
            label.classList.toggle("text-primary", isBatch);
            document.getElementById('in_batch_area').style.display = isBatch ? 'block' : 'none';
            document.getElementById('in_scan').focus();
        }

        function handleInScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            if(!barcode) return;
            
            const isBatch = document.getElementById('in_mode_toggle').checked;
            const supplier = document.getElementById('in_supplier').value;
            const branch = document.getElementById('in_branch').value;
            
            e.target.disabled = true;
            
            const action = isBatch ? "scan_preview" : "register_single";
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: action, barcode: barcode, supplier: supplier, branch: branch, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    if(isBatch) {
                        inPendingList.push({ ...d.data, supplier: supplier });
                        renderInList();
                        showMsg('in-msg', 'success', `ì¶”ê°€ë¨: ${d.data.model}`);
                    } else {
                        showMsg('in-msg', 'success', `âœ… ì…ê³ ì™„ë£Œ: ${d.data.model}`);
                    }
                } else showMsg('in-msg', 'error', d.message);
            })
            .finally(() => { e.target.disabled = false; e.target.value = ""; e.target.focus(); });
        }

        function renderInList() {
            const tbody = document.getElementById('in_tbody');
            tbody.innerHTML = "";
            inPendingList.forEach((item, idx) => {
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold">${item.model}</td>
                        <td class="font-monospace text-muted">${item.serial}</td>
                        <td><button class="btn btn-sm text-danger p-0" onclick="removeInItem(${idx})"><i class="bi bi-x-circle-fill"></i></button></td>
                    </tr>`;
            });
            document.getElementById('in_count').innerText = inPendingList.length;
            document.getElementById('btn_in_submit').disabled = inPendingList.length === 0;
        }
        function removeInItem(idx) { inPendingList.splice(idx, 1); renderInList(); }
        function clearInList() { inPendingList = []; renderInList(); }
        function submitInBatch() {
            if(!confirm(`${inPendingList.length}ëŒ€ë¥¼ ì…ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const branch = document.getElementById('in_branch').value;
            const btn = document.getElementById('btn_in_submit');
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...`;
            
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ 
                action: "batch_register", items: inPendingList, branch: branch, user: currentUser 
            })})
            .then(r => r.json()).then(d => {
                if(d.status === 'success') {
                    showMsg('in-msg', 'success', `${d.count}ëŒ€ ì…ê³  ì™„ë£Œ`);
                    clearInList();
                } else showMsg('in-msg', 'error', d.message);
            })
            .finally(() => { btn.innerText = "ì…ê³  í™•ì •í•˜ê¸°"; });
        }

        // --- ì´ë™/ë°˜í’ˆ/ì¡°íšŒ ---
        function handleMoveScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            const toBranch = document.getElementById('move_to_branch').value;
            e.target.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "transfer_stock", barcode: barcode, toBranch: toBranch, user: currentUser })})
            .then(r => r.json()).then(d => showMsg('move-msg', d.status==='success'?'success':'error', d.message))
            .finally(() => { e.target.disabled = false; e.target.value = ""; e.target.focus(); });
        }
        function handleOutScan(e) {
            if(e.key !== 'Enter') return;
            const barcode = e.target.value.trim();
            const note = document.getElementById('out_note').value;
            if(!note) { alert("ì‚¬ìœ  ì…ë ¥ í•„ìˆ˜"); return; }
            e.target.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "return_stock", barcode: barcode, note: note, user: currentUser })})
            .then(r => r.json()).then(d => showMsg('out-msg', d.status==='success'?'success':'error', d.message))
            .finally(() => { e.target.disabled = false; e.target.value = ""; e.target.focus(); });
        }
        function searchHistory() {
            const key = document.getElementById('hist_keyword').value;
            if(!key) return;
            const div = document.getElementById('hist_result');
            div.innerHTML = `<div class="text-center py-4"><span class="spinner-border text-primary"></span></div>`;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_history", keyword: key }) })
            .then(r => r.json()).then(d => {
                if(!d.list.length) { div.innerHTML = `<div class="text-center text-muted py-3">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                let html = "";
                d.list.forEach(h => {
                    let badge = h.type === 'ì…ê³ ' ? 'bg-primary' : (h.type==='ë°˜í’ˆì²˜ë¦¬' ? 'bg-danger' : 'bg-info');
                    html += `
                        <div class="glass-card p-3 mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="badge ${badge}">${h.type}</span>
                                <small class="text-muted">${h.time}</small>
                            </div>
                            <h6 class="fw-bold mb-1">${h.model}</h6>
                            <p class="mb-1 small text-secondary">${h.desc}</p>
                            <div class="small text-muted bg-light rounded p-1 d-inline-block">
                                <i class="bi bi-upc"></i> ${h.serial} | <i class="bi bi-person"></i> ${h.user}
                            </div>
                        </div>`;
                });
                div.innerHTML = html;
            });
        }

        function showMsg(id, type, text) {
            const el = document.getElementById(id);
            el.style.display = 'block';
            el.className = `alert py-2 text-center small fw-bold rounded-3 alert-${type==='success'?'success':'danger'}`;
            el.innerHTML = type==='success' ? `<i class="bi bi-check-circle-fill me-1"></i> ${text}` : `<i class="bi bi-exclamation-triangle-fill me-1"></i> ${text}`;
            setTimeout(() => el.style.display='none', 2000);
        }

        // ë¡œê·¸ì¸
        function handleCredentialResponse(response) {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "login", token: response.credential }) })
            .then(r => r.json()).then(d => {
                if (d.status === 'success') {
                    localStorage.setItem('dbphone_user', JSON.stringify({ name: d.name, email: d.user }));
                    currentUser = d.name;
                    document.getElementById('login-view').style.display = 'none';
                    document.getElementById('main-view').style.display = 'block';
                    loadVendors();
                } else document.getElementById('login-msg').innerText = d.message;
            });
        }
        function logout() { localStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
