<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DBPhone Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --info-color: #36b9cc;
            --secondary-color: #858796;
            --bg-color: #f8f9fc;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        body { 
            background-color: var(--bg-color); 
            font-family: 'Noto Sans KR', sans-serif; 
            color: #5a5c69; 
            font-size: 0.95rem; 
        }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .glass-card { 
            background: #ffffff; 
            border-radius: 12px; 
            box-shadow: var(--card-shadow); 
            border: none; 
            overflow: hidden; 
            margin-bottom: 20px; 
            transition: transform 0.2s ease-in-out;
        }
        
        /* ì„¹ì…˜ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .section-view { display: none; }
        .active-section { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
        .form-label-sm { font-size: 0.8rem; font-weight: 700; color: #858796; margin-bottom: 4px; }
        .form-control-sm, .form-select-sm { 
            border-radius: 6px; 
            padding: 0.5rem 0.75rem; 
            font-size: 0.9rem;
            border: 1px solid #d1d3e2;
        }
        .form-control:focus, .form-select:focus {
            border-color: #bac8f3;
            box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
        }

        /* êµ¬ë¶„ì„  */
        .divider { border-top: 1px solid #e3e6f0; margin: 1.5rem 0 1rem 0; }
        
        /* ì„¹ì…˜ í—¤ë” */
        .section-header { 
            font-size: 0.95rem; 
            font-weight: 800; 
            color: var(--primary-color); 
            margin-bottom: 12px; 
            display: flex; 
            align-items: center; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .section-header i { margin-right: 8px; font-size: 1.1rem; }

        /* ê°•ì¡° í…ìŠ¤íŠ¸ */
        .required-star { color: #e74a3b; font-weight: bold; margin-left: 2px; }
        .text-danger-custom { color: #e74a3b !important; font-weight: bold; }
        .border-danger-custom { border-color: #e74a3b !important; color: #e74a3b !important; font-weight: bold; }

        /* ëŒ€ì‹œë³´ë“œ ì¹´ë“œ */
        .stat-card { border-left: 0.25rem solid var(--primary-color); }
        .stat-card.month { border-left-color: var(--success-color); }
        
        /* ëŒ€ì‹œë³´ë“œ í…Œì´ë¸” */
        .dash-table th { 
            background-color: #f8f9fc; 
            color: #4e73df; 
            font-weight: 800; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            text-align: center;
        }
        .dash-table td { 
            vertical-align: middle; 
            font-size: 0.9rem; 
            text-align: center;
        }
        
        /* í…ìŠ¤íŠ¸ ë§ì¤„ì„ */
        .text-truncate-box { 
            max-width: 100px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: inline-block; 
            vertical-align: middle; 
        }

        /* ì§ì› ë­í‚¹ */
        .user-rank-item { display: flex; align-items: center; margin-bottom: 10px; }
        .user-rank-name { width: 80px; font-weight: bold; font-size: 0.9rem; color: #5a5c69; }
        .progress { height: 12px; border-radius: 6px; flex-grow: 1; margin: 0 10px; background-color: #eaecf4; }
        .user-rank-count { width: 40px; text-align: right; font-weight: 800; color: var(--primary-color); }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar { background-color: #ffffff !important; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important; }
        .navbar-brand { font-weight: 800; color: var(--primary-color) !important; font-size: 1.2rem; }
        .nav-link { font-weight: 600; color: #5a5c69 !important; font-size: 0.95rem; }
        .nav-link:hover { color: var(--primary-color) !important; }
    </style>
</head>
<body>

    <div id="login-view" style="height: 100vh; background: linear-gradient(135deg, #4e73df 10%, #224abe 100%); display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
        <div class="glass-card p-5 text-center shadow-lg" style="width: 90%; max-width: 400px; border-radius: 20px;">
            <h3 class="fw-bold mb-4 text-primary"><i class="bi bi-phone-vibrate"></i> DBPhone ERP</h3>
            <div id="g_id_onload" data-client_id="98614909172-tj2a973qqgi1l7iukvfnnek0e09bpupl.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            <div id="login-msg" class="text-danger mt-3 small fw-bold"></div>
        </div>
    </div>

    <div id="main-view" style="display:none;">
        <nav class="navbar navbar-expand-lg sticky-top px-3">
            <div class="container-fluid px-0">
                <a class="navbar-brand" href="#" onclick="showSection('section-dashboard')"><i class="bi bi-grid-fill"></i> ëŒ€ë°•í†µì‹ </a>
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto ms-lg-3">
                        <li class="nav-item"><a class="nav-link" onclick="showSection('section-dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ“¦ ì¬ê³  ê´€ë¦¬</a>
                            <ul class="dropdown-menu shadow-sm border-0">
                                <li><a class="dropdown-item" onclick="showSection('section-in')">ì…ê³  ë“±ë¡</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-move')">ì¬ê³  ì´ë™</a></li>
                                <li><a class="dropdown-item text-danger" onclick="showSection('section-out')">ë°˜í’ˆ ì²˜ë¦¬</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="showSection('section-stock')">ğŸ” ì¬ê³  ì¡°íšŒ</a></li>
                                <li><a class="dropdown-item" onclick="showSection('section-history')">ğŸ“œ ì´ë ¥ ì¡°íšŒ</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-primary" href="#" data-bs-toggle="dropdown">âœ… ê°œí†µ ì²˜ë¦¬</a>
                            <ul class="dropdown-menu shadow-sm border-0">
                                <li><a class="dropdown-item" onclick="showOpenSection('ë¬´ì„ ê°œí†µ')"><i class="bi bi-phone text-primary"></i> ë¬´ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showWiredSection()"><i class="bi bi-router text-success"></i> ìœ ì„  ê°œí†µ</a></li>
                                <li><a class="dropdown-item" onclick="showUsedSection()"><i class="bi bi-recycle text-warning"></i> ì¤‘ê³  ê°œí†µ</a></li>
                            </ul>
                        </li>
                        <li class="nav-item"><a class="nav-link" onclick="showSection('section-vendor')">ğŸ¢ ê±°ë˜ì²˜</a></li>
                    </ul>
                    <div class="d-flex align-items-center mt-3 mt-lg-0">
                        <span class="small me-3 fw-bold text-secondary" id="user-name"></span>
                        <button onclick="logout()" class="btn btn-sm btn-outline-secondary rounded-pill"><i class="bi bi-box-arrow-right"></i> ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container py-4">

            <div id="section-dashboard" class="section-view active-section">
                <div class="row g-3 mb-4">
                    <div class="col-lg-6">
                        <div class="glass-card stat-card p-4 h-100">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-2">ì˜¤ëŠ˜ ê°œí†µ í˜„í™© (ì „ì²´)</div>
                            <div class="row text-center mt-2">
                                <div class="col-6 border-end">
                                    <div class="small text-muted mb-1">ğŸ“± ë¬´ì„ </div>
                                    <div class="h3 fw-bold text-dark mb-0" id="dash_today_mobile">-</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted mb-1">ğŸ“º ìœ ì„ </div>
                                    <div class="h3 fw-bold text-dark mb-0" id="dash_today_wired">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="glass-card stat-card month p-4 h-100">
                            <div class="text-xs fw-bold text-success text-uppercase mb-3">ì´ë²ˆ ë‹¬ ëˆ„ì  (ì§€ì ë³„)</div>
                            <div id="dash_month_stats" class="d-flex flex-column justify-content-center">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-lg-7">
                        <div class="glass-card h-100">
                            <div class="card-header py-3 px-4 bg-white border-bottom d-flex justify-content-between align-items-center">
                                <h6 class="m-0 fw-bold text-primary"><i class="bi bi-broadcast"></i> ì‹¤ì‹œê°„ ê°œí†µ (Today)</h6>
                                <button class="btn btn-sm btn-light border rounded-circle" onclick="loadDashboard()" title="ìƒˆë¡œê³ ì¹¨"><i class="bi bi-arrow-clockwise"></i></button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover align-middle mb-0 dash-table w-100">
                                        <thead class="sticky-top border-bottom">
                                            <tr>
                                                <th style="width:15%">ì§€ì </th>
                                                <th style="width:20%">ìœ í˜•</th>
                                                <th style="width:20%">ê³ ê°ëª…</th>
                                                <th style="width:20%">ë‹´ë‹¹</th>
                                                <th style="width:25%" class="text-end">ë§ˆì§„</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dash_today_list">
                                            <tr><td colspan="5" class="text-center py-5 text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="glass-card h-100">
                            <div class="card-header py-3 px-4 bg-white border-bottom">
                                <h6 class="m-0 fw-bold text-success"><i class="bi bi-trophy"></i> ì´ë‹¬ì˜ ì§ì› ì‹¤ì </h6>
                            </div>
                            <div class="card-body p-4" id="dash_user_rank" style="min-height: 200px;">
                                <div class="text-center py-5 text-muted">ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="section-in" class="section-view">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4 text-secondary"><i class="bi bi-box-seam"></i> ì…ê³  ë“±ë¡</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-6"><label class="form-label-sm">ê±°ë˜ì²˜</label><select class="form-select form-select-sm" id="in_supplier"></select></div>
                        <div class="col-6"><label class="form-label-sm">ì§€ì </label><select class="form-select form-select-sm" id="in_branch"><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select></div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="in_mode_toggle">
                        <label class="form-check-label small" for="in_mode_toggle">ì—°ì† ìŠ¤ìº” ëª¨ë“œ</label>
                    </div>
                    <input type="text" class="form-control form-control-lg text-center fw-bold mb-3 border-primary" id="in_scan" placeholder="ë°”ì½”ë“œ ìŠ¤ìº”" onkeydown="handleInScan(event)">
                    <div id="in-msg" class="alert py-2 text-center small fw-bold" style="display:none"></div>
                    
                    <div id="in_batch_area" style="display:none;" class="bg-light p-3 rounded border">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small fw-bold">ëŒ€ê¸° ëª©ë¡ <span id="in_count" class="badge bg-primary">0</span></span>
                            <button class="btn btn-xs btn-outline-danger" onclick="clearInList()">ë¹„ìš°ê¸°</button>
                        </div>
                        <div style="max-height:150px; overflow-y:auto; margin-bottom:10px;">
                            <table class="table table-sm small mb-0"><tbody id="in_tbody"></tbody></table>
                        </div>
                        <button class="btn btn-primary w-100 btn-sm fw-bold" onclick="submitInBatch()">ì¼ê´„ ë“±ë¡í•˜ê¸°</button>
                    </div>
                </div>
            </div>

            <div id="section-open" class="section-view">
                <div class="glass-card border-top border-4 border-primary">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-primary"><i class="bi bi-phone"></i> ë¬´ì„  ê°œí†µ</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetOpenForm()">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="p-4">
                        <div id="open_step_1">
                            <div class="text-center p-5 bg-light rounded border border-dashed mb-3">
                                <i class="bi bi-qr-code-scan fs-1 text-muted mb-3 d-block"></i>
                                <label class="text-muted fw-bold mb-3">ë‹¨ë§ê¸° ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</label>
                                <input type="text" class="form-control form-control-lg text-center fs-4 fw-bold mx-auto" style="max-width:300px;" id="open_scan" onkeydown="handleOpenScan(event)" autocomplete="off">
                                <div id="open_spinner" class="mt-3 text-primary small fw-bold" style="display:none;">ì¡°íšŒ ì¤‘...</div>
                            </div>
                        </div>
                        <div id="open_step_2" style="display:none;">
                            <div class="alert alert-primary d-flex justify-content-between align-items-center shadow-sm">
                                <div><i class="bi bi-phone-fill me-2"></i><span id="target_model" class="fw-bold fs-5"></span></div>
                                <span class="badge bg-primary fs-6" id="target_branch"></span>
                            </div>
                            
                            <div class="section-header"><i class="bi bi-person-badge"></i> ê¸°ë³¸ ì •ë³´</div>
                            <div class="row g-2 mb-4">
                                <div class="col-4"><label class="form-label-sm">ê°œí†µìœ í˜•</label><select class="form-select form-select-sm" id="f_act_type"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì•½ì •ìœ í˜•</label><select class="form-select form-select-sm" id="f_cont_type"></select></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë¬¸ê²½ë¡œ<span class="required-star">*</span></label><select class="form-select form-select-sm" id="f_visit" onchange="checkVisitPath()"></select></div>
                                <div class="col-12" id="div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="f_visit_etc" placeholder="ìƒì„¸ ê²½ë¡œ ì…ë ¥"></div>
                                
                                <div class="col-4"><label class="form-label-sm">ê³ ê°ëª…<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="f_name"></div>
                                <div class="col-4"><label class="form-label-sm">ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-control-sm" id="f_birth" placeholder="6ìë¦¬"></div>
                                <div class="col-4"><label class="form-label-sm">ì—°ë½ì²˜</label><input type="text" class="form-control form-control-sm" id="f_phone"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="f_plan"></div>
                                <div class="col-6"><label class="form-label-sm">ë³€ê²½ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="f_plan_chg"></div>
                                
                                <div class="col-12">
                                    <label class="form-label-sm">ë¶€ê°€ì„œë¹„ìŠ¤</label>
                                    <div id="div_addon_container" class="border rounded p-3 bg-light" style="min-height: 50px;"></div>
                                </div>
                                
                                <div class="col-4"><label class="form-label-sm">ì œíœ´ì¹´ë“œ</label><input type="text" class="form-control form-control-sm" id="f_card"></div>
                                <div class="col-4"><label class="form-label-sm">ë¦¬ë·°ì‘ì„±<span class="required-star">*</span></label><select class="form-select form-select-sm" id="f_review"></select></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> ì •ì±… ë° ì •ì‚°</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê°œí†µì²˜</label><input type="text" class="form-control form-control-sm" id="f_avalue" oninput="refreshAddons()"></div>
                                <div class="col-6"><label class="form-label-sm">ì •ì±…ì°¨ìˆ˜</label><input type="text" class="form-control form-control-sm" id="f_policy"></div>
                                
                                <div class="col-6"><label class="form-label-sm">ì•¡ë©´/íˆë“ </label><input type="number" class="form-control form-control-sm" id="f_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">ì¶”ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="f_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">ë¶€ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="f_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">ì°¨ê°ì •ì±…</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_cost1_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í”„ë¦¬í• ì¸</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cost2"></div>
                                <div class="col-6"><label class="form-label-sm">ìœ ì‹¬</label><select class="form-select form-select-sm" id="f_usim"></select></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> ëŒ€ë‚© ë° ì§€ì›</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_pay1_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="f_pay1_d"></div>

                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_pay2_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="f_pay2_d"></div>

                                <div class="col-6"><label class="form-label-sm text-danger-custom">í˜„ê¸ˆì§€ê¸‰</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í˜ì´ë°±</label><input type="number" class="form-control form-control-sm border-danger-custom" id="f_back"></div>
                                
                                <div class="col-4"><label class="form-label-sm">ì€í–‰ëª…</label><input type="text" class="form-control form-control-sm" id="f_bank"></div>
                                <div class="col-4"><label class="form-label-sm">ê³„ì¢Œë²ˆí˜¸</label><input type="text" class="form-control form-control-sm" id="f_acc"></div>
                                <div class="col-4"><label class="form-label-sm">ì˜ˆê¸ˆì£¼</label><input type="text" class="form-control form-control-sm" id="f_holder"></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> ìˆ˜ë‚© ìƒì„¸</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ë‹¨ë§ê¸°ìˆ˜ë‚©1</label><input type="number" class="form-control form-control-sm" id="f_inc4"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc4_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">ë‹¨ë§ê¸°ìˆ˜ë‚©2</label><input type="number" class="form-control form-control-sm" id="f_inc4_2"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc4_2_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆìˆ˜ë‚©</label><input type="number" class="form-control form-control-sm" id="f_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="f_inc5_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">ì¤‘ê³ í°</label><input type="number" class="form-control form-control-sm" id="f_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="f_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</label><input type="text" class="form-control form-control-sm" id="f_comment"></div>
                            </div>

                            <div class="mt-4 pb-4">
                                <button class="btn btn-primary w-100 py-3 fw-bold shadow-sm" onclick="submitFullContract(event)">
                                    <i class="bi bi-save-fill"></i> ê°œí†µ ë° ì €ì¥ ì™„ë£Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-wired" class="section-view">
                <div class="glass-card border-top border-4 border-success">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-success"><i class="bi bi-router"></i> ìœ ì„  ê°œí†µ</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetWiredForm()">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="p-4">
                        <div id="wired_step_1">
                            <div class="bg-light p-4 rounded border">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">1. ì§€ì  ì„ íƒ</label>
                                    <select class="form-select" id="wired_branch"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">2. ê°œí†µì²˜ ì„ íƒ</label>
                                    <select class="form-select" id="w_pre_avalue"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">3. ê°œí†µìœ í˜• ì„ íƒ</label>
                                    <select class="form-select" id="w_pre_act_type"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">4. ì•½ì •ìœ í˜• ì„ íƒ</label>
                                    <select class="form-select" id="w_pre_cont_type"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <button class="btn btn-success w-100 fw-bold py-2" onclick="startWiredActivation()">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™</button>
                            </div>
                        </div>
                        <div id="wired_step_2" style="display:none;">
                            <div class="alert alert-success d-flex justify-content-between align-items-center shadow-sm mb-4">
                                <div><i class="bi bi-check-circle-fill me-2"></i><span id="w_target_info" class="fw-bold fs-5"></span></div>
                                <span class="badge bg-success fs-6" id="w_target_branch"></span>
                            </div>

                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> ê¸°ë³¸ ì •ë³´</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê°œí†µìœ í˜•</label><input type="text" class="form-control form-control-sm" id="w_act_type" readonly></div>
                                <div class="col-6"><label class="form-label-sm">ì•½ì •ìœ í˜•</label><input type="text" class="form-control form-control-sm" id="w_cont_type" readonly></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë¬¸ê²½ë¡œ<span class="required-star">*</span></label><select class="form-select form-select-sm" id="w_visit" onchange="checkWiredVisitPath()"></select></div>
                                <div class="col-12" id="w_div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="w_visit_etc" placeholder="ìƒì„¸ ê²½ë¡œ"></div>
                                <div class="col-4"><label class="form-label-sm">ê³ ê°ëª…<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="w_name"></div>
                                <div class="col-4"><label class="form-label-sm">ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-control-sm" id="w_birth"></div>
                                <div class="col-4"><label class="form-label-sm">ì—°ë½ì²˜</label><input type="text" class="form-control form-control-sm" id="w_phone"></div>
                                <div class="col-12" id="w_plan_input_area"></div>
                                <div class="col-4"><label class="form-label-sm">ì œíœ´ì¹´ë“œ</label><input type="text" class="form-control form-control-sm" id="w_card"></div>
                                <div class="col-4"><label class="form-label-sm">ë¦¬ë·°ì‘ì„±<span class="required-star">*</span></label><select class="form-select form-select-sm" id="w_review"></select></div>
                            </div>
                            
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> ì •ì±… ë° ì •ì‚°</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê°œí†µì²˜</label><input type="text" class="form-control form-control-sm" id="w_avalue"></div>
                                <div class="col-6"><label class="form-label-sm">ì •ì±…ì°¨ìˆ˜</label><input type="text" class="form-control form-control-sm" id="w_policy"></div>
                                <div class="col-6"><label class="form-label-sm">ì•¡ë©´/íˆë“ </label><input type="number" class="form-control form-control-sm" id="w_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="w_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">ì¶”ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="w_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="w_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">ë¶€ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="w_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="w_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">ì°¨ê°ì •ì±…</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="w_cost1_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í”„ë¦¬í• ì¸</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_cost2"></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> ëŒ€ë‚© ë° ì§€ì›</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="w_pay1_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="w_pay1_d"></div>
                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="w_pay2_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="w_pay2_d"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í˜„ê¸ˆì§€ê¸‰</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_cash"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í˜ì´ë°±</label><input type="number" class="form-control form-control-sm border-danger-custom" id="w_back"></div>
                                <div class="col-4"><label class="form-label-sm">ì€í–‰ëª…</label><input type="text" class="form-control form-control-sm" id="w_bank"></div>
                                <div class="col-4"><label class="form-label-sm">ê³„ì¢Œë²ˆí˜¸</label><input type="text" class="form-control form-control-sm" id="w_acc"></div>
                                <div class="col-4"><label class="form-label-sm">ì˜ˆê¸ˆì£¼</label><input type="text" class="form-control form-control-sm" id="w_holder"></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> ìˆ˜ë‚© ìƒì„¸</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆìˆ˜ë‚©</label><input type="number" class="form-control form-control-sm" id="w_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="w_inc5_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">ìƒí’ˆê¶Œ/ê¸°íƒ€</label><input type="number" class="form-control form-control-sm" id="w_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="w_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</label><input type="text" class="form-control form-control-sm" id="w_comment"></div>
                            </div>
                            <div class="mt-4 pb-4">
                                <button class="btn btn-success w-100 py-3 fw-bold shadow-sm" onclick="submitWiredContract(event)">
                                    <i class="bi bi-save-fill"></i> ìœ ì„  ê°œí†µ ì €ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-used" class="section-view">
                <div class="glass-card border-top border-4 border-warning">
                    <div class="p-3 bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-warning"><i class="bi bi-recycle"></i> ì¤‘ê³ í° ê°œí†µ</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetUsedForm()">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="p-4">
                        <div id="used_step_1">
                            <div class="bg-light p-4 rounded border">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">1. ì§€ì  ì„ íƒ</label>
                                    <select class="form-select" id="u_branch"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option><option value="ì¥ì§€ ë³¸ì ">ì¥ì§€ ë³¸ì </option><option value="ëª…ì¼ ì§ì˜ì ">ëª…ì¼ ì§ì˜ì </option></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">2. ê°œí†µì²˜ ì„ íƒ</label>
                                    <select class="form-select" id="u_pre_avalue"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">3. ê°œí†µìœ í˜• ì„ íƒ</label>
                                    <select class="form-select" id="u_pre_act_type"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">4. ì•½ì •ìœ í˜• ì„ íƒ</label>
                                    <select class="form-select" id="u_pre_cont_type"><option value="" selected>ì„ íƒí•˜ì„¸ìš”</option></select>
                                </div>
                                <button class="btn btn-warning text-white w-100 fw-bold py-2" onclick="startUsedActivation()">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™</button>
                            </div>
                        </div>
                        <div id="used_step_2" style="display:none;">
                            <div class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm mb-4">
                                <div><i class="bi bi-recycle me-2"></i><span id="u_target_info" class="fw-bold fs-5"></span></div>
                                <span class="badge bg-warning text-dark fs-6" id="u_target_branch"></span>
                            </div>
                            <div class="section-header"><i class="bi bi-person-lines-fill"></i> ê¸°ë³¸ ì •ë³´</div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm">ê°œí†µìœ í˜•</label><input type="text" class="form-control form-control-sm" id="u_act_type" readonly></div>
                                <div class="col-4"><label class="form-label-sm">ì•½ì •ìœ í˜•</label><input type="text" class="form-control form-control-sm" id="u_cont_type" readonly></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë¬¸ê²½ë¡œ<span class="required-star">*</span></label><select class="form-select form-select-sm" id="u_visit" onchange="checkUsedVisitPath()"></select></div>
                                <div class="col-12" id="u_div_visit_etc" style="display:none;"><input type="text" class="form-control form-control-sm" id="u_visit_etc" placeholder="ìƒì„¸ ê²½ë¡œ"></div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm">ê³ ê°ëª…<span class="required-star">*</span></label><input type="text" class="form-control form-control-sm" id="u_name"></div>
                                <div class="col-4"><label class="form-label-sm">ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-control-sm" id="u_birth"></div>
                                <div class="col-4"><label class="form-label-sm">ì—°ë½ì²˜</label><input type="text" class="form-control form-control-sm" id="u_phone"></div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê¸°ê¸°ëª¨ë¸ëª…</label><input type="text" class="form-control form-control-sm" id="u_model"></div>
                                <div class="col-6"><label class="form-label-sm">ì¼ë ¨ë²ˆí˜¸</label><input type="text" class="form-control form-control-sm" id="u_serial"></div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="u_plan"></div>
                                <div class="col-6"><label class="form-label-sm">ë³€ê²½ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="u_plan_chg"></div>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-12">
                                    <label class="form-label-sm">ë¶€ê°€ì„œë¹„ìŠ¤</label>
                                    <div id="u_div_addon_container" class="border rounded p-2 bg-light" style="min-height: 40px;"></div>
                                </div>
                                <div class="col-4"><label class="form-label-sm">ì œíœ´ì¹´ë“œ</label><input type="text" class="form-control form-control-sm" id="u_card"></div>
                                <div class="col-4"><label class="form-label-sm">ë¦¬ë·°ì‘ì„±<span class="required-star">*</span></label><select class="form-select form-select-sm" id="u_review"></select></div>
                            </div>
                            
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-calculator"></i> ì •ì±… ë° ì •ì‚°</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ê°œí†µì²˜</label><input type="text" class="form-control form-control-sm" id="u_avalue" oninput="refreshUsedAddons()"></div>
                                <div class="col-6"><label class="form-label-sm">ì •ì±…ì°¨ìˆ˜</label><input type="text" class="form-control form-control-sm" id="u_policy"></div>
                                <div class="col-6"><label class="form-label-sm">ì•¡ë©´/íˆë“ </label><input type="number" class="form-control form-control-sm" id="u_inc1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="u_inc1_m"></div>
                                <div class="col-6"><label class="form-label-sm">ì¶”ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="u_inc2"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="u_inc2_m"></div>
                                <div class="col-6"><label class="form-label-sm">ë¶€ê°€ì •ì±…</label><input type="number" class="form-control form-control-sm" id="u_inc3"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="u_inc3_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">ì°¨ê°ì •ì±…</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_cost1"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="u_cost1_m"></div>
                                <div class="col-6"><label class="form-label-sm text-danger-custom">í”„ë¦¬í• ì¸</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_cost2"></div>
                                <div class="col-6"><label class="form-label-sm">ìœ ì‹¬</label><select class="form-select form-select-sm" id="u_usim"><option value="" selected>ì„ íƒ</option></select></div>
                            </div>
                            
                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-credit-card"></i> ëŒ€ë‚© ë° ì§€ì›</div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©1</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_pay1"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="u_pay1_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="u_pay1_d"></div>
                                <div class="col-4"><label class="form-label-sm text-danger-custom">ëŒ€ë‚©2</label><input type="number" class="form-control form-control-sm border-danger-custom" id="u_pay2"></div>
                                <div class="col-4"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="u_pay2_m"></select></div>
                                <div class="col-4"><label class="form-label-sm">ì²˜ë¦¬ì¼</label><input type="date" class="form-control form-control-sm" id="u_pay2_d"></div>
                            </div>

                            <div class="divider"></div>
                            <div class="section-header"><i class="bi bi-wallet2"></i> ìˆ˜ë‚© ìƒì„¸</div>
                            <div class="row g-2 mb-3">
                                <div class="col-6"><label class="form-label-sm">ìš”ê¸ˆìˆ˜ë‚©</label><input type="number" class="form-control form-control-sm" id="u_inc5"></div>
                                <div class="col-6"><label class="form-label-sm">ë°©ë²•</label><select class="form-select form-select-sm" id="u_inc5_m"></select></div>
                                <div class="col-6"><label class="form-label-sm">ì¤‘ê³ í°</label><input type="number" class="form-control form-control-sm" id="u_inc6"></div>
                                <div class="col-6"><label class="form-label-sm">ë©”ëª¨</label><input type="text" class="form-control form-control-sm" id="u_inc6_m"></div>
                                <div class="col-12"><label class="form-label-sm">ê¸°íƒ€ íŠ¹ì´ì‚¬í•­</label><input type="text" class="form-control form-control-sm" id="u_comment"></div>
                            </div>
                            <div class="mt-4 pb-4">
                                <button class="btn btn-warning w-100 py-3 fw-bold text-white shadow-sm" onclick="submitUsedContract(event)">
                                    <i class="bi bi-save-fill"></i> ì¤‘ê³ í° ê°œí†µ ì €ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-stock" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-search"></i> ì¬ê³  ì¡°íšŒ (ë³´ìœ ë¶„)</h5>
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-4">
                            <select class="form-select fw-bold" id="search_criteria" onchange="updateSearchUI()">
                                <option value="supplier">ê±°ë˜ì²˜ë³„</option>
                                <option value="branch">ì§€ì ë³„</option>
                                <option value="model">ëª¨ë¸ë³„</option>
                                <option value="serial">ì¼ë ¨ë²ˆí˜¸/ë°”ì½”ë“œ</option>
                            </select>
                        </div>
                        <div class="col-8" id="search_input_area"><select class="form-select" id="search_value_supplier"></select></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-3 mb-3" onclick="searchStock()">ì¡°íšŒí•˜ê¸°</button>
                    <div id="stock_result"></div>
                </div>
            </div>

            <div id="section-history" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> ì´ë ¥ ì¡°íšŒ (ë¡œê·¸)</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="hist_keyword" placeholder="ì¼ë ¨ë²ˆí˜¸ ë˜ëŠ” ë°”ì½”ë“œ (ì •í™•íˆ ì…ë ¥)" onkeydown="if(event.key==='Enter') searchHistory()">
                        <button class="btn btn-outline-secondary" onclick="searchHistory()">ê²€ìƒ‰</button>
                    </div>
                    <div id="hist_result"></div>
                </div>
            </div>

            <div id="section-move" class="section-view fade-in">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4 text-primary">ì¬ê³  ì´ë™</h5>
                    <select class="form-select bg-light fw-bold py-3 mb-3" id="move_to_branch"><option value="ëª…ì¼ ì§ì˜ì ">ğŸ‘‰ ëª…ì¼ ì§ì˜ì ìœ¼ë¡œ ë³´ëƒ„</option><option value="ì¥ì§€ ë³¸ì ">ğŸ‘‰ ì¥ì§€ ë³¸ì ìœ¼ë¡œ ë³´ëƒ„</option></select>
                    <div class="scan-wrapper my-4"><input type="text" class="form-control scan-input" id="move_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleMoveScan(event)" autocomplete="off"></div>
                    <div id="move-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>

            <div id="section-out" class="section-view fade-in">
                <div class="glass-card p-4 border-top border-4 border-danger">
                    <h5 class="fw-bold mb-4 text-danger">ë°˜í’ˆ ì²˜ë¦¬</h5>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="out_note" placeholder="ì‚¬ìœ "><label>ë°˜í’ˆ ì‚¬ìœ  / ë©”ëª¨ (í•„ìˆ˜)</label></div>
                    <div class="scan-wrapper bg-danger bg-opacity-75 my-4" style="background-color: #d63031;"><input type="text" class="form-control scan-input border-danger" id="out_scan" placeholder="ë°”ì½”ë“œ ë˜ëŠ” ì¼ë ¨ë²ˆí˜¸" onkeydown="handleOutScan(event)" autocomplete="off"></div>
                    <div id="out-msg" class="alert py-2 text-center small fw-bold rounded-3" style="display:none"></div>
                </div>
            </div>
            
            <div id="section-vendor" class="section-view fade-in">
                 <div class="glass-card p-4">
                    <h5 class="fw-bold mb-3">ê±°ë˜ì²˜ ë“±ë¡</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_name" placeholder="ê±°ë˜ì²˜ëª… (í•„ìˆ˜)"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_sales" placeholder="ì˜ì—…ì‚¬ì›"></div>
                        <div class="col-6"><input type="text" class="form-control enter-trigger" id="v_phone" placeholder="ì—°ë½ì²˜"></div>
                        <div class="col-12"><input type="text" class="form-control enter-trigger" id="v_office" placeholder="ê°œí†µì‹¤ ì „í™”ë²ˆí˜¸"></div>
                    </div>
                    <button class="btn btn-secondary w-100 fw-bold rounded-3" onclick="addVendor()">ë“±ë¡í•˜ê¸°</button>
                </div>
                <div class="glass-card p-0">
                    <div class="p-3 border-bottom bg-light"><h6 class="mb-0 fw-bold">ë“±ë¡ëœ ê±°ë˜ì²˜</h6></div>
                    <div id="vendor_list_ui" class="list-group list-group-flush"></div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyB_mC39GwfguxtYMm4P4jbszB8d10UhvL9AWZYRGXQxhApSkYP4x-yLiCzmoxhSNDY/exec";
        let currentUser = "";
        let inPendingList = [];
        let globalVendorList = [];
        let globalModelList = [];
        let globalAddonList = []; 
        let currentOpenType = "";
        let logoutTimer;
        let tempOpenStockData = null;

        // ìœ ì„ /ì¤‘ê³ ìš© ì „ì—­ ë³€ìˆ˜
        let wiredActList = [];
        let wiredContList = [];

        window.onload = function() {
            const saved = sessionStorage.getItem('dbphone_user');
            if(saved) {
                const u = JSON.parse(saved);
                currentUser = u.name;
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('main-view').style.display = 'block';
                document.getElementById('user-name').innerText = currentUser;
                loadInitData();
                setupAutoLogout();
                loadDashboard(); // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
            }
            document.querySelectorAll('.enter-trigger').forEach(input => {
                input.addEventListener('keydown', function(e) { if(e.key === 'Enter') addVendor(); });
            });
        };

        function setupAutoLogout() {
            resetLogoutTimer();
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => document.addEventListener(evt, resetLogoutTimer));
        }
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            if(currentUser) {
                logoutTimer = setTimeout(() => { alert("10ë¶„ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìë™ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤."); logout(); }, 600000);
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active-section', 'fade-in'));
            document.getElementById(id).classList.add('active-section', 'fade-in');
            if(id === 'section-in') loadInitData();
            if(id === 'section-vendor') loadVendorsToList();
            if(id === 'section-stock') updateSearchUI();
            const input = document.querySelector(`#${id} input`);
            if(input) input.focus();
        }

        function showOpenSection(type) {
            currentOpenType = type;
            document.getElementById('open_title').innerText = type + " ì²˜ë¦¬";
            resetOpenForm();
            loadDropdownData(); 
            showSection('section-open');
        }

        function showWiredSection() {
            resetWiredForm();
            loadDropdownData(); 
            showSection('section-wired');
        }

        function showUsedSection() {
            resetUsedForm();
            loadDropdownData(); 
            showSection('section-used');
        }

        // --- ëŒ€ì‹œë³´ë“œ ---
        function loadDashboard() {
            const dashList = document.getElementById('dash_today_list');
            const dashUser = document.getElementById('dash_user_rank');
            if(!dashList || !dashUser) return;

            dashList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm text-primary"></div> ë¡œë”© ì¤‘...</td></tr>';
            dashUser.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm text-success"></div></div>';

            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_dashboard_data" }) }) // GASì— ì´ ì•¡ì…˜ ì²˜ë¦¬ ì¶”ê°€ í•„ìš” (ê¸°ì¡´ ì½”ë“œì— ìˆë‹¤ë©´ OK)
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') {
                    renderDashboard(d.data);
                } else {
                    dashList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">ë¡œë“œ ì‹¤íŒ¨</td></tr>';
                }
            })
            .catch(() => {
                 // ë°ëª¨ ë°ì´í„° or ì—ëŸ¬ ì²˜ë¦¬
                 dashList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ë°ì´í„° ì—†ìŒ</td></tr>';
                 dashUser.innerHTML = '<div class="text-center text-muted">ë°ì´í„° ì—†ìŒ</div>';
            });
        }

        function renderDashboard(data) {
            // ì˜¤ëŠ˜ ê°œí†µ
            document.getElementById('dash_today_mobile').innerText = data.today.mobile;
            document.getElementById('dash_today_wired').innerText = data.today.wired;

            // ì´ë²ˆ ë‹¬ ëˆ„ì  (ë§¤ì¥ë³„)
            const monthDiv = document.getElementById('dash_month_stats');
            monthDiv.innerHTML = "";
            let branches = Object.keys(data.month);
            if(branches.length === 0) {
                monthDiv.innerHTML = "<div class='text-muted small'>ë°ì´í„° ì—†ìŒ</div>";
            } else {
                branches.forEach(b => {
                    const m = data.month[b].mobile;
                    const w = data.month[b].wired;
                    monthDiv.innerHTML += `
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                            <span class="fw-bold small">${b}</span>
                            <div class="text-end">
                                <span class="badge bg-primary me-1">ğŸ“± ${m}</span>
                                <span class="badge bg-success">ğŸ“º ${w}</span>
                            </div>
                        </div>
                    `;
                });
            }

            // ì˜¤ëŠ˜ ë¦¬ìŠ¤íŠ¸
            const listBody = document.getElementById('dash_today_list');
            listBody.innerHTML = "";
            if (data.todayList.length === 0) {
                listBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ì˜¤ëŠ˜ ê°œí†µ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                data.todayList.forEach(item => {
                    // ë§ˆì§„ ì½¤ë§ˆ í¬ë§·
                    const marginStr = Math.round(Number(item.margin)).toLocaleString();
                    const badgeClass = item.isWired ? "bg-success" : "bg-primary";
                    
                    listBody.innerHTML += `
                        <tr>
                            <td><span class="badge bg-secondary">${item.branch}</span></td>
                            <td><span class="badge ${badgeClass} text-white">${item.type}</span></td>
                            <td class="fw-bold text-truncate-box" style="max-width: 80px;">${item.name}</td>
                            <td><small class="text-muted text-truncate-box" style="max-width: 50px;">${item.user}</small></td>
                            <td class="text-end text-danger fw-bold">${marginStr}</td>
                        </tr>
                    `;
                });
            }

            // ì§ì›ë³„ ë­í‚¹
            const rankBody = document.getElementById('dash_user_rank');
            rankBody.innerHTML = "";
            if (data.userRank.length === 0) {
                rankBody.innerHTML = '<div class="text-center text-muted">ì´ë‹¬ì˜ ì‹¤ì ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                const max = data.userRank[0].count;
                data.userRank.forEach(u => {
                    const percent = (u.count / max) * 100;
                    rankBody.innerHTML += `
                        <div class="user-rank-item">
                            <span class="user-rank-name">${u.name}</span>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: ${percent}%"></div>
                            </div>
                            <span class="user-rank-count">${u.count}ê±´</span>
                        </div>
                    `;
                });
            }
        }

        function loadInitData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => {
                globalVendorList = d.list.map(v => v.name);
                const sel = document.getElementById('in_supplier'); sel.innerHTML = "";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                if(document.getElementById('search_criteria').value === 'supplier') updateSearchUI();
            });
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_models" }) }).then(r => r.json()).then(d => globalModelList = d.list);
        }

        function loadDropdownData() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_dropdown_data" }) })
            .then(r => r.json())
            .then(d => {
                if(d.status !== 'success') return;
                
                const fill = (id, list) => {
                    const sel = document.getElementById(id);
                    if(sel) {
                        sel.innerHTML = '<option value="" selected>ì„ íƒ</option>';
                        list.forEach(item => { sel.innerHTML += `<option value="${item}">${item}</option>`; });
                    }
                };
                
                fill('f_act_type', d.actListMobile);
                fill('f_cont_type', d.contListMobile);
                fill('f_review', d.reviewList);
                fill('f_usim', d.usimList);
                
                fill('w_pre_act_type', d.actListWired); 
                fill('w_pre_cont_type', d.contListWired); 
                fill('w_review', d.reviewList);

                fill('u_pre_act_type', d.actListUsed); 
                fill('u_pre_cont_type', d.contListUsed); 
                fill('u_review', d.reviewList);
                fill('u_usim', d.usimList);

                if(d.wiredVendorList) {
                    fill('w_pre_avalue', d.wiredVendorList);
                    fill('u_pre_avalue', d.wiredVendorList);
                }

                const vList = d.visitList || [];
                const vOpts = '<option value="" selected>ì„ íƒ</option>' + vList.map(i=>`<option value="${i}">${i}</option>`).join('') + '<option value="ê¸°íƒ€">ê¸°íƒ€ (ì§ì ‘ì…ë ¥)</option>';
                if(document.getElementById('f_visit')) document.getElementById('f_visit').innerHTML = vOpts;
                if(document.getElementById('w_visit')) document.getElementById('w_visit').innerHTML = vOpts;
                if(document.getElementById('u_visit')) document.getElementById('u_visit').innerHTML = vOpts;

                const pList = d.payMethodList || []; 
                const cList = d.colMethodList || [];
                
                ['f_pay1_m','f_pay2_m', 'w_pay1_m','w_pay2_m', 'u_pay1_m','u_pay2_m'].forEach(id => fill(id, pList));
                ['f_inc4_m','f_inc4_2_m','f_inc5_m', 'w_inc5_m', 'u_inc5_m'].forEach(id => fill(id, cList));

                globalAddonList = d.addonList || [];
            });
        }

        function checkVisitPath() {
            const val = document.getElementById('f_visit').value;
            if(val === 'ê¸°íƒ€') document.getElementById('div_visit_etc').style.display = 'block';
            else document.getElementById('div_visit_etc').style.display = 'none';
        }
        function checkWiredVisitPath() {
            const val = document.getElementById('w_visit').value;
            if(val === 'ê¸°íƒ€') document.getElementById('w_div_visit_etc').style.display = 'block';
            else document.getElementById('w_div_visit_etc').style.display = 'none';
        }
        function checkUsedVisitPath() {
            const val = document.getElementById('u_visit').value;
            if(val === 'ê¸°íƒ€') document.getElementById('u_div_visit_etc').style.display = 'block';
            else document.getElementById('u_div_visit_etc').style.display = 'none';
        }

        function renderAddonCheckboxes(agencyName, containerId = 'div_addon_container') {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = "";
            const filtered = globalAddonList.filter(item => item.vendor === agencyName);
            if(filtered.length === 0) {
                container.innerHTML = `<span class='text-muted small'>[${agencyName}] ë¶€ê°€ì„œë¹„ìŠ¤ ì—†ìŒ</span>`;
                return;
            }
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = "form-check form-check-inline";
                div.innerHTML = `<input class="form-check-input addon-check" type="checkbox" id="${containerId}_${item.name}" value="${item.name}"><label class="form-check-label small" for="${containerId}_${item.name}">${item.name}</label>`;
                container.appendChild(div);
            });
        }

        function refreshAddons() { renderAddonCheckboxes(document.getElementById('f_avalue').value, 'div_addon_container'); }
        function refreshWiredAddons() { renderAddonCheckboxes(document.getElementById('w_avalue').value, 'w_div_addon_container'); }
        function refreshUsedAddons() { renderAddonCheckboxes(document.getElementById('u_avalue').value, 'u_div_addon_container'); }

        function startWiredActivation() {
            const branch = document.getElementById('wired_branch').value;
            const vendor = document.getElementById('w_pre_avalue').value;
            const type = document.getElementById('w_pre_act_type').value;
            const contract = document.getElementById('w_pre_cont_type').value;
            if(!branch || !vendor || !type || !contract) return alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            document.getElementById('wired_step_1').style.display = 'none';
            document.getElementById('wired_step_2').style.display = 'block';
            document.getElementById('w_avalue').value = vendor;
            document.getElementById('w_act_type').value = type;
            document.getElementById('w_cont_type').value = contract;
            document.getElementById('w_target_info').innerText = `${type} : ${contract}`;
            document.getElementById('w_target_branch').innerText = branch;
            renderWiredPlanInputs(contract);
        }

        function renderWiredPlanInputs(contractType) {
            const area = document.getElementById('w_plan_input_area');
            area.innerHTML = "";
            if(contractType === "ì¸í„°ë„·+TV+ê¸°íƒ€ì„œë¹„ìŠ¤") {
                area.innerHTML = `<div class="row g-2"><div class="col-4"><label class="form-label-sm">ì¸í„°ë„·ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div><div class="col-4"><label class="form-label-sm">TVìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="w_plan_tv"></div><div class="col-4"><label class="form-label-sm">ê¸°íƒ€ì„œë¹„ìŠ¤</label><input type="text" class="form-control form-control-sm" id="w_plan_other"></div></div>`;
            } else if(contractType === "ì¸í„°ë„·+TV") {
                area.innerHTML = `<div class="row g-2"><div class="col-6"><label class="form-label-sm">ì¸í„°ë„·ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div><div class="col-6"><label class="form-label-sm">TVìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="w_plan_tv"></div></div>`;
            } else {
                area.innerHTML = `<div class="row g-2"><div class="col-12"><label class="form-label-sm">ì¸í„°ë„·ìš”ê¸ˆì œ</label><input type="text" class="form-control form-control-sm" id="w_plan_net"></div></div>`;
            }
        }

        function resetWiredForm() {
            document.getElementById('wired_branch').selectedIndex = 0;
            document.getElementById('w_pre_avalue').selectedIndex = 0;
            document.getElementById('w_pre_act_type').selectedIndex = 0;
            document.getElementById('w_pre_cont_type').selectedIndex = 0;
            document.getElementById('wired_step_1').style.display = 'block';
            document.getElementById('wired_step_2').style.display = 'none';
            document.querySelectorAll('#wired_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#wired_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('w_div_visit_etc').style.display = 'none';
        }

        function submitWiredContract(event) {
            if (!validateField('w_visit', 'ë°©ë¬¸ê²½ë¡œ')) return;
            if (!validateField('w_name', 'ê³ ê°ëª…')) return;
            if (!validateField('w_review', 'ë¦¬ë·°ì‘ì„±ì—¬ë¶€')) return;
            let visitVal = document.getElementById('w_visit').value;
            if(visitVal === 'ê¸°íƒ€') {
                if(!validateField('w_visit_etc', 'ìƒì„¸ ë°©ë¬¸ê²½ë¡œ')) return;
                visitVal = "ê¸°íƒ€: " + document.getElementById('w_visit_etc').value;
            }
            const net = document.getElementById('w_plan_net');
            const tv = document.getElementById('w_plan_tv');
            const other = document.getElementById('w_plan_other');
            const parts = [];
            if(net && net.value) parts.push(net.value);
            if(tv && tv.value) parts.push(tv.value);
            if(other && other.value) parts.push(other.value);
            const pricePlan = parts.join(" / ");
            const formData = {
                action: "open_wired_full",
                user: currentUser,
                branch: document.getElementById('wired_branch').value, 
                activationType: document.getElementById('w_act_type').value,
                contractType: document.getElementById('w_cont_type').value,
                name: document.getElementById('w_name').value,
                birth: document.getElementById('w_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('w_phone').value,
                pricePlan: pricePlan, 
                card: document.getElementById('w_card').value,
                review: document.getElementById('w_review').value,
                aValue: document.getElementById('w_avalue').value,
                policy: document.getElementById('w_policy').value,
                income1: document.getElementById('w_inc1').value,
                income1Memo: document.getElementById('w_inc1_m').value,
                income2: document.getElementById('w_inc2').value,
                income2Memo: document.getElementById('w_inc2_m').value,
                income3: document.getElementById('w_inc3').value,
                income3Memo: document.getElementById('w_inc3_m').value,
                cost1: document.getElementById('w_cost1').value,
                cost1Memo: document.getElementById('w_cost1_m').value,
                cost2: document.getElementById('w_cost2').value,
                payment1: document.getElementById('w_pay1').value,
                payment1Method: document.getElementById('w_pay1_m').value,
                payment1Date: document.getElementById('w_pay1_d').value,
                payment2: document.getElementById('w_pay2').value,
                payment2Method: document.getElementById('w_pay2_m').value,
                payment2Date: document.getElementById('w_pay2_d').value,
                cash: document.getElementById('w_cash').value,
                payback1: document.getElementById('w_back').value,
                bankName: document.getElementById('w_bank').value,
                accountNumber: document.getElementById('w_acc').value,
                depositor: document.getElementById('w_holder').value,
                income5: document.getElementById('w_inc5').value,
                income5Method: document.getElementById('w_inc5_m').value,
                income6: document.getElementById('w_inc6').value,
                income6Memo: document.getElementById('w_inc6_m').value,
                comment: document.getElementById('w_comment').value
            };
            const btn = event.currentTarget; 
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...`;
            btn.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetWiredForm(); } else { alert("ì˜¤ë¥˜: " + d.message); }
            })
            .catch(e => alert("í†µì‹  ì˜¤ë¥˜"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        // --- ì¤‘ê³  ê¸°ëŠ¥ ---
        function startUsedActivation() {
            const branch = document.getElementById('u_branch').value;
            const vendor = document.getElementById('u_pre_avalue').value;
            const type = document.getElementById('u_pre_act_type').value;
            const contract = document.getElementById('u_pre_cont_type').value;
            if(!branch || !vendor || !type || !contract) return alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            document.getElementById('used_step_1').style.display = 'none';
            document.getElementById('used_step_2').style.display = 'block';
            document.getElementById('u_avalue').value = vendor;
            document.getElementById('u_act_type').value = type;
            document.getElementById('u_cont_type').value = contract;
            document.getElementById('u_target_info').innerText = `${type} : ${contract}`;
            document.getElementById('u_target_branch').innerText = branch;
            refreshUsedAddons();
        }

        function resetUsedForm() {
            document.getElementById('u_branch').selectedIndex = 0;
            document.getElementById('u_pre_avalue').selectedIndex = 0;
            document.getElementById('u_pre_act_type').selectedIndex = 0;
            document.getElementById('u_pre_cont_type').selectedIndex = 0;
            document.getElementById('used_step_1').style.display = 'block';
            document.getElementById('used_step_2').style.display = 'none';
            document.querySelectorAll('#used_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#used_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('u_div_visit_etc').style.display = 'none';
            document.getElementById('u_div_addon_container').innerHTML = "";
        }

        function submitUsedContract(event) {
            if (!validateField('u_visit', 'ë°©ë¬¸ê²½ë¡œ')) return;
            if (!validateField('u_name', 'ê³ ê°ëª…')) return;
            if (!validateField('u_review', 'ë¦¬ë·°ì‘ì„±ì—¬ë¶€')) return;
            let visitVal = document.getElementById('u_visit').value;
            if(visitVal === 'ê¸°íƒ€') {
                if(!validateField('u_visit_etc', 'ìƒì„¸ ë°©ë¬¸ê²½ë¡œ')) return;
                visitVal = "ê¸°íƒ€: " + document.getElementById('u_visit_etc').value;
            }
            const selectedAddons = [];
            document.querySelectorAll('#u_div_addon_container .addon-check:checked').forEach(cb => selectedAddons.push(cb.value));

            // â˜… ì¤‘ê³  ë°ì´í„° ì „ì†¡ (ì‚­ì œëœ í•­ëª© ì œì™¸ - cost2 ì œê±°)
            const formData = {
                action: "open_used_full",
                user: currentUser,
                branch: document.getElementById('u_branch').value, 
                activationType: document.getElementById('u_act_type').value,
                contractType: document.getElementById('u_cont_type').value,
                name: document.getElementById('u_name').value,
                birth: document.getElementById('u_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('u_phone').value,
                pricePlan: document.getElementById('u_plan').value,
                changePlan: document.getElementById('u_plan_chg').value,
                selectedAddons: selectedAddons,
                usim: document.getElementById('u_usim').value,
                card: document.getElementById('u_card').value,
                review: document.getElementById('u_review').value,
                aValue: document.getElementById('u_avalue').value,
                policy: document.getElementById('u_policy').value,
                model: document.getElementById('u_model').value,
                serial: document.getElementById('u_serial').value,
                income1: document.getElementById('u_inc1').value,
                income1Memo: document.getElementById('u_inc1_m').value,
                income2: document.getElementById('u_inc2').value,
                income2Memo: document.getElementById('u_inc2_m').value,
                income3: document.getElementById('u_inc3').value,
                income3Memo: document.getElementById('u_inc3_m').value,
                cost1: document.getElementById('u_cost1').value,
                cost1Memo: document.getElementById('u_cost1_m').value,
                cost2: "", // ì œê±°ëœ cost2
                payment1: document.getElementById('u_pay1').value,
                payment1Method: document.getElementById('u_pay1_m').value,
                payment1Date: document.getElementById('u_pay1_d').value,
                payment2: document.getElementById('u_pay2').value,
                payment2Method: document.getElementById('u_pay2_m').value,
                payment2Date: document.getElementById('u_pay2_d').value,
                // ì œê±°ëœ í•­ëª©ë“¤
                cash: "", payback1: "", bankName: "", accountNumber: "", depositor: "", income4_1: "", income4_2: "",
                
                income5: document.getElementById('u_inc5').value,
                income5Method: document.getElementById('u_inc5_m').value,
                income6: document.getElementById('u_inc6').value,
                income6Memo: document.getElementById('u_inc6_m').value,
                comment: document.getElementById('u_comment').value
            };
            const btn = event.currentTarget; 
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...`;
            btn.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetUsedForm(); } else { alert("ì˜¤ë¥˜: " + d.message); }
            })
            .catch(e => alert("í†µì‹  ì˜¤ë¥˜"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }

        function handleOpenScan(e) { 
            if(e.key!=='Enter') return; 
            const v=e.target.value.trim(); 
            e.target.disabled = true;
            document.getElementById('open_spinner').style.display = 'block';
            fetch(GAS_URL,{method:"POST",body:JSON.stringify({ action:"get_stock_info_for_open", input:v })})
            .then(r=>r.json()).then(d=>{
                if(d.status==='success') {
                    tempOpenStockData = d.data; 
                    tempOpenStockData.inputCode = v; 
                    document.getElementById('target_model').innerText = `${d.data.model} (${d.data.color})`; 
                    document.getElementById('target_serial').innerText = d.data.serial;
                    document.getElementById('target_branch').innerText = d.data.branch || "ì§€ì ë¯¸ìƒ"; 
                    document.getElementById('f_avalue').value = d.data.supplier || ""; 
                    refreshAddons(); 
                    document.getElementById('open_step_1').style.display = 'none';
                    document.getElementById('open_step_2').style.display = 'block';
                    document.getElementById('f_name').focus();
                } else {
                    alert(d.message);
                    e.target.disabled=false; e.target.value=""; e.target.focus();
                }
            })
            .catch(err => { alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ"); e.target.disabled=false; })
            .finally(() => { document.getElementById('open_spinner').style.display = 'none'; });
        }
        function validateField(id, name) {
            const el = document.getElementById(id);
            if (!el.value) { alert(name + "ì„(ë¥¼) ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”."); el.focus(); return false; }
            return true;
        }
        function submitFullContract() {
            if(!tempOpenStockData) return;
            if (!validateField('f_visit', 'ë°©ë¬¸ê²½ë¡œ')) return;
            if (!validateField('f_name', 'ê³ ê°ëª…')) return;
            if (!validateField('f_review', 'ë¦¬ë·°ì‘ì„±ì—¬ë¶€')) return;
            let visitVal = document.getElementById('f_visit').value;
            if(visitVal === 'ê¸°íƒ€') {
                if(!validateField('f_visit_etc', 'ìƒì„¸ ë°©ë¬¸ê²½ë¡œ')) return;
                visitVal = "ê¸°íƒ€: " + document.getElementById('f_visit_etc').value;
            }
            const selectedAddons = [];
            document.querySelectorAll('#div_addon_container .addon-check:checked').forEach(cb => selectedAddons.push(cb.value));
            const formData = {
                action: "open_stock_full",
                stockInput: tempOpenStockData.inputCode,
                user: currentUser,
                activationType: document.getElementById('f_act_type').value,
                contractType: document.getElementById('f_cont_type').value,
                name: document.getElementById('f_name').value,
                birth: document.getElementById('f_birth').value,
                visitPath: visitVal,
                phoneNumber: document.getElementById('f_phone').value,
                pricePlan: document.getElementById('f_plan').value,
                changePlan: document.getElementById('f_plan_chg').value,
                selectedAddons: selectedAddons, 
                usim: document.getElementById('f_usim').value,
                card: document.getElementById('f_card').value,
                review: document.getElementById('f_review').value,
                aValue: document.getElementById('f_avalue').value,
                policy: document.getElementById('f_policy').value,
                income1: document.getElementById('f_inc1').value,
                income1Memo: document.getElementById('f_inc1_m').value,
                income2: document.getElementById('f_inc2').value,
                income2Memo: document.getElementById('f_inc2_m').value,
                income3: document.getElementById('f_inc3').value,
                income3Memo: document.getElementById('f_inc3_m').value,
                cost1: document.getElementById('f_cost1').value,
                cost1Memo: document.getElementById('f_cost1_m').value,
                cost2: document.getElementById('f_cost2').value,
                payment1: document.getElementById('f_pay1').value,
                payment1Method: document.getElementById('f_pay1_m').value,
                payment1Date: document.getElementById('f_pay1_d').value,
                payment2: document.getElementById('f_pay2').value,
                payment2Method: document.getElementById('f_pay2_m').value,
                payment2Date: document.getElementById('f_pay2_d').value,
                cash: document.getElementById('f_cash').value,
                payback1: document.getElementById('f_back').value,
                bankName: document.getElementById('f_bank').value,
                accountNumber: document.getElementById('f_acc').value,
                depositor: document.getElementById('f_holder').value,
                income4_1: document.getElementById('f_inc4').value,
                income4_1Method: document.getElementById('f_inc4_m').value,
                income4_2: document.getElementById('f_inc4_2').value,
                income4_2Method: document.getElementById('f_inc4_2_m').value,
                income5: document.getElementById('f_inc5').value,
                income5Method: document.getElementById('f_inc5_m').value,
                income6: document.getElementById('f_inc6').value,
                income6Memo: document.getElementById('f_inc6_m').value,
                comment: document.getElementById('f_comment').value
            };
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ì €ì¥ ì¤‘...`;
            btn.disabled = true;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify(formData) })
            .then(r => r.json())
            .then(d => {
                if(d.status === 'success') { alert(d.message); resetOpenForm(); } else { alert("ì˜¤ë¥˜: " + d.message); }
            })
            .catch(e => alert("í†µì‹  ì˜¤ë¥˜"))
            .finally(() => { btn.innerHTML = originalText; btn.disabled = false; });
        }
        function resetOpenForm() {
            document.getElementById('open_step_1').style.display = 'block';
            document.getElementById('open_step_2').style.display = 'none';
            document.getElementById('open_scan').value = "";
            document.getElementById('open_scan').disabled = false;
            document.getElementById('open_spinner').style.display = 'none';
            document.getElementById('open_scan').focus();
            document.querySelectorAll('#open_step_2 input').forEach(i => i.value = "");
            document.querySelectorAll('#open_step_2 select').forEach(s => s.selectedIndex=0);
            document.getElementById('div_visit_etc').style.display='none';
            document.getElementById('div_addon_container').innerHTML = "<span class='text-muted small'>...</span>";
            tempOpenStockData = null;
        }
        function updateSearchUI() {
            const criteria = document.getElementById('search_criteria').value;
            const area = document.getElementById('search_input_area');
            area.innerHTML = "";
            if(criteria === 'supplier') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalVendorList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'branch') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                ["ì¥ì§€ ë³¸ì ", "ëª…ì¼ ì§ì˜ì "].forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else if(criteria === 'model') {
                const sel = document.createElement('select'); sel.className = "form-select"; sel.id = "search_value";
                globalModelList.forEach(v => { const opt = document.createElement('option'); opt.value=v; opt.innerText=v; sel.appendChild(opt); });
                area.appendChild(sel);
            } else {
                const inp = document.createElement('input'); inp.className = "form-control"; inp.id = "search_value"; inp.placeholder = "ì…ë ¥í•˜ì„¸ìš”";
                inp.onkeydown = function(e){ if(e.key==='Enter') searchStock(); };
                area.appendChild(inp); inp.focus();
            }
        }
        function searchStock() {
            const crit = document.getElementById('search_criteria').value;
            const val = document.getElementById('search_value').value;
            const div = document.getElementById('stock_result');
            div.innerHTML = `<div class="text-center py-4"><span class="spinner-border text-primary"></span></div>`;
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "search_stock", criteria: crit, keyword: val }) })
            .then(r => r.json()).then(d => {
                if(!d.list || d.list.length === 0) { div.innerHTML = `<div class="text-center text-muted py-5">ê²°ê³¼ ì—†ìŒ</div>`; return; }
                let html = `<div class="table-responsive"><table class="table table-hover stock-table"><thead><tr><th>ì…ê³ ì¼</th><th>ëª¨ë¸</th><th>ìƒ‰ìƒ</th><th>ì¼ë ¨ë²ˆí˜¸</th><th>ìƒíƒœ</th><th>ìœ„ì¹˜</th></tr></thead><tbody>`;
                d.list.forEach(item => {
                    let st = item.status === 'ë³´ìœ ' ? 'text-success' : 'text-danger';
                    html += `<tr><td>${item.date}</td><td class="fw-bold">${item.model}</td><td>${item.color}</td><td class="font-monospace">${item.serial}</td><td class="${st} fw-bold">${item.status}</td><td>${item.branch}</td></tr>`;
                });
                html += `</tbody></table></div><div class="text-end small text-muted">ì´ ${d.list.length}ê±´</div>`;
                div.innerHTML = html;
            });
        }
        function searchHistory() { const k=document.getElementById('hist_keyword').value; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"search_history",keyword:k})}).then(r=>r.json()).then(d=>{ let h=""; d.list.forEach(i=>h+=`<div class='glass-card p-2 mb-2'><span class='badge bg-secondary'>${i.type}</span> ${i.model} (${i.time})</div>`); document.getElementById('hist_result').innerHTML=h; }); }
        function handleInScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(inPendingList.some(i=>i.barcode===v)){showMsg('in-msg','error','ì´ë¯¸ ëª©ë¡ì— ìˆìŒ');e.target.value="";return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:document.getElementById('in_mode_toggle').checked?"scan_preview":"register_single",barcode:v,supplier:document.getElementById('in_supplier').value,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){if(document.getElementById('in_mode_toggle').checked){inPendingList.push({...d.data,supplier:document.getElementById('in_supplier').value});renderInList();showMsg('in-msg','success',`ì¶”ê°€: ${d.data.model}`);}else showMsg('in-msg','success',`ì…ê³ : ${d.data.model}`);}else showMsg('in-msg','error',d.message);}).finally(()=>{e.target.value="";e.target.focus();}); }
        function renderInList() { const t=document.getElementById('in_tbody'); t.innerHTML=""; inPendingList.forEach((i,x)=>t.innerHTML+=`<tr><td>${i.model}</td><td>${i.serial}</td><td><button onclick="inPendingList.splice(${x},1);renderInList()">X</button></td></tr>`); document.getElementById('in_count').innerText=inPendingList.length; }
        function clearInList() { inPendingList=[]; renderInList(); }
        function submitInBatch() { if(!inPendingList.length)return; if(!confirm("ì…ê³ ?"))return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"batch_register",items:inPendingList,branch:document.getElementById('in_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>{if(d.status==='success'){alert(d.count+"ëŒ€ ì…ê³ ì™„ë£Œ");clearInList();}else alert(d.message);}); }
        function handleMoveScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"transfer_stock",input:v,toBranch:document.getElementById('move_to_branch').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('move-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function handleOutScan(e) { if(e.key!=='Enter')return; const v=e.target.value.trim(); if(!document.getElementById('out_note').value){alert("ì‚¬ìœ í•„ìˆ˜");return;} fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"return_stock",input:v,note:document.getElementById('out_note').value,user:currentUser})}).then(r=>r.json()).then(d=>showMsg('out-msg',d.status==='success'?'success':'error',d.message)).finally(()=>{e.target.value="";}); }
        function loadVendorsToList() { fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: "get_vendors" }) }).then(r => r.json()).then(d => { const div = document.getElementById('vendor_list_ui'); div.innerHTML = ""; d.list.forEach(v => { div.innerHTML += `<div class="list-group-item p-2">${v.name} <button class="btn btn-sm btn-outline-danger float-end" onclick="deleteVendor('${v.name}')">ì‚­ì œ</button></div>`; }); }); }
        function addVendor() { const n=document.getElementById('v_name').value; if(!n)return; fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"add_vendor",name:n,salesName:document.getElementById('v_sales').value,salesPhone:document.getElementById('v_phone').value,officePhone:document.getElementById('v_office').value})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        function deleteVendor(n) { if(confirm("ì‚­ì œ?")) fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"delete_vendor",name:n})}).then(r=>r.json()).then(d=>{alert(d.message);loadVendorsToList();}); }
        
        function showMsg(id, type, text) { const el=document.getElementById(id); el.style.display='block'; el.className=`alert py-2 text-center small fw-bold rounded-3 alert-${type==='success'?'success':'danger'}`; el.innerText=text; setTimeout(()=>el.style.display='none',2000); }
        function handleCredentialResponse(r) { fetch(GAS_URL,{method:"POST",body:JSON.stringify({action:"login",token:r.credential})}).then(res=>res.json()).then(d=>{ if(d.status==='success') { sessionStorage.setItem('dbphone_user',JSON.stringify({name:d.name,email:d.user})); currentUser=d.name; document.getElementById('login-view').style.display='none'; document.getElementById('main-view').style.display='block'; document.getElementById('user-name').innerText=currentUser; loadInitData(); setupAutoLogout(); } else document.getElementById('login-msg').innerText=d.message; }); }
        function logout() { sessionStorage.removeItem('dbphone_user'); location.reload(); }
    </script>
</body>
</html>
